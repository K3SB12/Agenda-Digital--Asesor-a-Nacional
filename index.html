<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† TUTOR IDONEIDAD MEP ¬∑ Asesores</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background: #f0f9ff; font-family: system-ui, sans-serif; }
        .card { background: white; border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .competencia-badge { background: #e0f2fe; color: #0369a1; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .indicador-item { background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; margin: 0 4px 4px 0; display: inline-block; }
        .pregunta-card { background: white; border-radius: 20px; padding: 20px; border-left: 4px solid #2563eb; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .feedback-correcto { background: #dcfce7; border-left: 4px solid #22c55e; padding: 12px; border-radius: 12px; }
        .feedback-incorrecto { background: #fee2e2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 12px; }
        .progreso-bar { height: 8px; border-radius: 4px; background: #e2e8f0; overflow: hidden; }
        .progreso-fill { height: 100%; background: #2563eb; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto space-y-6">

        <!-- CABECERA: Fundamento MEP -->
        <div class="card bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">üìò Idoneidad MEP</h1>
                    <p class="text-blue-100">Tutor inteligente para asesores ¬∑ Transitorio IX</p>
                    <div class="flex flex-wrap gap-2 mt-3 text-xs bg-white/20 p-3 rounded-xl">
                        <span class="font-semibold">Fundamento:</span> LMEP N.¬∫ 10159 (arts.5l,15d-e) ¬∑ Ley N.¬∫9871 ¬∑ Resoluci√≥n DG-RES-88-2023 ¬∑ RPCID art.17d ¬∑ Calificaci√≥n m√≠nima 70
                    </div>
                </div>
                <a href="https://dgth.mep.go.cr/pruebas-de-idoneidad-transitorio-ix/" target="_blank" class="bg-white text-blue-700 px-4 py-2 rounded-full text-sm font-bold hover:bg-blue-50 transition flex items-center gap-2">
                    <i class="fa-regular fa-file-lines"></i> Tablas DGTH
                </a>
            </div>
        </div>

        <!-- SELECTOR DE ESTRATO (Perfiles T√≠tulo II) -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">üéØ Seleccione su estrato (T√≠tulo II)</h2>
            <div class="flex flex-wrap gap-3" id="selector-estrato">
                <button data-estrato="docente" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100 transition font-medium">Propiamente Docente</button>
                <button data-estrato="tecnico" class="estrato-btn px-5 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition font-medium" id="btn-tecnico">T√©cnico Docente (Asesores)</button>
                <button data-estrato="administrativo" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100 transition font-medium">Administrativo Docente</button>
            </div>
        </div>

        <!-- CONTENEDOR PRINCIPAL: 2 COLUMNAS -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUMNA IZQUIERDA: COMPETENCIAS + PROGRESO -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Competencias del Estrato (con indicadores MEP) -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-list"></i> Competencias a evaluar</h2>
                    <div id="competencias-container" class="space-y-4 text-sm">
                        <!-- Se inyecta por JS -->
                    </div>
                </div>
                <!-- Progreso Personal -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-chart-line"></i> Mi progreso</h2>
                    <div class="space-y-3">
                        <div><span class="font-medium">Nivel general:</span> <span id="nivel-general">0%</span></div>
                        <div class="progreso-bar"><div class="progreso-fill" id="barra-progreso" style="width:0%"></div></div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="bg-slate-50 p-2 rounded"><span class="font-medium">Correctas:</span> <span id="total-correctas">0</span></div>
                            <div class="bg-slate-50 p-2 rounded"><span class="font-medium">Totales:</span> <span id="total-preguntas">0</span></div>
                        </div>
                        <div id="recomendacion-refuerzo" class="text-sm p-3 bg-yellow-50 rounded-lg text-yellow-800">
                            üí° Responda preguntas para ver recomendaciones.
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: DOCUMENTOS + SIMULADOR -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Carga de Documentos (solo .txt) -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-folder-open"></i> 1. Cargue sus documentos (.txt)</h2>
                    <p class="text-sm text-amber-600 mb-3">‚ö†Ô∏è Use archivos .txt (Bloc de notas) para evitar errores. Incluya leyes, gu√≠as, PNFT, etc.</p>
                    <input type="file" id="carpeta-docs" webkitdirectory directory multiple accept=".txt" class="mb-3">
                    <div id="lista-docs" class="text-sm max-h-32 overflow-y-auto bg-slate-50 p-3 rounded-lg hidden"></div>
                </div>

                <!-- Generador por Competencia -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-pen-to-square"></i> 2. Practique por competencia</h2>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="selector-competencia" class="border rounded-lg px-3 py-2 text-sm flex-grow">
                            <option value="">Cualquier competencia (autom√°tico)</option>
                        </select>
                        <button id="btn-generar" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 font-medium flex items-center gap-2">
                            <i class="fa-regular fa-flask"></i> Generar pregunta
                        </button>
                    </div>
                    <div id="simulador-container" class="space-y-4">
                        <!-- Las preguntas aparecen aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // --------------------------------------------------------------
            // 1. PERFILES MEP (COMPLETOS con indicadores)
            // --------------------------------------------------------------
            const perfilesMEP = {
                tecnico: {
                    nombre: 'T√©cnico Docente (Asesores)',
                    competencias: [
                        { codigo: '1.1', nombre: '√Årea disciplinar, pedag√≥gica y curricular', saber: true,
                          indicadores: ['Domina su disciplina', 'Asesora sobre actualizaciones curriculares', 'Fundamenta con teor√≠as pedag√≥gicas'] },
                        { codigo: '1.2', nombre: 'Marco jur√≠dico, √©tico y pol√≠ticas p√∫blicas', saber: true,
                          indicadores: ['Aplica Pol√≠tica Educativa', 'Respeta principios √©ticos', 'Interpreta normativa vinculante (Leyes 10159, 8292, etc.)'] },
                        { codigo: '1.3', nombre: 'Estructura organizacional del MEP', saber: true,
                          indicadores: ['Coordina entre niveles central, regional e institucional', 'Deriva consultas al nivel correspondiente'] },
                        { codigo: '2.1', nombre: 'Dise√±o de planes, programas y proyectos', saber: false,
                          indicadores: ['Elabora proyectos de mejora', 'Dise√±a estrategias de intervenci√≥n pedag√≥gica'] },
                        { codigo: '2.3', nombre: 'Liderazgo, asesor√≠a y TIC', saber: false,
                          indicadores: ['Utiliza plataformas digitales', 'Promueve innovaci√≥n educativa con TIC'] }
                    ]
                },
                docente: {
                    nombre: 'Propiamente Docente',
                    competencias: [
                        { codigo: '1.1', nombre: 'Conocimiento de estudiantes y contexto', saber: true, indicadores: ['Identifica etapas del desarrollo', 'Reconoce factores socioculturales'] },
                        { codigo: '1.2', nombre: 'Dominio disciplinar y did√°ctico', saber: true, indicadores: ['Selecciona estrategias did√°cticas', 'Aplica teor√≠as pedag√≥gicas'] },
                        { codigo: '1.3', nombre: 'Pol√≠ticas y normativa educativa', saber: true, indicadores: ['Cita C√≥digo de Ni√±ez', 'Aplica lineamientos de evaluaci√≥n'] },
                        { codigo: '2.1', nombre: 'Dise√±o de experiencias de aprendizaje', saber: false, indicadores: ['Adecua objetivos', 'Selecciona recursos'] },
                        { codigo: '2.2', nombre: 'Mediaci√≥n pedag√≥gica', saber: false, indicadores: ['Aplica aprendizaje cooperativo', 'Integra TIC'] },
                        { codigo: '2.3', nombre: 'Evaluaci√≥n de aprendizajes', saber: false, indicadores: ['Construye r√∫bricas', 'Analiza resultados'] }
                    ]
                },
                administrativo: {
                    nombre: 'Administrativo Docente',
                    competencias: [
                        { codigo: '1.1', nombre: 'Liderazgo pedag√≥gico y gesti√≥n', saber: true, indicadores: ['Identifica modelos de supervisi√≥n', 'Reconoce estilos de direcci√≥n'] },
                        { codigo: '1.4', nombre: 'Tecnolog√≠as en educaci√≥n', saber: true, indicadores: ['Usa sistemas institucionales', 'Conoce pol√≠ticas de seguridad'] },
                        { codigo: '2.3', nombre: 'Gesti√≥n de recursos', saber: false, indicadores: ['Elabora presupuestos', 'Aplica Ley de Contrataci√≥n'] },
                        { codigo: '2.4', nombre: 'Gesti√≥n segura de informaci√≥n', saber: false, indicadores: ['Aplica protocolos de datos', 'Resguarda documentaci√≥n'] },
                        { codigo: '2.5', nombre: 'Liderazgo y responsabilidad', saber: false, indicadores: ['Conduce reuniones', 'Resuelve conflictos'] }
                    ]
                }
            };

            // --------------------------------------------------------------
            // 2. ESTADO DE LA APLICACI√ìN
            // --------------------------------------------------------------
            let estratoActual = 'tecnico';
            let documentos = [];  // { nombre, contenido, analisis }
            let progreso = JSON.parse(localStorage.getItem('progresoMEP')) || { total:0, correctas:0, porCompetencia:{} };
            let preguntasHechas = [];

            // --------------------------------------------------------------
            // 3. FUNCIONES DE INTERFAZ
            // --------------------------------------------------------------
            function renderizarCompetencias() {
                const perfil = perfilesMEP[estratoActual];
                let html = '';
                perfil.competencias.forEach(comp => {
                    const nivel = progreso.porCompetencia[comp.codigo]?.nivel || 0;
                    html += `
                        <div class="border-l-4 border-blue-500 pl-3 py-2 bg-slate-50 rounded">
                            <div class="flex justify-between items-center">
                                <span class="competencia-badge">${comp.codigo} ${comp.saber ? 'üìò SABER' : 'üõ†Ô∏è HACER'}</span>
                                <span class="text-xs font-mono">Nivel: ${nivel}%</span>
                            </div>
                            <p class="font-medium mt-1">${comp.nombre}</p>
                            <div class="mt-2">${comp.indicadores.map(i => `<span class="indicador-item">‚úì ${i}</span>`).join('')}</div>
                        </div>
                    `;
                });
                document.getElementById('competencias-container').innerHTML = html;
                actualizarSelectorCompetencias();
            }

            function actualizarSelectorCompetencias() {
                const select = document.getElementById('selector-competencia');
                const perfil = perfilesMEP[estratoActual];
                select.innerHTML = '<option value="">Cualquier competencia (autom√°tico)</option>';
                perfil.competencias.forEach(comp => {
                    select.innerHTML += `<option value="${comp.codigo}">${comp.codigo} - ${comp.nombre}</option>`;
                });
            }

            function actualizarProgresoUI() {
                const total = progreso.total || 0;
                const correctas = progreso.correctas || 0;
                const nivel = total > 0 ? Math.round((correctas/total)*100) : 0;
                document.getElementById('nivel-general').textContent = nivel + '%';
                document.getElementById('barra-progreso').style.width = nivel + '%';
                document.getElementById('total-correctas').textContent = correctas;
                document.getElementById('total-preguntas').textContent = total;

                // Recomendaci√≥n de refuerzo (competencias con nivel < 60)
                const perfil = perfilesMEP[estratoActual];
                const aReforzar = perfil.competencias.filter(c => (progreso.porCompetencia[c.codigo]?.nivel || 0) < 60).map(c => c.codigo);
                if (aReforzar.length > 0) {
                    document.getElementById('recomendacion-refuerzo').innerHTML = `üìö Reforzar: competencias ${aReforzar.join(', ')}`;
                } else {
                    document.getElementById('recomendacion-refuerzo').innerHTML = '‚úÖ Buen nivel en todas las competencias.';
                }
            }

            // --------------------------------------------------------------
            // 4. AN√ÅLISIS AUTOM√ÅTICO DE DOCUMENTOS (RELACI√ìN CON COMPETENCIAS)
            // --------------------------------------------------------------
            const palabrasClavePorCompetencia = {
                '1.1': ['curr√≠culum', 'did√°ctica', 'metodolog√≠a', 'pedagog√≠a', 'STEAM', 'PNFT', 'gu√≠a docente', 'm√≥dulo', 'ense√±anza', 'aprendizaje'],
                '1.2': ['ley', 'art√≠culo', 'reglamento', 'normativa', 'pol√≠tica', '√©tica', 'c√≥digo', 'estatuto', 'convenci√≥n', '10159', '8292', '6227', '1581', '7494'],
                '1.3': ['circular', 'lineamiento', 'organizaci√≥n', 'estructura', 'nivel central', 'regional', 'institucional', 'directriz'],
                '2.1': ['plan', 'programa', 'proyecto', 'dise√±o', 'estrategia', 'PPPJ', 'marco estrat√©gico'],
                '2.3': ['tecnolog√≠a', 'TIC', 'digital', 'innovaci√≥n', 'MITDE', 'gobernanza', 'transformaci√≥n digital', 'inteligencia artificial']
            };

            function analizarDocumento(nombre, contenido) {
                const textoCompleto = (nombre + ' ' + contenido).toLowerCase();
                const competenciasRelacionadas = [];
                for (let [codigo, keywords] of Object.entries(palabrasClavePorCompetencia)) {
                    let peso = 0;
                    keywords.forEach(kw => { if (textoCompleto.includes(kw)) peso++; });
                    if (peso > 0) competenciasRelacionadas.push(codigo);
                }
                return competenciasRelacionadas;
            }

            // --------------------------------------------------------------
            // 5. CARGA DE DOCUMENTOS
            // --------------------------------------------------------------
            document.getElementById('carpeta-docs').addEventListener('change', async function(e) {
                const archivos = Array.from(e.target.files).filter(f => f.name.endsWith('.txt'));
                documentos = [];
                const listaDiv = document.getElementById('lista-docs');
                listaDiv.innerHTML = '';
                
                for (let archivo of archivos) {
                    const texto = await archivo.text();
                    const contenidoLimpio = texto.replace(/[^\w\s√°√©√≠√≥√∫√±√º.,;:()\-"'\n\r]/g, ' ').replace(/\s+/g, ' ').toLowerCase();
                    const analisis = analizarDocumento(archivo.name, contenidoLimpio);
                    documentos.push({
                        nombre: archivo.name,
                        contenido: contenidoLimpio,
                        competencias: analisis
                    });
                    listaDiv.innerHTML += `<div class="py-1 border-b text-xs">üìÑ ${archivo.name} ‚Üí <span class="font-mono">[${analisis.join(', ') || 'sin clasificar'}]</span></div>`;
                }
                listaDiv.classList.remove('hidden');
            });

            // --------------------------------------------------------------
            // 6. GENERADOR DE PREGUNTAS POR COMPETENCIA
            // --------------------------------------------------------------
            function generarPregunta(competenciaElegida = null) {
                if (documentos.length === 0) { alert('Cargue documentos primero'); return; }

                // 1. Determinar competencia objetivo
                let competenciaObj = null;
                if (competenciaElegida) {
                    competenciaObj = perfilesMEP[estratoActual].competencias.find(c => c.codigo === competenciaElegida);
                } else {
                    // Elegir autom√°tica (con sesgo hacia las de menor nivel)
                    const comps = perfilesMEP[estratoActual].competencias;
                    const niveles = comps.map(c => progreso.porCompetencia[c.codigo]?.nivel || 0);
                    const minNivel = Math.min(...niveles);
                    const candidatas = comps.filter((_, i) => niveles[i] === minNivel);
                    competenciaObj = candidatas[Math.floor(Math.random() * candidatas.length)];
                }
                if (!competenciaObj) return;

                // 2. Buscar documentos relacionados con esa competencia
                let docsRel = documentos.filter(d => d.competencias.includes(competenciaObj.codigo));
                if (docsRel.length === 0) docsRel = documentos; // fallback

                const doc = docsRel[Math.floor(Math.random() * docsRel.length)];

                // 3. Extraer un fragmento
                const oraciones = doc.contenido.split('.').filter(o => o.trim().length > 40);
                if (oraciones.length === 0) return generarPregunta(competenciaElegida);
                const fragmento = oraciones[Math.floor(Math.random() * oraciones.length)].trim();

                // 4. Crear opciones seg√∫n la competencia
                let opciones, explicacion;
                if (competenciaObj.codigo === '1.2') {
                    opciones = ['Aplicar la normativa vigente (Leyes 10159, 8292, etc.)', 'Actuar seg√∫n criterio personal', 'Consultar solo con colegas', 'Esperar directrices sin actuar'];
                    explicacion = 'El marco jur√≠dico establece obligaciones claras. Fundamente su respuesta en las leyes.';
                } else if (competenciaObj.codigo === '2.3') {
                    opciones = ['Usar el Modelo de Gobernanza TIC y la Gu√≠a MITDE', 'Implementar tecnolog√≠a sin plan', 'Evitar herramientas digitales', 'Asesorar sin considerar transformaci√≥n digital'];
                    explicacion = 'La asesor√≠a con TIC debe basarse en las pol√≠ticas de transformaci√≥n digital.';
                } else {
                    opciones = ['Opci√≥n A (correcta, basada en el documento)', 'Opci√≥n B (incorrecta)', 'Opci√≥n C (incorrecta)', 'Opci√≥n D (incorrecta)'];
                    explicacion = 'La respuesta correcta se fundamenta en el documento analizado.';
                }

                return {
                    competencia: competenciaObj.codigo,
                    pregunta: `[Competencia ${competenciaObj.codigo}] Seg√∫n "${doc.nombre}":\n"${fragmento.substring(0,200)}..."\n¬øCu√°l es la actuaci√≥n correcta?`,
                    opciones: opciones,
                    correcta: 0,
                    explicacion: explicacion,
                    documento: doc.nombre
                };
            }

            // --------------------------------------------------------------
            // 7. AGREGAR PREGUNTA AL SIMULADOR
            // --------------------------------------------------------------
            function agregarPregunta(p) {
                const id = Date.now();
                const container = document.getElementById('simulador-container');
                const html = `
                    <div class="pregunta-card" data-id="${id}" data-competencia="${p.competencia}">
                        <p class="font-medium mb-3">${p.pregunta}</p>
                        <div class="space-y-2 mb-3">${p.opciones.map((opt, idx) => `
                            <div class="flex items-center gap-2"><input type="radio" name="p_${id}" value="${idx}"><span>${opt}</span></div>
                        `).join('')}</div>
                        <div class="feedback hidden text-sm p-3 rounded-lg"></div>
                        <p class="text-xs text-gray-400 mt-2">üìÑ ${p.documento}</p>
                    </div>
                `;
                container.innerHTML = html + container.innerHTML;

                // Evento de respuesta
                document.querySelectorAll(`[name="p_${id}"]`).forEach(r => r.addEventListener('change', function(e) {
                    const card = this.closest('.pregunta-card');
                    const feedback = card.querySelector('.feedback');
                    const correcta = p.correcta;
                    const esCorrecta = parseInt(this.value) === correcta;
                    const competencia = card.dataset.competencia;

                    progreso.total++;
                    if (esCorrecta) progreso.correctas++;
                    if (!progreso.porCompetencia[competencia]) progreso.porCompetencia[competencia] = { total:0, correctas:0 };
                    progreso.porCompetencia[competencia].total++;
                    if (esCorrecta) progreso.porCompetencia[competencia].correctas++;
                    progreso.porCompetencia[competencia].nivel = Math.round((progreso.porCompetencia[competencia].correctas / progreso.porCompetencia[competencia].total) * 100);

                    feedback.className = esCorrecta ? 'feedback-correcto text-sm block' : 'feedback-incorrecto text-sm block';
                    feedback.innerHTML = esCorrecta ? `‚úÖ Correcto! ${p.explicacion}` : `‚ùå Incorrecto. Respuesta correcta: ${p.opciones[correcta]}. ${p.explicacion}`;
                    
                    localStorage.setItem('progresoMEP', JSON.stringify(progreso));
                    renderizarCompetencias();
                    actualizarProgresoUI();
                    card.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
                }));
            }

            // --------------------------------------------------------------
            // 8. EVENTOS
            // --------------------------------------------------------------
            document.getElementById('selector-estrato').addEventListener('click', (e) => {
                const btn = e.target.closest('.estrato-btn');
                if (!btn) return;
                estratoActual = btn.dataset.estrato;
                document.querySelectorAll('.estrato-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
                btn.classList.add('bg-blue-600', 'text-white');
                renderizarCompetencias();
            });

            document.getElementById('btn-generar').addEventListener('click', () => {
                const select = document.getElementById('selector-competencia');
                const competenciaElegida = select.value || null;
                const pregunta = generarPregunta(competenciaElegida);
                if (pregunta) agregarPregunta(pregunta);
            });

            // Inicializar
            renderizarCompetencias();
            actualizarProgresoUI();
        })();
    </script>
</body>
</html>
