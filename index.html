<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Idoneidad MEP ¬∑ Con tus documentos</title>
    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background: #f0f9ff; }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 16px; }
        .card { background: white; border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn-primary { background: #2563eb; color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; }
        .btn-primary:hover { background: #1d4ed8; }
        .documento-item { padding: 8px; border-bottom: 1px solid #e5e7eb; cursor: pointer; }
        .documento-item:hover { background: #f3f4f6; }
        .pregunta-card { border-left: 4px solid #2563eb; padding: 16px; margin: 16px 0; background: #f8fafc; border-radius: 12px; }
        .correcto { background: #dcfce7; border-left-color: #22c55e; }
        .incorrecto { background: #fee2e2; border-left-color: #ef4444; }
        @media (max-width: 768px) { .grid-cols-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="app-container">
        
        <!-- CABECERA -->
        <div class="card mb-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                    üìö <span class="text-blue-600">Idoneidad</span> MEP
                </h1>
                <p class="text-gray-600">Tutor con tus documentos ¬∑ Transitorio IX</p>
            </div>
            <div>
                <span id="estado-offline" class="hidden bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">
                    <i class="fa-regular fa-wifi-slash"></i> Modo offline
                </span>
            </div>
        </div>

        <!-- SELECCI√ìN DE CARPETA (SOLO EN COMPU) -->
        <div class="card mb-4">
            <h2 class="text-lg font-semibold mb-3">üìÅ Tus documentos</h2>
            <p class="text-sm text-gray-600 mb-3">Seleccion√° la carpeta "knowledge" con tus 30+ documentos</p>
            <input type="file" id="folderInput" webkitdirectory directory multiple class="mb-3">
            <div id="documentos-lista" class="max-h-40 overflow-y-auto border rounded-lg p-2 hidden">
                <p class="font-medium mb-2">Documentos cargados:</p>
                <ul id="lista-archivos" class="text-sm"></ul>
            </div>
        </div>

        <!-- SELECTOR DE ESTRATO -->
        <div class="card mb-4">
            <h2 class="text-lg font-semibold mb-3">üéØ Tu perfil</h2>
            <div class="flex flex-wrap gap-2">
                <button data-estrato="docente" class="estrato-btn px-4 py-2 rounded-full bg-gray-200 hover:bg-blue-100 transition">Propiamente Docente</button>
                <button data-estrato="tecnico" class="estrato-btn px-4 py-2 rounded-full bg-gray-200 hover:bg-blue-100 transition">T√©cnico Docente</button>
                <button data-estrato="administrativo" class="estrato-btn px-4 py-2 rounded-full bg-gray-200 hover:bg-blue-100 transition">Administrativo Docente</button>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL (2 COLUMNAS) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <!-- COLUMNA IZQUIERDA: COMPETENCIAS -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üìã Competencias a evaluar</h2>
                <div id="competencias-container" class="space-y-3">
                    <!-- Se llena con JS -->
                </div>
            </div>

            <!-- COLUMNA DERECHA: CHAT Y PREGUNTAS -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">üí¨ Tutor + Simulador</h2>
                
                <!-- Buscador en documentos -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Consult√° tus documentos:</label>
                    <div class="flex gap-2">
                        <input type="text" id="pregunta-input" placeholder="Ej: ¬øQu√© dice el art√≠culo 8 de Control Interno?" class="flex-1 border rounded-lg px-3 py-2">
                        <button id="btn-preguntar" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fa-regular fa-magnifying-glass"></i>
                        </button>
                    </div>
                    <div id="resultado-busqueda" class="mt-2 text-sm p-2 bg-gray-50 rounded-lg hidden"></div>
                </div>

                <!-- Generador de preguntas -->
                <div class="mb-4">
                    <button id="btn-generar" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 font-medium">
                        <i class="fa-regular fa-pen-to-square mr-2"></i> Generar pregunta de pr√°ctica
                    </button>
                </div>

                <!-- Simulador -->
                <div id="simulador-container" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Las preguntas aparecen ac√° -->
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="text-center text-sm text-gray-500 mt-4">
            <p>üì± Pod√©s instalar esta app en tu celular (Compartir ‚Üí Agregar a pantalla de inicio)</p>
        </div>
    </div>

    <script>
        // ============================================
        // BASE DE CONOCIMIENTO DEL MEP (competencias)
        // ============================================
        const perfilesMEP = {
            docente: {
                nombre: 'Propiamente Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Conocimiento de estudiantes y contexto', saber: true },
                    { codigo: '1.2', nombre: 'Dominio disciplinar y did√°ctico', saber: true },
                    { codigo: '1.3', nombre: 'Pol√≠ticas y normativa educativa', saber: true },
                    { codigo: '2.1', nombre: 'Dise√±o de experiencias de aprendizaje', saber: false },
                    { codigo: '2.2', nombre: 'Mediaci√≥n pedag√≥gica', saber: false },
                    { codigo: '2.3', nombre: 'Evaluaci√≥n de aprendizajes', saber: false }
                ]
            },
            tecnico: {
                nombre: 'T√©cnico Docente (Asesores)',
                competencias: [
                    { codigo: '1.1', nombre: '√Årea disciplinar y curricular', saber: true },
                    { codigo: '1.2', nombre: 'Marco jur√≠dico y pol√≠ticas p√∫blicas', saber: true },
                    { codigo: '1.3', nombre: 'Estructura organizacional MEP', saber: true },
                    { codigo: '2.1', nombre: 'Dise√±o de planes y proyectos', saber: false },
                    { codigo: '2.3', nombre: 'Liderazgo y asesor√≠a con TIC', saber: false }
                ]
            },
            administrativo: {
                nombre: 'Administrativo Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Liderazgo pedag√≥gico y gesti√≥n', saber: true },
                    { codigo: '1.4', nombre: 'Tecnolog√≠as en educaci√≥n', saber: true },
                    { codigo: '2.3', nombre: 'Gesti√≥n de recursos materiales/financieros', saber: false },
                    { codigo: '2.4', nombre: 'Gesti√≥n segura de informaci√≥n', saber: false },
                    { codigo: '2.5', nombre: 'Liderazgo y responsabilidad', saber: false }
                ]
            }
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let estratoActual = 'tecnico';
        let documentos = []; // Aqu√≠ guardaremos los textos de los documentos
        let preguntasGeneradas = [];

        // ============================================
        // FUNCIONES PARA LEER CARPETA
        // ============================================
        document.getElementById('folderInput').addEventListener('change', async function(e) {
            const archivos = Array.from(e.target.files);
            documentos = [];
            
            for (let archivo of archivos) {
                if (archivo.type.includes('text') || archivo.name.endsWith('.txt') || archivo.name.endsWith('.pdf')) {
                    try {
                        const texto = await archivo.text();
                        documentos.push({
                            nombre: archivo.name,
                            contenido: texto.toLowerCase(),
                            tamano: archivo.size
                        });
                    } catch (error) {
                        console.log('Error leyendo', archivo.name);
                    }
                }
            }
            
            // Mostrar lista de documentos cargados
            const listaDiv = document.getElementById('lista-archivos');
            listaDiv.innerHTML = '';
            documentos.forEach(doc => {
                listaDiv.innerHTML += `<li class="documento-item" onclick="buscarEnDocumento('${doc.nombre}')">üìÑ ${doc.nombre}</li>`;
            });
            document.getElementById('documentos-lista').classList.remove('hidden');
        });

        // ============================================
        // BUSCAR EN DOCUMENTOS
        // ============================================
        function buscarEnDocumentos(consulta) {
            const resultados = [];
            const terminos = consulta.toLowerCase().split(' ');
            
            documentos.forEach(doc => {
                let relevancia = 0;
                terminos.forEach(term => {
                    if (doc.contenido.includes(term)) relevancia++;
                });
                
                if (relevancia > 0) {
                    // Extraer contexto alrededor de la coincidencia
                    const indice = doc.contenido.indexOf(terminos[0]);
                    const inicio = Math.max(0, indice - 100);
                    const fin = Math.min(doc.contenido.length, indice + 200);
                    const contexto = doc.contenido.substring(inicio, fin) + '...';
                    
                    resultados.push({
                        documento: doc.nombre,
                        relevancia: relevancia,
                        contexto: contexto
                    });
                }
            });
            
            return resultados.sort((a,b) => b.relevancia - a.relevancia);
        }

        // ============================================
        // GENERAR PREGUNTA BASADA EN DOCUMENTOS
        // ============================================
        function generarPregunta() {
            if (documentos.length === 0) {
                alert('Primero carg√° tus documentos');
                return;
            }
            
            // Tomar un documento aleatorio
            const doc = documentos[Math.floor(Math.random() * documentos.length)];
            
            // Extraer una frase aleatoria (simplificado)
            const oraciones = doc.contenido.split('.');
            const oracion = oraciones[Math.floor(Math.random() * oraciones.length)];
            
            if (oracion.length < 20) return generarPregunta(); // Intentar de nuevo
            
            // Crear pregunta
            const pregunta = {
                texto: `Seg√∫n el documento "${doc.nombre}", ¬øqu√© establece la siguiente afirmaci√≥n?\n"${oracion.substring(0, 100)}..."`,
                opciones: [
                    'A) Lo establece como obligaci√≥n del funcionario',
                    'B) Lo establece como facultad discrecional',
                    'C) No est√° regulado en la normativa',
                    'D) Es competencia de otra instancia'
                ],
                correcta: 0, // Simplificado
                fuente: doc.nombre
            };
            
            return pregunta;
        }

        // ============================================
        // RENDERIZAR COMPETENCIAS
        // ============================================
        function renderizarCompetencias() {
            const perfil = perfilesMEP[estratoActual];
            let html = '';
            
            perfil.competencias.forEach(comp => {
                html += `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <span class="text-xs font-mono ${comp.saber ? 'bg-blue-200' : 'bg-green-200'} px-2 py-1 rounded-full">
                            ${comp.saber ? 'SABER' : 'SABER HACER'}
                        </span>
                        <span class="font-medium block mt-1">${comp.codigo} ${comp.nombre}</span>
                    </div>
                `;
            });
            
            document.getElementById('competencias-container').innerHTML = html;
        }

        // ============================================
        // EVENTOS
        // ============================================
        
        // Selector de estrato
        document.querySelectorAll('.estrato-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                estratoActual = this.dataset.estrato;
                renderizarCompetencias();
            });
        });

        // Bot√≥n preguntar
        document.getElementById('btn-preguntar').addEventListener('click', function() {
            const pregunta = document.getElementById('pregunta-input').value;
            if (!pregunta || documentos.length === 0) return;
            
            const resultados = buscarEnDocumentos(pregunta);
            const resultadoDiv = document.getElementById('resultado-busqueda');
            
            if (resultados.length > 0) {
                let html = '<p class="font-bold mb-2">üìÑ Resultados:</p>';
                resultados.slice(0, 3).forEach(r => {
                    html += `
                        <div class="mb-2 p-2 bg-white rounded">
                            <span class="font-medium">${r.documento}</span>
                            <p class="text-xs mt-1">${r.contexto}</p>
                        </div>
                    `;
                });
                resultadoDiv.innerHTML = html;
                resultadoDiv.classList.remove('hidden');
            } else {
                resultadoDiv.innerHTML = '<p class="text-gray-500">No se encontraron resultados</p>';
                resultadoDiv.classList.remove('hidden');
            }
        });

        // Bot√≥n generar pregunta
        document.getElementById('btn-generar').addEventListener('click', function() {
            const pregunta = generarPregunta();
            if (!pregunta) return;
            
            preguntasGeneradas.push(pregunta);
            const idx = preguntasGeneradas.length - 1;
            
            const simulador = document.getElementById('simulador-container');
            const preguntaHTML = `
                <div class="pregunta-card" data-idx="${idx}">
                    <p class="font-medium mb-3">${pregunta.texto}</p>
                    <div class="space-y-2">
                        ${pregunta.opciones.map((opt, optIdx) => `
                            <div class="flex items-center gap-2">
                                <input type="radio" name="preg_${idx}" value="${optIdx}" class="radio-pregunta">
                                <span>${opt}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="feedback hidden mt-3 text-sm p-2 rounded"></div>
                    <p class="text-xs text-gray-400 mt-2">Fuente: ${pregunta.fuente}</p>
                </div>
            `;
            
            simulador.innerHTML = preguntaHTML + simulador.innerHTML;
            
            // Eventos para los radios
            document.querySelectorAll(`[name="preg_${idx}"]`).forEach(radio => {
                radio.addEventListener('change', function(e) {
                    const card = this.closest('.pregunta-card');
                    const feedback = card.querySelector('.feedback');
                    const correcta = preguntasGeneradas[card.dataset.idx].correcta;
                    
                    if (parseInt(this.value) === correcta) {
                        feedback.className = 'feedback correcto mt-3 text-sm p-2 rounded';
                        feedback.innerHTML = '‚úÖ ¬°Correcto! Basado en tus documentos.';
                    } else {
                        feedback.className = 'feedback incorrecto mt-3 text-sm p-2 rounded';
                        feedback.innerHTML = '‚ùå Revis√° el documento mencionado en la fuente.';
                    }
                    
                    feedback.classList.remove('hidden');
                });
            });
        });

        // Inicializar
        renderizarCompetencias();

        // ============================================
        // SERVICE WORKER (para offline y PWA)
        // ============================================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('SW registrado'))
                .catch(err => console.log('Error SW:', err));
        }

        // Detectar si est√° offline
        window.addEventListener('offline', () => {
            document.getElementById('estado-offline').classList.remove('hidden');
        });
        window.addEventListener('online', () => {
            document.getElementById('estado-offline').classList.add('hidden');
        });
    </script>
</body>
</html>
