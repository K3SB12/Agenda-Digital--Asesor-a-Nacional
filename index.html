<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì IDOMEP v2.0 ¬∑ Asesor Nacional (Definitivo)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Mammoth.js para DOCX (sin l√≠mite de tama√±o) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <style>
        body { background: #f0f9ff; font-family: system-ui, sans-serif; }
        .card { background: white; border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .ruta-item { transition: all 0.3s; cursor: pointer; border: 2px solid transparent; }
        .ruta-item.disponible:hover { transform: translateY(-4px); border-color: #3b82f6; }
        .tab-button.active { background: #2563eb; color: white; }
        .tooltip-completo {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 8px;
            padding: 12px;
            background: #1e293b;
            color: white;
            font-size: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5);
            z-index: 100;
            max-width: 90%;
            white-space: normal;
            word-break: break-word;
        }
        .group:hover .tooltip-completo { display: block; }
    </style>
</head>
<body class="min-h-screen p-4">

    <!-- BARRA SUPERIOR -->
    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b shadow-sm mb-4">
        <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
            <span class="font-bold text-xl">üéì IDOMEP <span class="text-blue-600">v2.0</span></span>
            <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                <button data-tab="inicio" class="tab-button px-4 py-1.5 rounded-lg text-sm active">üìö Inicio</button>
                <button data-tab="duolingo" class="tab-button px-4 py-1.5 rounded-lg text-sm">üéÆ IdoMep</button>
                <button data-tab="simulador" class="tab-button px-4 py-1.5 rounded-lg text-sm">üìù Simulacro</button>
                <button data-tab="reporte" class="tab-button px-4 py-1.5 rounded-lg text-sm">üìä Progreso</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- ========== TAB INICIO ========== -->
        <div id="tab-inicio" class="tab-content block">
            <div class="card mb-6 border-l-8 border-blue-600">
                <h2 class="text-2xl font-bold mb-2">üìö Sistema de Estudio MEP</h2>
                <p class="text-gray-600">Cargue sus documentos (PDF, DOCX, TXT). El sistema generar√° casos pr√°cticos.</p>
                <div class="mt-3 text-sm bg-blue-50 p-3 rounded-lg">
                    <span class="font-medium">Fundamento:</span> LMEP N.¬∫ 10159 ¬∑ Ley N.¬∫9871 ¬∑ Resoluci√≥n DG-RES-88-2023 ¬∑ Calificaci√≥n m√≠nima 70
                </div>
            </div>

            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üéØ Seleccione su estrato</h3>
                <div class="flex flex-wrap gap-3" id="selector-estrato">
                    <button data-estrato="docente" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100">Propiamente Docente</button>
                    <button data-estrato="tecnico" class="estrato-btn px-5 py-2 rounded-full bg-blue-600 text-white">T√©cnico Docente (Asesores)</button>
                    <button data-estrato="administrativo" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100">Administrativo Docente</button>
                </div>
            </div>

            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üìÅ Cargue sus documentos</h3>
                <p class="text-sm text-amber-600 mb-3">
                    üìå Formatos: <strong>PDF, DOCX y TXT</strong> (sin l√≠mite de tama√±o). 
                </p>
                <input type="file" id="carga-docs" multiple accept=".pdf,.txt,.docx,.doc" class="mb-4 w-full p-2 border rounded-lg">
                <div id="lista-docs" class="text-sm max-h-40 overflow-y-auto bg-slate-50 p-3 rounded-lg hidden"></div>
                <div id="progreso-carga" class="text-xs text-gray-500 mt-2"></div>
            </div>

            <div class="card">
                <h3 class="font-bold text-lg mb-4">üìã Competencias a evaluar</h3>
                <div id="competencias-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- ========== TAB IDOMEP ========== -->
        <div id="tab-duolingo" class="tab-content hidden">
            <!-- Panel XP/Vidas/Racha -->
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl shadow-xl p-6 mb-6 text-white">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-4xl">üéÆ</span>
                        <div>
                            <h2 class="text-2xl font-black">Ruta de dominio</h2>
                            <p class="text-blue-100">Competencias MEP ¬∑ Basado en sus documentos</p>
                        </div>
                    </div>
                    <div class="flex gap-6">
                        <div class="text-center">
                            <span class="text-sm">NIVEL</span>
                            <div class="text-2xl font-bold" id="nivel-duolingo">1</div>
                        </div>
                        <div class="text-center">
                            <span class="text-sm">RANGO</span>
                            <div class="text-lg font-bold" id="rango-duolingo">Bronce</div>
                        </div>
                        <div class="text-center">
                            <span class="text-sm">RACHA</span>
                            <div class="text-lg font-bold" id="racha-duolingo">0</div>
                        </div>
                        <div class="flex text-2xl" id="vidas-duolingo">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>XP: <span id="xp-duolingo">0</span></span>
                        <span>Siguiente nivel: <span id="xp-siguiente">200</span></span>
                    </div>
                    <div class="w-full bg-white/30 h-3 rounded-full overflow-hidden">
                        <div class="bg-yellow-400 h-3 rounded-full" id="barra-xp-duolingo" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <!-- Ruta de competencias -->
            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üó∫Ô∏è Ruta de aprendizaje</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="ruta-container"></div>
            </div>

            <!-- Pregunta actual (formato CASO) -->
            <div class="card">
                <div id="pregunta-header" class="flex justify-between items-center mb-4">
                    <span class="bg-indigo-100 px-3 py-1 rounded-full text-sm" id="competencia-actual-tag">üìò 1.1 √Årea disciplinar</span>
                    <span class="text-xs text-gray-500" id="nivel-pregunta-tag">üü¢ Conceptual</span>
                </div>
                <div id="pregunta-container" class="min-h-[300px]">
                    <div class="text-center text-gray-500 py-12">Cargue documentos en Inicio y seleccione una competencia</div>
                </div>
            </div>
        </div>

        <!-- ========== TAB SIMULADOR ========== -->
        <div id="tab-simulador" class="tab-content hidden">
            <div class="card mb-6">
                <h2 class="text-2xl font-bold mb-4">üìù Simulacro oficial (60 preguntas)</h2>
                <p class="mb-4">Responda 60 preguntas. M√≠nimo 70% para aprobar.</p>
                <div class="flex gap-4 mb-6">
                    <button id="btn-iniciar-simulacro" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700">
                        Iniciar nuevo simulacro
                    </button>
                </div>
                <div id="estado-simulacro" class="hidden mb-4 p-4 bg-blue-50 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span>Progreso: <span id="simulacro-progreso">0/60</span></span>
                        <span>Correctas: <span id="simulacro-correctas">0</span></span>
                        <span>Nota actual: <span id="simulacro-nota">0%</span></span>
                    </div>
                    <div class="w-full bg-gray-200 h-2 rounded-full mt-2">
                        <div class="bg-blue-600 h-2 rounded-full" id="simulacro-barra" style="width:0%"></div>
                    </div>
                </div>
                <div id="simulacro-container" class="min-h-[300px]"></div>
                <div id="resultado-simulador" class="mt-6"></div>
            </div>
        </div>

        <!-- ========== TAB REPORTE ========== -->
        <div id="tab-reporte" class="tab-content hidden">
            <div class="card">
                <h2 class="text-2xl font-bold mb-6">üìä Mi progreso</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-lg mb-4">Rendimiento por competencia</h3>
                        <div id="reporte-competencias" class="space-y-4"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-4">Gr√°fico de dominio</h3>
                        <canvas id="radar-competencias" width="300" height="300"></canvas>
                    </div>
                </div>
                <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">üìà Estad√≠sticas globales</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="estadisticas-globales"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // ============================================
        // CONFIGURACI√ìN Y CONSTANTES
        // ============================================
        const VERSION = '2.0';
        const XP_POR_NIVEL = 200;
        const MAX_INTENTOS_RECURSION = 10;
        const MAX_FRAGMENTO_INTENTOS = 20;

        // ============================================
        // PERFILES MEP (COMPLETOS)
        // ============================================
        const perfilesMEP = {
            tecnico: {
                nombre: 'T√©cnico Docente (Asesores)',
                competencias: [
                    { codigo: '1.1', nombre: '√Årea disciplinar, pedag√≥gica y curricular', saber: true,
                      indicadores: ['Domina su disciplina', 'Asesora sobre actualizaciones curriculares', 'Fundamenta con teor√≠as pedag√≥gicas'] },
                    { codigo: '1.2', nombre: 'Marco jur√≠dico, √©tico y pol√≠ticas p√∫blicas', saber: true,
                      indicadores: ['Aplica Pol√≠tica Educativa', 'Interpreta normativa vinculante'] },
                    { codigo: '1.3', nombre: 'Estructura organizacional del MEP', saber: true,
                      indicadores: ['Coordina entre niveles', 'Aplica circulares y lineamientos'] },
                    { codigo: '2.1', nombre: 'Dise√±o de planes, programas y proyectos', saber: false,
                      indicadores: ['Elabora proyectos alineados a PPPJ', 'Dise√±a estrategias'] },
                    { codigo: '2.3', nombre: 'Liderazgo, asesor√≠a y TIC', saber: false,
                      indicadores: ['Utiliza plataformas digitales', 'Promueve innovaci√≥n'] }
                ]
            },
            docente: {
                nombre: 'Propiamente Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Conocimiento de estudiantes', saber: true, indicadores: ['Identifica desarrollo', 'Reconoce factores'] },
                    { codigo: '1.2', nombre: 'Dominio disciplinar', saber: true, indicadores: ['Selecciona estrategias', 'Aplica metodolog√≠as'] },
                    { codigo: '1.3', nombre: 'Pol√≠ticas y normativa', saber: true, indicadores: ['Cita C√≥digo Ni√±ez', 'Aplica evaluaci√≥n'] },
                    { codigo: '2.1', nombre: 'Dise√±o de experiencias', saber: false, indicadores: ['Adecua objetivos', 'Selecciona recursos'] },
                    { codigo: '2.2', nombre: 'Mediaci√≥n pedag√≥gica', saber: false, indicadores: ['Aplica cooperativo', 'Integra TIC'] },
                    { codigo: '2.3', nombre: 'Evaluaci√≥n', saber: false, indicadores: ['Construye r√∫bricas', 'Analiza resultados'] }
                ]
            },
            administrativo: {
                nombre: 'Administrativo Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Liderazgo pedag√≥gico', saber: true, indicadores: ['Modelos de supervisi√≥n'] },
                    { codigo: '1.4', nombre: 'Tecnolog√≠as', saber: true, indicadores: ['Usa sistemas', 'Seguridad'] },
                    { codigo: '2.3', nombre: 'Gesti√≥n de recursos', saber: false, indicadores: ['Presupuestos', 'Contrataci√≥n'] },
                    { codigo: '2.4', nombre: 'Seguridad informaci√≥n', saber: false, indicadores: ['Protocolos', 'Resguardo'] },
                    { codigo: '2.5', nombre: 'Liderazgo', saber: false, indicadores: ['Reuniones', 'Conflictos'] }
                ]
            }
        };

        // ============================================
        // PATRONES POR COMPETENCIA (REGEX)
        // ============================================
        const patronesCompetencia = {
            '1.1': [
                /\b(did√°ctica|metodolog√≠a|pedagog√≠a|curricular|curr√≠culum)\b/i,
                /\b(STEAM|PNFT)\b/i,
                /\bgu√≠a\s+(docente|did√°ctica)\b/i,
                /\b(aprendizaje|ense√±anza)\s+(activo|significativo)\b/i
            ],
            '1.2': [
                /\b(ley|art√≠culo|reglamento|normativa|pol√≠tica|√©tica)\b/i,
                /\b(art\.?\s*\d+)|(art√≠culo\s*\d+[¬∞¬™]?)\b/i,
                /\b(ley\s*N?¬∞?\s*\d{4})\b/i,
                /\b(10159|8292|6227|1581|7494|7600|9871)\b/
            ],
            '1.3': [
                /\b(estructura|organizaci√≥n|nivel)\s+(central|regional|institucional)\b/i,
                /\b(circular|lineamiento|directriz)\b/i
            ],
            '2.1': [
                /\b(plan|programa|proyecto|dise√±o)\s+(educativo|pedag√≥gico)\b/i,
                /\b(PPPJ|marco\s+estrat√©gico)\b/i
            ],
            '2.3': [
                /\b(TIC|tecnolog[√≠i]a|digital|innovaci√≥n)\b/i,
                /\b(MITDE|gobernanza|transformaci√≥n\s+digital)\b/i
            ]
        };

        // ============================================
        // RUTA DE COMPETENCIAS
        // ============================================
        const rutaDuolingo = [
            { codigo: '1.1', nombre: '√Årea disciplinar', tipo: 'üìò', estado: 'disponible' },
            { codigo: '1.2', nombre: 'Marco jur√≠dico', tipo: 'üìò', estado: 'bloqueado' },
            { codigo: '1.3', nombre: 'Estructura MEP', tipo: 'üìò', estado: 'bloqueado' },
            { codigo: '2.1', nombre: 'Dise√±o proyectos', tipo: 'üõ†Ô∏è', estado: 'bloqueado' },
            { codigo: '2.3', nombre: 'Liderazgo TIC', tipo: 'üõ†Ô∏è', estado: 'bloqueado' }
        ];

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let estratoActual = 'tecnico';
        let documentos = [];
        let generador = null;
        let frasesUsadas = JSON.parse(localStorage.getItem('frasesUsadas')) || {};

        let progresoUsuario = cargarProgreso() || {
            version: VERSION,
            nivel: { actual: 1, xp: 0, xpSiguiente: 200, rango: 'Bronce' },
            racha: { actual: 0, maxima: 0, ultimaFecha: null },
            competencias: {
                '1.1': { nivel: 0, xp: 0, dominada: false },
                '1.2': { nivel: 0, xp: 0, dominada: false },
                '1.3': { nivel: 0, xp: 0, dominada: false },
                '2.1': { nivel: 0, xp: 0, dominada: false },
                '2.3': { nivel: 0, xp: 0, dominada: false }
            },
            estadisticas: {
                totalPreguntas: 0,
                totalCorrectas: 0,
                totalIncorrectas: 0,
                simulacrosCompletados: 0,
                simulacrosAprobados: 0
            },
            historial: []
        };

        const simulador = {
            activo: false,
            preguntas: [],
            respondidas: 0,
            correctas: 0,
            resultadosPorCompetencia: {
                '1.1': { total: 0, correctas: 0 },
                '1.2': { total: 0, correctas: 0 },
                '1.3': { total: 0, correctas: 0 },
                '2.1': { total: 0, correctas: 0 },
                '2.3': { total: 0, correctas: 0 }
            },
            inicio: null
        };

        let preguntaActual = null;
        let competenciaActual = '1.1';

        // ============================================
        // FUNCIONES DE SEGURIDAD Y CHKECKSUM
        // ============================================
        function calcularChecksum(obj) {
            const str = JSON.stringify(obj) + 'IDOMEP_SECRET_2026';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return hash;
        }

        function guardarProgreso() {
            const copia = {...progresoUsuario};
            delete copia._checksum;
            copia._checksum = calcularChecksum(copia);
            localStorage.setItem('progresoIDOMEP', JSON.stringify(copia));
        }

        function cargarProgreso() {
            const guardado = localStorage.getItem('progresoIDOMEP');
            if (!guardado) return null;
            try {
                const data = JSON.parse(guardado);
                const checksum = data._checksum;
                delete data._checksum;
                if (calcularChecksum(data) !== checksum) return null;
                return data;
            } catch { return null; }
        }

        // ============================================
        // PROCESADOR UNIVERSAL (PDF, DOCX, TXT)
        // ============================================
        async function procesarArchivoUniversal(archivo) {
            try {
                const ext = archivo.name.split('.').pop().toLowerCase();
                let contenido = '';
                let paginas = 1;

                if (ext === 'pdf') {
                    const arrayBuffer = await archivo.arrayBuffer();
                    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    paginas = pdfDoc.numPages;
                    for (let i = 1; i <= Math.min(pdfDoc.numPages, 50); i++) {
                        const page = await pdfDoc.getPage(i);
                        const content = await page.getTextContent();
                        contenido += content.items.map(item => item.str).join(' ') + ' ';
                    }
                } else if (ext === 'docx' || ext === 'doc') {
                    const arrayBuffer = await archivo.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    contenido = result.value;
                } else { // txt
                    contenido = await archivo.text();
                }

                contenido = contenido.toLowerCase().replace(/[^\w\s√°√©√≠√≥√∫√±√º.,;:()\-]/g, ' ').replace(/\s+/g, ' ').trim();
                if (contenido.length < 50) throw new Error('Contenido insuficiente');

                return { nombre: archivo.name, contenido, tama√±o: archivo.size, paginas };
            } catch (error) {
                return { error: true, nombre: archivo.name, mensaje: error.message };
            }
        }

        // ============================================
        // GENERADOR DE PREGUNTAS CON FORMATO CASO
        // ============================================
        class GeneradorPreguntas {
            constructor(docs) { this.documentos = docs; }

            detectarCompetencia(texto, competenciaCodigo) {
                const patrones = patronesCompetencia[competenciaCodigo];
                if (!patrones) return false;
                return patrones.some(patron => patron.test(texto));
            }

            extraerFragmentos(doc, competenciaCodigo) {
                const oraciones = doc.contenido.split(/[.!?]+/).filter(o => o.trim().length > 60);
                return oraciones.filter(o => this.detectarCompetencia(o, competenciaCodigo));
            }

            fraseUsada(competencia, frase) {
                if (!frasesUsadas[competencia]) return false;
                const hash = frase.substring(0, 60);
                return frasesUsadas[competencia].includes(hash);
            }

            marcarFraseUsada(competencia, frase) {
                if (!frasesUsadas[competencia]) frasesUsadas[competencia] = [];
                const hash = frase.substring(0, 60);
                frasesUsadas[competencia].push(hash);
                if (frasesUsadas[competencia].length > 100) frasesUsadas[competencia] = frasesUsadas[competencia].slice(-50);
                localStorage.setItem('frasesUsadas', JSON.stringify(frasesUsadas));
            }

            // NUEVO: Genera un caso pr√°ctico a partir del fragmento normativo
            generarCaso(fragmento, competencia, documento) {
                const actores = {
                    '1.1': ['docente de aula', 'profesor de secundaria', 'equipo docente'],
                    '1.2': ['director regional', 'asesor legal', 'comit√© de √©tica'],
                    '1.3': ['asesor nacional', 'coordinador acad√©mico', 'jefe de departamento'],
                    '2.1': ['equipo de planificaci√≥n', 'comit√© t√©cnico', 'asesor pedag√≥gico'],
                    '2.3': ['coordinador TIC', 'asesor tecnol√≥gico', 'encargado de innovaci√≥n']
                };
                const situaciones = [
                    'enfrenta la siguiente situaci√≥n:',
                    'debe tomar una decisi√≥n fundamentada:',
                    'recibe una consulta del personal:',
                    'observa en su centro educativo:'
                ];
                const actor = actores[competencia]?.[Math.floor(Math.random() * actores[competencia].length)] || 'funcionario';
                const situacion = situaciones[Math.floor(Math.random() * situaciones.length)];
                const contexto = fragmento.substring(0, 200).trim();

                // Convertir el fragmento literal en un escenario pr√°ctico
                return {
                    caso: `Un ${actor} ${situacion}\n\n"${contexto}..."\n\nSeg√∫n la normativa vigente, ¬øcu√°l es la actuaci√≥n correcta?`,
                    contextoCompleto: fragmento
                };
            }

            generarOpcionesIncorrectas(doc, fragmentoCorrecto) {
                const frases = doc.contenido.split(/[.!?]+/).filter(f => f.trim().length > 30);
                const frasesIncorrectas = frases.filter(f => 
                    !fragmentoCorrecto.includes(f.substring(0, 40)) && 
                    f.length < 200 && 
                    !this.detectarCompetencia(f, '1.2') // evitar normativa clave
                );
                const seleccionadas = [];
                const copia = [...frasesIncorrectas];
                for (let i = 0; i < 3; i++) {
                    if (copia.length === 0) break;
                    const idx = Math.floor(Math.random() * copia.length);
                    seleccionadas.push(copia.splice(idx, 1)[0]);
                }
                while (seleccionadas.length < 3) {
                    seleccionadas.push(`Interpretaci√≥n no respaldada por los documentos`);
                }
                return seleccionadas;
            }

            extraerReferencia(texto) {
                const artMatch = texto.match(/(art[√≠i]culo\s+\d+)/i);
                if (artMatch) return artMatch[0];
                const leyMatch = texto.match(/(ley\s+\d+)/i);
                if (leyMatch) return leyMatch[0];
                return '';
            }

            determinarNivel(texto) {
                if (texto.includes('art√≠culo') || texto.includes('ley') || texto.includes('circular')) return 'normativo';
                if (texto.includes('ejemplo') || texto.includes('caso')) return 'aplicado';
                return 'conceptual';
            }

            generarPregunta(competenciaCodigo, intentos = 0) {
                if (intentos > MAX_INTENTOS_RECURSION || this.documentos.length === 0) return null;
                const doc = this.documentos[Math.floor(Math.random() * this.documentos.length)];
                let fragmentos = this.extraerFragmentos(doc, competenciaCodigo);
                if (fragmentos.length === 0) {
                    const oraciones = doc.contenido.split(/[.!?]+/).filter(o => o.trim().length > 80);
                    fragmentos = oraciones.length > 0 ? oraciones : [doc.contenido.substring(0, 300)];
                }
                if (fragmentos.length === 0) return this.generarPregunta(competenciaCodigo, intentos + 1);

                let fragmento, fragmentoIntentos = 0;
                do {
                    fragmento = fragmentos[Math.floor(Math.random() * fragmentos.length)];
                    fragmentoIntentos++;
                } while (this.fraseUsada(competenciaCodigo, fragmento) && fragmentoIntentos < MAX_FRAGMENTO_INTENTOS);
                if (fragmentoIntentos >= MAX_FRAGMENTO_INTENTOS) {
                    frasesUsadas[competenciaCodigo] = [];
                    fragmento = fragmentos[Math.floor(Math.random() * fragmentos.length)];
                }
                this.marcarFraseUsada(competenciaCodigo, fragmento);

                const nivel = this.determinarNivel(fragmento);
                const xp = nivel === 'normativo' ? 20 : (nivel === 'aplicado' ? 15 : 10);
                const referencia = this.extraerReferencia(fragmento);
                const caso = this.generarCaso(fragmento, competenciaCodigo, doc.nombre);
                const incorrectas = this.generarOpcionesIncorrectas(doc, fragmento);

                // Opci√≥n correcta (con fundamento normativo)
                const opcionCorrecta = {
                    texto: caso.caso.includes('?') ? 
                        `Aplicar lo establecido en ${doc.nombre} ${referencia ? `(${referencia})` : ''}` : 
                        `Fundamentar con el documento ${doc.nombre}`,
                    correcta: true,
                    fundamento: `‚úÖ Correcto. Seg√∫n ${doc.nombre} ${referencia ? `(${referencia})` : ''}: "${fragmento.substring(0,150)}..."`
                };

                const opciones = [opcionCorrecta];
                incorrectas.forEach(inc => {
                    opciones.push({
                        texto: inc.substring(0, 120) + (inc.length > 120 ? '...' : ''),
                        correcta: false,
                        fundamento: `‚ùå Incorrecto. No se ajusta a ${doc.nombre}.`
                    });
                });

                // Rotar posici√≥n de la correcta (0-3)
                const correctaIdx = Math.floor(Math.random() * 4);
                const temp = opciones[0];
                opciones[0] = opciones[correctaIdx];
                opciones[correctaIdx] = temp;

                return {
                    id: `gen_${Date.now()}_${Math.random()}`,
                    competencia: competenciaCodigo,
                    texto: caso.caso,
                    opciones: opciones,
                    correcta: correctaIdx,
                    fundamento: opcionCorrecta.fundamento,
                    documento: doc.nombre,
                    nivel: nivel,
                    xp: xp,
                    referencia: referencia
                };
            }
        }

        // ============================================
        // FUNCIONES DE INTERFAZ (resumidas por espacio)
        // ============================================
        function renderizarCompetencias() {
            const perfil = perfilesMEP[estratoActual];
            let html = '';
            perfil.competencias.forEach(comp => {
                const nivel = progresoUsuario.competencias[comp.codigo]?.nivel || 0;
                html += `<div class="p-3 bg-slate-50 rounded-lg border-l-4 border-blue-500">
                    <div class="flex justify-between"><span class="text-xs font-mono ${comp.saber ? 'bg-blue-200' : 'bg-green-200'} px-2 py-1 rounded-full">${comp.saber ? 'SABER' : 'HACER'}</span><span class="text-xs">Nivel ${nivel}</span></div>
                    <span class="font-medium block mt-1">${comp.codigo} ${comp.nombre}</span>
                    <div class="mt-2 flex flex-wrap gap-1">${comp.indicadores.map(i => `<span class="text-xs bg-white px-2 py-1 rounded-full">‚úì ${i}</span>`).join('')}</div>
                </div>`;
            });
            document.getElementById('competencias-container').innerHTML = html;
        }

        function renderizarRuta() {
            const container = document.getElementById('ruta-container');
            let html = '';
            rutaDuolingo.forEach(item => {
                const estado = progresoUsuario.competencias[item.codigo];
                html += `<div class="ruta-item ${item.estado} bg-slate-50 p-4 rounded-xl text-center" data-codigo="${item.codigo}">
                    <div class="text-3xl mb-2">${item.tipo}</div><div class="font-bold text-sm">${item.codigo}</div><div class="text-xs text-gray-600">${item.nombre}</div>
                    ${item.estado === 'disponible' ? `<div class="w-full bg-gray-200 h-1 rounded-full mt-2"><div class="bg-blue-600 h-1 rounded-full" style="width: ${estado?.nivel * 20 || 0}%"></div></div><div class="text-xs mt-1">Nivel ${estado?.nivel || 0}</div>` : '<div class="text-xs text-gray-400 mt-2">üîí Bloqueado</div>'}
                </div>`;
            });
            container.innerHTML = html;
            document.querySelectorAll('.ruta-item.disponible').forEach(item => {
                item.addEventListener('click', function() { competenciaActual = this.dataset.codigo; cargarPregunta(); });
            });
        }

        function actualizarUIDuolingo() {
            const xp = progresoUsuario.nivel.xp;
            const nivel = progresoUsuario.nivel.actual;
            const xpSiguiente = nivel * XP_POR_NIVEL;
            const xpActualNivel = xp - ((nivel-1) * XP_POR_NIVEL);
            const porcentaje = (xpActualNivel / XP_POR_NIVEL) * 100;
            document.getElementById('nivel-duolingo').textContent = nivel;
            document.getElementById('xp-duolingo').textContent = xp;
            document.getElementById('xp-siguiente').textContent = nivel * XP_POR_NIVEL;
            document.getElementById('barra-xp-duolingo').style.width = Math.min(100, porcentaje) + '%';
            document.getElementById('rango-duolingo').textContent = progresoUsuario.nivel.rango;
            document.getElementById('racha-duolingo').textContent = progresoUsuario.racha.actual;
            const vidas = 3 - Math.floor(progresoUsuario.estadisticas.totalIncorrectas / 5);
            let vidasHtml = '';
            for (let i = 0; i < 3; i++) vidasHtml += i < vidas ? '‚ù§Ô∏è' : 'ü§ç';
            document.getElementById('vidas-duolingo').innerHTML = vidasHtml;
        }

        function cargarPregunta() {
            if (!generador) { document.getElementById('pregunta-container').innerHTML = '<div class="text-center text-amber-600 py-12"><p class="font-medium">Primero cargue sus documentos en la pesta√±a INICIO</p></div>'; return; }
            const pregunta = generador.generarPregunta(competenciaActual);
            if (!pregunta) return;
            preguntaActual = pregunta;
            const compNombre = rutaDuolingo.find(r => r.codigo === competenciaActual).nombre;
            document.getElementById('competencia-actual-tag').innerHTML = `${rutaDuolingo.find(r => r.codigo === competenciaActual).tipo} ${competenciaActual} ${compNombre}`;
            const niveles = { conceptual: 'üü¢ Conceptual', aplicado: 'üü° Aplicado', normativo: 'üî¥ Normativo' };
            document.getElementById('nivel-pregunta-tag').textContent = niveles[pregunta.nivel] || 'üü¢ Conceptual';
            let html = `<div><p class="text-lg font-medium mb-4 whitespace-pre-line">${pregunta.texto}</p><div class="space-y-3 mb-6">`;
            pregunta.opciones.forEach((op, idx) => {
                html += `<label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer relative group" onclick="seleccionarOpcion(this, ${idx})">
                    <span class="w-6 h-6 rounded-full border-2 flex items-center justify-center font-bold text-sm flex-shrink-0 mt-0.5">${String.fromCharCode(65 + idx)}</span>
                    <div class="flex-1 min-w-0"><span class="text-sm block">${op.texto}</span></div>
                </label>`;
            });
            html += `</div><button id="btn-responder" onclick="responderPregunta()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold" disabled>Verificar respuesta</button></div><div id="feedback-duolingo" class="hidden mt-4"></div>`;
            document.getElementById('pregunta-container').innerHTML = html;
        }

        function seleccionarOpcion(label, idx) {
            document.querySelectorAll('#pregunta-container label').forEach(l => { l.classList.remove('bg-blue-100', 'border-blue-500'); l.querySelector('span:first-child').classList.remove('bg-blue-600', 'text-white', 'border-blue-600'); });
            label.classList.add('bg-blue-100', 'border-blue-500');
            label.querySelector('span:first-child').classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            document.getElementById('btn-responder').disabled = false;
            window.opcionSeleccionada = idx;
        }

        function responderPregunta() {
            if (window.opcionSeleccionada === undefined || !preguntaActual) return;
            const esCorrecta = window.opcionSeleccionada === preguntaActual.correcta;
            progresoUsuario.estadisticas.totalPreguntas++;
            if (esCorrecta) {
                progresoUsuario.estadisticas.totalCorrectas++;
                progresoUsuario.nivel.xp += preguntaActual.xp;
                if (progresoUsuario.competencias[preguntaActual.competencia]) {
                    progresoUsuario.competencias[preguntaActual.competencia].xp += preguntaActual.xp;
                    progresoUsuario.competencias[preguntaActual.competencia].nivel = Math.floor(progresoUsuario.competencias[preguntaActual.competencia].xp / 100) + 1;
                }
            } else { progresoUsuario.estadisticas.totalIncorrectas++; }
            // actualizar racha (simplificado)
            progresoUsuario.nivel.actual = Math.floor(progresoUsuario.nivel.xp / XP_POR_NIVEL) + 1;
            if (progresoUsuario.nivel.xp >= 2000) progresoUsuario.nivel.rango = 'Id√≥neo';
            else if (progresoUsuario.nivel.xp >= 1000) progresoUsuario.nivel.rango = 'Oro';
            else if (progresoUsuario.nivel.xp >= 500) progresoUsuario.nivel.rango = 'Plata';
            guardarProgreso();

            const feedback = document.getElementById('feedback-duolingo');
            const opcionElegida = preguntaActual.opciones[window.opcionSeleccionada];
            feedback.innerHTML = `<div class="bg-white rounded-xl p-6 shadow-lg border-l-4 ${esCorrecta ? 'border-green-500' : 'border-red-500'}">
                <h4 class="font-bold text-lg mb-2">${esCorrecta ? '‚úÖ Correcto' : '‚ùå Incorrecto'}</h4>
                <div class="bg-${esCorrecta ? 'green' : 'red'}-50 p-4 rounded-lg"><p class="font-medium">${esCorrecta ? 'Fundamento' : 'Error'}:</p><p>${esCorrecta ? preguntaActual.fundamento : opcionElegida.fundamento}</p>
                ${!esCorrecta ? `<p class="mt-2 font-medium">‚úÖ Correcta era:</p><p>${preguntaActual.opciones[preguntaActual.correcta].texto}</p>` : ''}</div>
                <button onclick="siguientePregunta()" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg">Continuar</button></div>`;
            feedback.classList.remove('hidden');
            document.getElementById('btn-responder').disabled = true;
            actualizarUIDuolingo(); renderizarRuta();
        }

        function siguientePregunta() { document.getElementById('feedback-duolingo').classList.add('hidden'); cargarPregunta(); }

        // ========== SIMULADOR (resumido funcional) ==========
        function iniciarSimulador() {
            if (!generador || documentos.length === 0) { alert('Debe cargar documentos primero'); return false; }
            const preguntas = []; const competencias = ['1.1', '1.2', '1.3', '2.1', '2.3']; const distribucion = [14, 14, 12, 10, 10];
            competencias.forEach((comp, idx) => { for (let i = 0; i < distribucion[idx]; i++) { const p = generador.generarPregunta(comp); if (p) preguntas.push(p); } });
            while (preguntas.length < 60) { const comp = competencias[Math.floor(Math.random() * competencias.length)]; const p = generador.generarPregunta(comp); if (p) preguntas.push(p); }
            simulador.activo = true; simulador.preguntas = preguntas.slice(0, 60); simulador.respondidas = 0; simulador.correctas = 0; simulador.inicio = Date.now();
            for (let comp in simulador.resultadosPorCompetencia) simulador.resultadosPorCompetencia[comp] = { total: 0, correctas: 0 };
            document.getElementById('estado-simulacro').classList.remove('hidden');
            document.getElementById('resultado-simulador').innerHTML = '';
            mostrarPreguntaSimulador(0);
        }

        function mostrarPreguntaSimulador(index) {
            if (index >= simulador.preguntas.length) { finalizarSimulador(); return; }
            const pregunta = simulador.preguntas[index];
            let html = `<div class="pregunta-simulador"><p class="text-sm text-gray-500 mb-2">Pregunta ${index+1} de 60</p><p class="text-lg font-medium mb-4 whitespace-pre-line">${pregunta.texto}</p><div class="space-y-3 mb-6">`;
            pregunta.opciones.forEach((op, idx) => { html += `<label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer" onclick="seleccionarOpcionSimulador(this, ${idx}, ${index})"><span class="w-6 h-6 rounded-full border-2 flex items-center justify-center font-bold">${String.fromCharCode(65 + idx)}</span><span>${op.texto}</span></label>`; });
            html += `</div><button id="btn-simulador" onclick="responderSimulador(${index})" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold" disabled>Responder</button></div>`;
            document.getElementById('simulacro-container').innerHTML = html;
            window.preguntaSimuladorActual = pregunta;
        }

        function seleccionarOpcionSimulador(label, idx, index) {
            document.querySelectorAll('.pregunta-simulador label').forEach(l => { l.classList.remove('bg-blue-100', 'border-blue-500'); l.querySelector('span:first-child').classList.remove('bg-blue-600', 'text-white', 'border-blue-600'); });
            label.classList.add('bg-blue-100', 'border-blue-500'); label.querySelector('span:first-child').classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            document.getElementById('btn-simulador').disabled = false;
            window.opcionSimuladorSeleccionada = { idx, index };
        }

        function responderSimulador(index) {
            if (!window.opcionSimuladorSeleccionada || window.opcionSimuladorSeleccionada.index !== index) return;
            const pregunta = simulador.preguntas[index]; const esCorrecta = window.opcionSimuladorSeleccionada.idx === pregunta.correcta;
            simulador.respondidas++; if (esCorrecta) simulador.correctas++;
            if (!simulador.resultadosPorCompetencia[pregunta.competencia]) simulador.resultadosPorCompetencia[pregunta.competencia] = { total: 0, correctas: 0 };
            simulador.resultadosPorCompetencia[pregunta.competencia].total++; if (esCorrecta) simulador.resultadosPorCompetencia[pregunta.competencia].correctas++;
            document.getElementById('simulacro-progreso').textContent = `${simulador.respondidas}/60`;
            document.getElementById('simulacro-correctas').textContent = simulador.correctas;
            document.getElementById('simulacro-nota').textContent = Math.round((simulador.correctas / simulador.respondidas) * 100) + '%';
            document.getElementById('simulacro-barra').style.width = (simulador.respondidas / 60 * 100) + '%';
            setTimeout(() => { mostrarPreguntaSimulador(index + 1); }, 400);
        }

        function finalizarSimulador() {
            simulador.activo = false;
            const tiempoSeg = Math.round((Date.now() - simulador.inicio) / 1000);
            const minutos = Math.floor(tiempoSeg / 60); const segundos = tiempoSeg % 60;
            const porcentaje = (simulador.correctas / 60) * 100; const aprobado = porcentaje >= 70;
            progresoUsuario.estadisticas.simulacrosCompletados++; if (aprobado) progresoUsuario.estadisticas.simulacrosAprobados++; guardarProgreso();
            let reporte = `<div class="bg-white p-6 rounded-xl shadow-lg mt-6"><h3 class="text-2xl font-bold mb-4 ${aprobado ? 'text-green-600' : 'text-red-600'}">${aprobado ? '‚úÖ APROBADO' : '‚ùå NO APROBADO'}</h3><p class="mb-2">Resultado: ${simulador.correctas}/60 (${porcentaje.toFixed(1)}%)</p><p class="mb-4">Tiempo: ${minutos}:${segundos.toString().padStart(2,'0')}</p><h4 class="font-bold mt-4 mb-2">üìä Desempe√±o por competencia:</h4><div class="space-y-2">`;
            for (let [comp, res] of Object.entries(simulador.resultadosPorCompetencia)) {
                const compNombre = rutaDuolingo.find(r => r.codigo === comp)?.nombre || comp;
                const compPorc = res.total > 0 ? (res.correctas / res.total * 100).toFixed(1) : 0;
                reporte += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded"><span class="font-medium">${comp} - ${compNombre.substring(0,30)}...</span><span class="${compPorc>=70?'text-green-600':compPorc>=50?'text-yellow-600':'text-red-600'} font-bold">${res.correctas}/${res.total} (${compPorc}%)</span></div>`;
            }
            reporte += `</div><button onclick="iniciarSimulador()" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg">Nuevo simulacro</button></div>`;
            document.getElementById('resultado-simulador').innerHTML = reporte;
            document.getElementById('simulacro-container').innerHTML = '';
            document.getElementById('estado-simulacro').classList.add('hidden');
        }

        // ========== REPORTE ==========
        function generarReporteCompetencias() {
            const container = document.getElementById('reporte-competencias'); if (!container) return;
            let html = '';
            for (let [codigo, data] of Object.entries(progresoUsuario.competencias)) {
                const competencia = perfilesMEP[estratoActual]?.competencias.find(c => c.codigo === codigo);
                const nombre = competencia?.nombre || codigo;
                const porcentaje = data.nivel * 20;
                const colorBarra = porcentaje >= 80 ? 'bg-green-500' : (porcentaje >= 50 ? 'bg-yellow-500' : 'bg-red-500');
                html += `<div class="mb-4"><div class="flex justify-between items-center mb-1"><span class="font-medium text-sm">${codigo} - ${nombre.substring(0,30)}</span><span class="text-sm font-bold">${data.nivel}</span></div><div class="w-full bg-gray-200 h-4 rounded-full overflow-hidden"><div class="${colorBarra} h-4 rounded-full" style="width: ${porcentaje}%"></div></div><p class="text-xs text-gray-500 mt-1">XP: ${data.xp}</p></div>`;
            }
            container.innerHTML = html;
            const ctx = document.getElementById('radar-competencias').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: { labels: ['1.1', '1.2', '1.3', '2.1', '2.3'], datasets: [{ label: 'Nivel de dominio', data: [progresoUsuario.competencias['1.1'].nivel*20, progresoUsuario.competencias['1.2'].nivel*20, progresoUsuario.competencias['1.3'].nivel*20, progresoUsuario.competencias['2.1'].nivel*20, progresoUsuario.competencias['2.3'].nivel*20], backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6' }] },
                options: { scales: { r: { min: 0, max: 100 } } }
            });
            document.getElementById('estadisticas-globales').innerHTML = `
                <div class="p-3 bg-white rounded-lg shadow"><span class="text-sm text-gray-500">Total preguntas</span><p class="text-2xl font-bold">${progresoUsuario.estadisticas.totalPreguntas}</p></div>
                <div class="p-3 bg-white rounded-lg shadow"><span class="text-sm text-gray-500">Correctas</span><p class="text-2xl font-bold text-green-600">${progresoUsuario.estadisticas.totalCorrectas}</p></div>
                <div class="p-3 bg-white rounded-lg shadow"><span class="text-sm text-gray-500">Simulacros</span><p class="text-2xl font-bold">${progresoUsuario.estadisticas.simulacrosCompletados}</p></div>
                <div class="p-3 bg-white rounded-lg shadow"><span class="text-sm text-gray-500">Aprobados</span><p class="text-2xl font-bold text-blue-600">${progresoUsuario.estadisticas.simulacrosAprobados}</p></div>
            `;
        }

        // ========== EVENTOS INICIALES ==========
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${this.dataset.tab}`).classList.remove('hidden');
                if (this.dataset.tab === 'reporte') generarReporteCompetencias();
            });
        });

        document.querySelectorAll('#selector-estrato .estrato-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#selector-estrato .estrato-btn').forEach(b => { b.classList.remove('bg-blue-600', 'text-white'); b.classList.add('bg-slate-100'); });
                this.classList.remove('bg-slate-100'); this.classList.add('bg-blue-600', 'text-white');
                estratoActual = this.dataset.estrato;
                renderizarCompetencias();
            });
        });

        document.getElementById('carga-docs').addEventListener('change', async function(e) {
            const archivos = Array.from(e.target.files);
            documentos = [];
            const listaDiv = document.getElementById('lista-docs');
            const progresoDiv = document.getElementById('progreso-carga');
            listaDiv.innerHTML = '';
            for (let i = 0; i < archivos.length; i++) {
                const archivo = archivos[i];
                progresoDiv.innerHTML = `Procesando ${i+1}/${archivos.length}: ${archivo.name}...`;
                const resultado = await procesarArchivoUniversal(archivo);
                if (resultado.error) listaDiv.innerHTML += `<div class="py-1 text-xs text-red-600">‚ùå ${resultado.nombre}: ${resultado.mensaje}</div>`;
                else { documentos.push(resultado); listaDiv.innerHTML += `<div class="py-1 text-xs text-green-600">‚úÖ ${resultado.nombre}</div>`; }
            }
            generador = new GeneradorPreguntas(documentos);
            listaDiv.classList.remove('hidden');
            progresoDiv.innerHTML = `‚úÖ ${documentos.length} documentos listos`;
        });

        document.getElementById('btn-iniciar-simulacro').addEventListener('click', iniciarSimulador);
        setInterval(guardarProgreso, 30000);
        window.addEventListener('beforeunload', guardarProgreso);

        renderizarCompetencias(); renderizarRuta(); actualizarUIDuolingo();
    </script>
</body>
</html>
