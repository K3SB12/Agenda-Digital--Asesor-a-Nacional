<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì IDOMEP v1 ¬∑ Sistema de Idoneidad</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes shine {
            0% { filter: drop-shadow(0 0 2px gold); }
            50% { filter: drop-shadow(0 0 10px gold); }
            100% { filter: drop-shadow(0 0 2px gold); }
        }
        .animate-pulse-slow {
            animation: pulse 2s infinite;
        }
        .animate-shine {
            animation: shine 2s infinite;
        }
        .heart-full { color: #ef4444; }
        .heart-empty { color: #d1d5db; }
        .ruta-item {
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .ruta-item.disponible:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
        }
        .ruta-item.bloqueado {
            opacity: 0.6;
            filter: grayscale(0.5);
            cursor: not-allowed;
        }
        .medalla {
            transition: all 0.3s;
            filter: grayscale(0.7);
        }
        .medalla.obtenida {
            filter: grayscale(0);
            animation: shine 3s infinite;
        }
        .medalla.obtenida:hover {
            transform: rotate(5deg) scale(1.1);
        }
        .tab-button.active {
            background: #2563eb;
            color: white;
            border-color: #1d4ed8;
        }
        .vidas-container span {
            transition: all 0.3s;
        }
        .vidas-container span.perdida {
            transform: scale(0.8);
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 font-sans min-h-screen">

    <!-- ============================================ -->
    <!-- BARRA SUPERIOR FIJA                          -->
    <!-- ============================================ -->
    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-blue-100 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üéì</span>
                <span class="font-bold text-gray-800">IDOMEP <span class="text-blue-600">v1</span></span>
            </div>
            
            <!-- XP global r√°pido -->
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2">
                    <i class="fa-regular fa-star text-yellow-500"></i>
                    <span class="font-medium" id="xp-global">0 XP</span>
                </div>
                
                <!-- TABS -->
                <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                    <button data-tab="inicio" class="tab-button px-4 py-1.5 rounded-lg text-sm font-medium transition flex items-center gap-1 active">
                        <i class="fa-regular fa-house"></i>
                        <span class="hidden md:inline">Inicio</span>
                    </button>
                    <button data-tab="duolingo" class="tab-button px-4 py-1.5 rounded-lg text-sm font-medium transition flex items-center gap-1">
                        <i class="fa-regular fa-gamepad"></i>
                        <span class="hidden md:inline">IdoMep v1</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4">
        
        <!-- ============================================ -->
        <!-- CONTENEDOR DE TABS                           -->
        <!-- ============================================ -->
        
        <!-- TAB INICIO (Sistema actual mejorado) -->
        <div id="tab-inicio" class="tab-content block">
            <!-- Cabecera informativa -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border-l-8 border-blue-600">
                <h2 class="text-2xl font-bold mb-2">üìö Sistema de Estudio MEP</h2>
                <p class="text-gray-600">Cargue sus documentos, seleccione su estrato y practique por competencias.</p>
                <div class="mt-3 text-sm bg-blue-50 p-3 rounded-lg">
                    <span class="font-medium">Fundamento:</span> LMEP N.¬∫ 10159 ¬∑ Ley N.¬∫9871 ¬∑ Resoluci√≥n DG-RES-88-2023 ¬∑ Calificaci√≥n m√≠nima 70
                </div>
            </div>

            <!-- SELECTOR DE ESTRATO -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="font-bold text-lg mb-4">üéØ Seleccione su estrato</h3>
                <div class="flex flex-wrap gap-3" id="selector-estrato-inicio">
                    <button data-estrato="docente" class="estrato-btn px-5 py-2.5 rounded-full bg-slate-100 hover:bg-blue-100 transition font-medium">Propiamente Docente</button>
                    <button data-estrato="tecnico" class="estrato-btn px-5 py-2.5 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition font-medium">T√©cnico Docente (Asesores)</button>
                    <button data-estrato="administrativo" class="estrato-btn px-5 py-2.5 rounded-full bg-slate-100 hover:bg-blue-100 transition font-medium">Administrativo Docente</button>
                </div>
            </div>

            <!-- CARGA DE DOCUMENTOS -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fa-regular fa-folder-open text-blue-600"></i>
                    Documentos de estudio (PDF o TXT)
                </h3>
                <p class="text-sm text-amber-600 mb-3">‚ö†Ô∏è Seleccione todos sus archivos. El sistema los leer√° autom√°ticamente.</p>
                <input type="file" id="carga-docs" multiple accept=".pdf,.txt" class="mb-4 w-full p-2 border rounded-lg">
                <div id="lista-docs" class="text-sm max-h-40 overflow-y-auto bg-slate-50 p-3 rounded-lg hidden"></div>
                <div id="progreso-carga" class="text-xs text-gray-500 mt-2"></div>
            </div>

            <!-- COMPETENCIAS Y PR√ÅCTICA (sistema actual) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Competencias -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i class="fa-regular fa-list text-blue-600"></i>
                        Competencias del estrato
                    </h3>
                    <div id="competencias-container" class="space-y-3 text-sm max-h-96 overflow-y-auto pr-2"></div>
                </div>
                
                <!-- Pr√°ctica r√°pida -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i class="fa-regular fa-pen-to-square text-green-600"></i>
                        Pr√°ctica libre
                    </h3>
                    <div class="mb-4">
                        <select id="selector-competencia-inicio" class="w-full border rounded-lg px-3 py-2 text-sm">
                            <option value="">Cualquier competencia</option>
                        </select>
                    </div>
                    <button id="btn-generar-inicio" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                        Generar pregunta de pr√°ctica
                    </button>
                    <div id="simulador-inicio" class="mt-4 space-y-4 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- TAB DUOLINGO JUR√çDICO (IDOMEP v1)            -->
        <!-- ============================================ -->
        <div id="tab-duolingo" class="tab-content hidden">
            
            <!-- Panel superior gamificado -->
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl shadow-xl p-6 mb-6 text-white">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 bg-white/20 backdrop-blur rounded-2xl flex items-center justify-center">
                            <span class="text-4xl">üéÆ</span>
                        </div>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-black">IDOMEP <span class="text-yellow-300">v1</span></h2>
                            <p class="text-blue-100">Domina competencias ¬∑ Gana medallas ¬∑ Convi√©rtete en asesor experto</p>
                        </div>
                    </div>
                    
                    <!-- XP y Vidas -->
                    <div class="flex gap-6">
                        <!-- XP -->
                        <div class="text-center">
                            <div class="text-sm opacity-90">NIVEL</div>
                            <div class="text-3xl font-bold" id="nivel-duolingo">1</div>
                            <div class="text-xs bg-white/20 px-2 py-0.5 rounded-full mt-1" id="rango-duolingo">Aspirante</div>
                        </div>
                        <!-- Barra XP -->
                        <div class="w-32 flex flex-col justify-center">
                            <div class="flex justify-between text-xs mb-1">
                                <span>XP</span>
                                <span><span id="xp-duolingo">0</span>/<span id="xp-siguiente-duolingo">200</span></span>
                            </div>
                            <div class="w-full bg-white/30 h-3 rounded-full overflow-hidden">
                                <div class="bg-yellow-400 h-3 rounded-full" id="barra-xp-duolingo" style="width:0%"></div>
                            </div>
                        </div>
                        <!-- Vidas -->
                        <div class="flex items-center gap-1 text-2xl vidas-container" id="vidas-duolingo">
                            <span class="heart-full">‚ù§Ô∏è</span>
                            <span class="heart-full">‚ù§Ô∏è</span>
                            <span class="heart-full">‚ù§Ô∏è</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mapa de ruta gamificado -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fa-regular fa-map text-blue-600"></i>
                    Ruta de dominio (desbloquea progresivamente)
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="ruta-container">
                    <!-- Se llena con JS -->
                </div>
            </div>

            <!-- Medallas y logros -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <i class="fa-regular fa-medal text-yellow-500"></i>
                        Medallas
                    </h3>
                    <span class="text-sm text-gray-500" id="medallas-contador">0/6 obtenidas</span>
                </div>
                <div class="grid grid-cols-3 md:grid-cols-6 gap-3" id="medallas-container">
                    <!-- Se llena con JS -->
                </div>
            </div>

            <!-- √Årea de juego (pregunta actual) -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div id="pregunta-header" class="flex justify-between items-center mb-4">
                    <div>
                        <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium" id="competencia-actual-tag">
                            üìò 1.1 √Årea disciplinar
                        </span>
                        <span class="ml-2 text-xs text-gray-500" id="nivel-pregunta-tag">üü¢ Conceptual</span>
                    </div>
                    <div class="text-sm bg-gray-100 px-3 py-1 rounded-full" id="progreso-pregunta">
                        Pregunta 1/5
                    </div>
                </div>
                
                <div id="pregunta-container" class="min-h-[300px]">
                    <!-- La pregunta se renderiza aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // ============================================
        // PERFILES MEP (COMPLETOS)
        // ============================================
        const perfilesMEP = {
            tecnico: {
                nombre: 'T√©cnico Docente (Asesores)',
                competencias: [
                    { codigo: '1.1', nombre: '√Årea disciplinar, pedag√≥gica y curricular', saber: true,
                      indicadores: ['Domina su disciplina', 'Asesora sobre actualizaciones curriculares', 'Fundamenta con teor√≠as pedag√≥gicas'] },
                    { codigo: '1.2', nombre: 'Marco jur√≠dico, √©tico y pol√≠ticas p√∫blicas', saber: true,
                      indicadores: ['Aplica Pol√≠tica Educativa', 'Interpreta normativa vinculante'] },
                    { codigo: '1.3', nombre: 'Estructura organizacional del MEP', saber: true,
                      indicadores: ['Coordina entre niveles', 'Deriva consultas'] },
                    { codigo: '2.1', nombre: 'Dise√±o de planes, programas y proyectos', saber: false,
                      indicadores: ['Elabora proyectos', 'Dise√±a estrategias'] },
                    { codigo: '2.3', nombre: 'Liderazgo, asesor√≠a y TIC', saber: false,
                      indicadores: ['Usa plataformas digitales', 'Promueve innovaci√≥n'] }
                ]
            },
            docente: {
                nombre: 'Propiamente Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Conocimiento de estudiantes y contexto', saber: true, indicadores: ['Identifica desarrollo', 'Reconoce factores'] },
                    { codigo: '1.2', nombre: 'Dominio disciplinar y did√°ctico', saber: true, indicadores: ['Selecciona estrategias', 'Aplica teor√≠as'] },
                    { codigo: '1.3', nombre: 'Pol√≠ticas y normativa educativa', saber: true, indicadores: ['Cita C√≥digo Ni√±ez', 'Aplica evaluaci√≥n'] },
                    { codigo: '2.1', nombre: 'Dise√±o de experiencias', saber: false, indicadores: ['Adecua objetivos', 'Selecciona recursos'] },
                    { codigo: '2.2', nombre: 'Mediaci√≥n pedag√≥gica', saber: false, indicadores: ['Aplica cooperativo', 'Integra TIC'] },
                    { codigo: '2.3', nombre: 'Evaluaci√≥n de aprendizajes', saber: false, indicadores: ['Construye r√∫bricas', 'Analiza resultados'] }
                ]
            },
            administrativo: {
                nombre: 'Administrativo Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Liderazgo pedag√≥gico y gesti√≥n', saber: true, indicadores: ['Identifica modelos', 'Reconoce estilos'] },
                    { codigo: '1.4', nombre: 'Tecnolog√≠as en educaci√≥n', saber: true, indicadores: ['Usa sistemas', 'Conoce pol√≠ticas'] },
                    { codigo: '2.3', nombre: 'Gesti√≥n de recursos', saber: false, indicadores: ['Elabora presupuestos', 'Aplica Contrataci√≥n'] },
                    { codigo: '2.4', nombre: 'Gesti√≥n segura de informaci√≥n', saber: false, indicadores: ['Aplica protocolos', 'Resguarda'] },
                    { codigo: '2.5', nombre: 'Liderazgo y responsabilidad', saber: false, indicadores: ['Conduce reuniones', 'Resuelve conflictos'] }
                ]
            }
        };

        // ============================================
        // RUTA GAMIFICADA (IDOMEP v1)
        // ============================================
        const rutaDuolingo = [
            { codigo: '1.1', nombre: '√Årea disciplinar', tipo: 'üìò', estado: 'disponible' },
            { codigo: '1.2', nombre: 'Marco jur√≠dico', tipo: 'üìò', estado: 'bloqueado' },
            { codigo: '1.3', nombre: 'Estructura MEP', tipo: 'üìò', estado: 'bloqueado' },
            { codigo: '2.1', nombre: 'Dise√±o proyectos', tipo: 'üõ†Ô∏è', estado: 'bloqueado' },
            { codigo: '2.3', nombre: 'Liderazgo TIC', tipo: 'üõ†Ô∏è', estado: 'bloqueado' }
        ];

        // Estado gamificado por competencia
        const estadoCompetencia = {
            '1.1': {
                xp: 0,
                vidas: 3,
                nivelActual: 'conceptual', // conceptual, aplicado, normativo
                correctasConsecutivas: 0,
                porcentaje: 0,
                preguntasDominadas: [],
                preguntasRespondidas: [],
                modoRefuerzo: false,
                dominado: false
            },
            '1.2': {
                xp: 0,
                vidas: 3,
                nivelActual: 'conceptual',
                correctasConsecutivas: 0,
                porcentaje: 0,
                preguntasDominadas: [],
                preguntasRespondidas: [],
                modoRefuerzo: false,
                dominado: false
            },
            '1.3': {
                xp: 0,
                vidas: 3,
                nivelActual: 'conceptual',
                correctasConsecutivas: 0,
                porcentaje: 0,
                preguntasDominadas: [],
                preguntasRespondidas: [],
                modoRefuerzo: false,
                dominado: false
            },
            '2.1': {
                xp: 0,
                vidas: 3,
                nivelActual: 'conceptual',
                correctasConsecutivas: 0,
                porcentaje: 0,
                preguntasDominadas: [],
                preguntasRespondidas: [],
                modoRefuerzo: false,
                dominado: false
            },
            '2.3': {
                xp: 0,
                vidas: 3,
                nivelActual: 'conceptual',
                correctasConsecutivas: 0,
                porcentaje: 0,
                preguntasDominadas: [],
                preguntasRespondidas: [],
                modoRefuerzo: false,
                dominado: false
            }
        };

        // Medallas
        const medallas = [
            { id: 'juridico', nombre: 'Dominio Jur√≠dico', icono: '‚öñÔ∏è', obtenida: false, competencia: '1.2' },
            { id: 'control', nombre: 'Control Interno Experto', icono: 'üîí', obtenida: false, competencia: '1.2' },
            { id: 'curricular', nombre: 'Dise√±o Curricular', icono: 'üìê', obtenida: false, competencia: '1.1' },
            { id: 'proyectos', nombre: 'Dise√±o Estrat√©gico PPPJ', icono: 'üìä', obtenida: false, competencia: '2.1' },
            { id: 'tic', nombre: 'Gobernanza TIC', icono: 'üíª', obtenida: false, competencia: '2.3' },
            { id: 'completo', nombre: 'Asesor Completo', icono: 'üèÜ', obtenida: false, competencia: 'todas' }
        ];

        // XP por nivel de pregunta
        const XP_VALORES = {
            conceptual: 10,
            aplicado: 15,
            normativo: 20
        };

        // ============================================
        // BANCO DE PREGUNTAS (ejemplo para 1.2)
        // ============================================
        const bancoPreguntas = {
            '1.2': {
                conceptual: [
                    {
                        id: '1.2_c1',
                        texto: '¬øQu√© establece la Ley 10159 respecto a la idoneidad para la carrera docente?',
                        opciones: [
                            { texto: 'La idoneidad es requisito obligatorio (Art.5 inciso l)', correcta: true, 
                              fundamento: 'Ley 10159 Art.5: "La idoneidad comprobada es requisito para el ingreso"',
                              errorComun: 'Confundir idoneidad con antig√ºedad' },
                            { texto: 'Es opcional, depende del jerarca', correcta: false,
                              fundamento: 'No es opcional, es requisito de ley',
                              errorComun: 'Creer que hay discrecionalidad' },
                            { texto: 'Solo aplica para nuevos ingresos', correcta: false,
                              fundamento: 'Aplica tambi√©n para interinos en Transitorio IX',
                              errorComun: 'Ignorar el transitorio' },
                            { texto: 'Se demuestra con a√±os de servicio', correcta: false,
                              fundamento: 'La experiencia no sustituye la idoneidad',
                              errorCom√∫n: 'Confundir experiencia con idoneidad' }
                        ],
                        articulos: [{ doc: 'Ley 10159.pdf', art: 'Art.5' }],
                        nivel: 'conceptual',
                        xp: 10
                    },
                    {
                        id: '1.2_c2',
                        texto: 'Seg√∫n la Ley 8292 de Control Interno, ¬øcu√°l es la responsabilidad del jerarca?',
                        opciones: [
                            { texto: 'Implementar medidas correctivas inmediatas (Art.16)', correcta: true,
                              fundamento: 'Ley 8292 Art.16: "El jerarca debe tomar medidas correctivas"',
                              errorComun: 'Esperar a que otros nivele act√∫en' },
                            { texto: 'Solo informar a la auditor√≠a', correcta: false,
                              fundamento: 'Informar no es suficiente, debe actuar',
                              errorComun: 'Delegar responsabilidad' },
                            { texto: 'Esperar directrices superiores', correcta: false,
                              fundamento: 'La responsabilidad es indelegable',
                              errorComun: 'Creer que siempre debe esperar' },
                            { texto: 'Documentar sin actuar', correcta: false,
                              fundamento: 'Documentar es necesario pero no suficiente',
                              errorComun: 'Cumplimiento parcial' }
                        ],
                        articulos: [{ doc: 'ley 8292.docx', art: 'Art.16' }],
                        nivel: 'conceptual',
                        xp: 10
                    }
                ],
                aplicado: [
                    {
                        id: '1.2_a1',
                        texto: 'Un asesor detecta que un director omiti√≥ procedimientos de control interno. ¬øQu√© art√≠culo de la Ley 8292 se vulnera principalmente?',
                        opciones: [
                            { texto: 'Art√≠culo 8 (Deberes del jerarca)', correcta: true,
                              fundamento: 'Ley 8292 Art.8: "El jerarca debe velar por el control interno"',
                              errorComun: 'Enfocarse en art√≠culos sancionatorios' },
                            { texto: 'Art√≠culo 16 (Medidas correctivas)', correcta: false,
                              fundamento: 'Aplica cuando ya se detect√≥, no por omisi√≥n',
                              errorComun: 'Confundir deber con sanci√≥n' },
                            { texto: 'Art√≠culo 12 (Sistema de control)', correcta: false,
                              fundamento: 'Es complementario, pero el deber principal es Art.8',
                              errorComun: 'No identificar el deber primario' },
                            { texto: 'Art√≠culo 4 (Principios)', correcta: false,
                              fundamento: 'Es muy general, no espec√≠fico',
                              errorComun: 'Quedarse en principios' }
                        ],
                        articulos: [{ doc: 'ley 8292.docx', art: 'Art.8' }],
                        nivel: 'aplicado',
                        xp: 15
                    }
                ],
                normativo: [
                    {
                        id: '1.2_n1',
                        texto: 'Seg√∫n el art√≠culo 5 de la Ley 10159, ¬øcu√°l de las siguientes opciones describe correctamente el principio de idoneidad?',
                        opciones: [
                            { texto: 'Debe comprobarse mediante mecanismos t√©cnicos de selecci√≥n', correcta: true,
                              fundamento: 'Art.5: "Idoneidad comprobada mediante mecanismos t√©cnicos"',
                              errorComun: 'Creer que basta con declaraci√≥n jurada' },
                            { texto: 'Se presume por la experiencia', correcta: false,
                              fundamento: 'La experiencia no la comprueba autom√°ticamente',
                              errorComun: 'Confundir experiencia con idoneidad' },
                            { texto: 'Es potestativo del jerarca', correcta: false,
                              fundamento: 'Es obligatorio, no potestativo',
                              errorComun: 'Discrecionalidad mal entendida' },
                            { texto: 'Se demuestra con t√≠tulos universitarios', correcta: false,
                              fundamento: 'Los t√≠tulos son necesarios pero no suficientes',
                              errorComun: 'Reduccionismo acad√©mico' }
                        ],
                        articulos: [{ doc: 'Ley 10159.pdf', art: 'Art.5' }],
                        nivel: 'normativo',
                        xp: 20
                    }
                ]
            }
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let estratoActual = 'tecnico';
        let documentos = [];
        let progresoGlobal = JSON.parse(localStorage.getItem('progresoGlobal')) || { 
            xpTotal: 0, 
            nivel: 1,
            vidas: 3,
            medallas: medallas.map(m => m.id)
        };
        
        // Estado gamificado (cargar de localStorage)
        let estadoDuolingo = JSON.parse(localStorage.getItem('estadoDuolingo')) || estadoCompetencia;

        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        
        // Cambio de tabs
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const tab = this.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
                
                if (tab === 'duolingo') {
                    renderizarRutaDuolingo();
                    renderizarMedallas();
                    actualizarUIDuolingo();
                    cargarPreguntaDuolingo();
                }
            });
        });

        // Renderizar ruta gamificada
        function renderizarRutaDuolingo() {
            const container = document.getElementById('ruta-container');
            let html = '';
            
            rutaDuolingo.forEach(item => {
                const estado = estadoDuolingo[item.codigo];
                const clase = item.estado === 'disponible' ? 'disponible cursor-pointer' : 'bloqueado';
                const color = item.tipo === 'üìò' ? 'bg-blue-50' : 'bg-indigo-50';
                
                html += `
                    <div class="ruta-item ${clase} ${color} p-4 rounded-xl text-center ${item.estado === 'disponible' ? 'hover:shadow-lg' : ''}"
                         data-codigo="${item.codigo}">
                        <div class="text-3xl mb-2">${item.tipo}</div>
                        <div class="font-bold text-sm">${item.codigo}</div>
                        <div class="text-xs text-gray-600 mb-2">${item.nombre}</div>
                        ${item.estado === 'disponible' ? `
                            <div class="w-full bg-gray-200 h-1 rounded-full mt-2">
                                <div class="bg-blue-600 h-1 rounded-full" style="width: ${estado.porcentaje}%"></div>
                            </div>
                            <div class="text-xs mt-1">${estado.preguntasDominadas.length}/5 dom</div>
                        ` : `
                            <div class="text-xs text-gray-400 mt-2">üîí Bloqueado</div>
                        `}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Eventos para items disponibles
            document.querySelectorAll('.ruta-item.disponible').forEach(item => {
                item.addEventListener('click', function() {
                    const codigo = this.dataset.codigo;
                    competenciaActualDuolingo = codigo;
                    cargarPreguntaDuolingo();
                });
            });
        }

        // Renderizar medallas
        function renderizarMedallas() {
            const container = document.getElementById('medallas-container');
            let html = '';
            let obtenidas = 0;
            
            medallas.forEach(medalla => {
                const obtenida = progresoGlobal.medallas?.includes(medalla.id) || false;
                if (obtenida) obtenidas++;
                
                html += `
                    <div class="medalla ${obtenida ? 'obtenida' : ''} text-center p-2">
                        <div class="text-3xl mb-1">${medalla.icono}</div>
                        <div class="text-xs font-medium">${medalla.nombre}</div>
                        ${obtenida ? '<div class="text-yellow-500 text-xs">‚úì Obtenida</div>' : '<div class="text-gray-300 text-xs">Bloqueada</div>'}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('medallas-contador').textContent = `${obtenidas}/${medallas.length} obtenidas`;
        }

        // Actualizar UI de XP, vidas, nivel
        function actualizarUIDuolingo() {
            const xp = progresoGlobal.xpTotal || 0;
            const nivel = Math.floor(xp / 200) + 1;
            const xpNivel = xp % 200;
            
            document.getElementById('nivel-duolingo').textContent = nivel;
            document.getElementById('xp-duolingo').textContent = xpNivel;
            document.getElementById('barra-xp-duolingo').style.width = (xpNivel / 200 * 100) + '%';
            
            // Rango seg√∫n nivel
            const rangos = ['Aspirante', 'Asesor en formaci√≥n', 'Asesor profesional', 'Asesor experto', 'Maestro asesor'];
            document.getElementById('rango-duolingo').textContent = rangos[Math.min(nivel-1, rangos.length-1)] || 'Leyenda';
            
            // Vidas
            const vidas = estadoDuolingo[competenciaActualDuolingo]?.vidas || 3;
            let vidasHtml = '';
            for (let i = 0; i < 3; i++) {
                vidasHtml += `<span class="${i < vidas ? 'heart-full' : 'heart-empty'} text-2xl">‚ù§Ô∏è</span>`;
            }
            document.getElementById('vidas-duolingo').innerHTML = vidasHtml;
        }

        // Cargar pregunta actual en Duolingo
        let competenciaActualDuolingo = '1.1';
        
        function cargarPreguntaDuolingo() {
            const estado = estadoDuolingo[competenciaActualDuolingo];
            if (!estado) return;
            
            const banco = bancoPreguntas[competenciaActualDuolingo];
            if (!banco) return;
            
            // Elegir nivel seg√∫n progreso
            let nivelPregunta = estado.nivelActual;
            if (estado.preguntasDominadas.length >= 3 && nivelPregunta === 'conceptual') {
                estado.nivelActual = 'aplicado';
                nivelPregunta = 'aplicado';
            } else if (estado.preguntasDominadas.length >= 6 && nivelPregunta === 'aplicado') {
                estado.nivelActual = 'normativo';
                nivelPregunta = 'normativo';
            }
            
            const preguntasDisponibles = banco[nivelPregunta]?.filter(p => !estado.preguntasRespondidas.includes(p.id)) || [];
            
            if (preguntasDisponibles.length === 0) {
                // Reiniciar ciclo
                estado.preguntasRespondidas = [];
                cargarPreguntaDuolingo();
                return;
            }
            
            const pregunta = preguntasDisponibles[Math.floor(Math.random() * preguntasDisponibles.length)];
            
            // Actualizar UI
            document.getElementById('competencia-actual-tag').innerHTML = `
                ${rutaDuolingo.find(r => r.codigo === competenciaActualDuolingo).tipo} ${competenciaActualDuolingo} 
                ${rutaDuolingo.find(r => r.codigo === competenciaActualDuolingo).nombre}
            `;
            
            const nivelesEtiqueta = { conceptual: 'üü¢ Conceptual', aplicado: 'üü° Aplicado', normativo: 'üî¥ Normativo' };
            document.getElementById('nivel-pregunta-tag').textContent = nivelesEtiqueta[nivelPregunta];
            
            document.getElementById('progreso-pregunta').textContent = 
                `Pregunta ${estado.preguntasDominadas.length + 1}/5 para dominar`;
            
            // Renderizar pregunta
            let html = `
                <div class="pregunta-card">
                    <p class="text-lg font-medium mb-6">${pregunta.texto}</p>
                    <div class="space-y-3 mb-6">
            `;
            
            pregunta.opciones.forEach((op, idx) => {
                html += `
                    <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer transition"
                           onclick="seleccionarOpcionDuolingo(this, ${idx}, '${pregunta.id}')">
                        <span class="w-6 h-6 rounded-full border-2 flex items-center justify-center font-bold text-sm">
                            ${String.fromCharCode(65 + idx)}
                        </span>
                        <span class="flex-1">${op.texto}</span>
                    </label>
                `;
            });
            
            html += `
                    </div>
                    <button id="btn-responder-duolingo" onclick="responderPreguntaDuolingo()" 
                            class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 
                                   disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Verificar respuesta
                    </button>
                </div>
                <div id="feedback-duolingo" class="hidden mt-4"></div>
            `;
            
            document.getElementById('pregunta-container').innerHTML = html;
            window.preguntaActualDuolingo = pregunta;
        }

        // Seleccionar opci√≥n
        function seleccionarOpcionDuolingo(label, idx, preguntaId) {
            document.querySelectorAll('#pregunta-container label').forEach(l => {
                l.classList.remove('bg-blue-100', 'border-blue-500');
                l.querySelector('span:first-child').classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            });
            
            label.classList.add('bg-blue-100', 'border-blue-500');
            label.querySelector('span:first-child').classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            
            document.getElementById('btn-responder-duolingo').disabled = false;
            window.opcionSeleccionadaDuolingo = idx;
        }

        // Responder pregunta
        function responderPreguntaDuolingo() {
            if (window.opcionSeleccionadaDuolingo === undefined) return;
            
            const pregunta = window.preguntaActualDuolingo;
            const opcionElegida = pregunta.opciones[window.opcionSeleccionadaDuolingo];
            const estado = estadoDuolingo[competenciaActualDuolingo];
            
            const esCorrecta = opcionElegida.correcta;
            
            // Actualizar estado
            estado.preguntasRespondidas.push(pregunta.id);
            
            if (esCorrecta) {
                estado.preguntasDominadas.push(pregunta.id);
                estado.correctasConsecutivas++;
                estado.xp += XP_VALORES[pregunta.nivel];
                progresoGlobal.xpTotal += XP_VALORES[pregunta.nivel];
                
                // Actualizar porcentaje
                estado.porcentaje = (estado.preguntasDominadas.length / Math.max(estado.preguntasRespondidas.length, 1)) * 100;
            } else {
                estado.vidas--;
                estado.correctasConsecutivas = 0;
                
                // Actualizar porcentaje
                estado.porcentaje = (estado.preguntasDominadas.length / estado.preguntasRespondidas.length) * 100;
            }
            
            // Guardar
            localStorage.setItem('estadoDuolingo', JSON.stringify(estadoDuolingo));
            localStorage.setItem('progresoGlobal', JSON.stringify(progresoGlobal));
            
            // Mostrar feedback
            const feedback = document.getElementById('feedback-duolingo');
            let html = `
                <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 ${esCorrecta ? 'border-green-500' : 'border-red-500'}">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">${esCorrecta ? '‚úÖ' : '‚ùå'}</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-2">${esCorrecta ? '¬°Correcto!' : 'Incorrecto'}</h4>
            `;
            
            if (esCorrecta) {
                html += `
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <p class="font-medium text-green-800 mb-2">‚öñÔ∏è Fundamento:</p>
                        <p>${opcionElegida.fundamento}</p>
                    </div>
                `;
            } else {
                // Encontrar opci√≥n correcta
                const correcta = pregunta.opciones.find(o => o.correcta);
                html += `
                    <div class="bg-red-50 p-4 rounded-lg mb-4">
                        <p class="font-medium text-red-800 mb-2">‚ùå Error com√∫n:</p>
                        <p>${opcionElegida.errorComun}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="font-medium text-green-800 mb-2">‚úÖ Respuesta correcta:</p>
                        <p>${correcta.texto}</p>
                        <p class="text-sm mt-2">${correcta.fundamento}</p>
                    </div>
                `;
            }
            
            html += `
                            <button onclick="siguientePreguntaDuolingo()" 
                                    class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">
                                Continuar ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            feedback.innerHTML = html;
            feedback.classList.remove('hidden');
            
            // Deshabilitar bot√≥n
            document.getElementById('btn-responder-duolingo').disabled = true;
            
            // Actualizar UI
            actualizarUIDuolingo();
            renderizarRutaDuolingo();
            
            // Verificar si puede desbloquear siguiente
            if (estado.preguntasDominadas.length >= 5 && estado.porcentaje >= 80 && estado.correctasConsecutivas >= 2) {
                const index = rutaDuolingo.findIndex(r => r.codigo === competenciaActualDuolingo);
                if (index < rutaDuolingo.length - 1) {
                    rutaDuolingo[index + 1].estado = 'disponible';
                }
            }
            
            // Verificar vidas
            if (estado.vidas <= 0) {
                // Modo refuerzo
                alert('üîÑ Modo refuerzo activado. Revise la teor√≠a antes de continuar.');
                estado.vidas = 3;
                estado.modoRefuerzo = true;
            }
        }

        function siguientePreguntaDuolingo() {
            cargarPreguntaDuolingo();
        }

        // ============================================
        // FUNCIONES DEL SISTEMA ACTUAL (INICIO)
        // ============================================
        
        // Carga de PDFs
        document.getElementById('carga-docs').addEventListener('change', async function(e) {
            const archivos = Array.from(e.target.files);
            documentos = [];
            const listaDiv = document.getElementById('lista-docs');
            const progresoDiv = document.getElementById('progreso-carga');
            listaDiv.innerHTML = '';
            
            for (let i = 0; i < archivos.length; i++) {
                const archivo = archivos[i];
                progresoDiv.innerHTML = `Procesando ${i+1}/${archivos.length}: ${archivo.name}...`;
                
                try {
                    let contenido = '';
                    if (archivo.name.toLowerCase().endsWith('.pdf')) {
                        const arrayBuffer = await archivo.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        for (let j = 1; j <= pdf.numPages; j++) {
                            const page = await pdf.getPage(j);
                            const content = await page.getTextContent();
                            contenido += content.items.map(item => item.str).join(' ') + ' ';
                        }
                    } else {
                        contenido = await archivo.text();
                    }
                    
                    contenido = contenido.toLowerCase().replace(/[^\w\s√°√©√≠√≥√∫√±√º]/g, ' ').replace(/\s+/g, ' ');
                    
                    documentos.push({
                        nombre: archivo.name,
                        contenido: contenido
                    });
                    
                    listaDiv.innerHTML += `<div class="py-1 border-b text-xs">üìÑ ${archivo.name} cargado</div>`;
                } catch (error) {
                    listaDiv.innerHTML += `<div class="py-1 text-red-600">‚ùå Error con ${archivo.name}</div>`;
                }
            }
            
            listaDiv.classList.remove('hidden');
            progresoDiv.innerHTML = `‚úÖ ${documentos.length} documentos procesados`;
        });

        // Renderizar competencias en inicio
        function renderizarCompetenciasInicio() {
            const perfil = perfilesMEP[estratoActual];
            let html = '';
            
            perfil.competencias.forEach(comp => {
                html += `
                    <div class="p-3 bg-slate-50 rounded-lg border-l-4 border-blue-500">
                        <span class="text-xs font-mono ${comp.saber ? 'bg-blue-200' : 'bg-green-200'} px-2 py-1 rounded-full">
                            ${comp.saber ? 'SABER' : 'HACER'}
                        </span>
                        <span class="font-medium block mt-1">${comp.codigo} ${comp.nombre}</span>
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${comp.indicadores.map(i => `<span class="text-xs bg-white px-2 py-1 rounded-full">‚úì ${i}</span>`).join('')}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('competencias-container').innerHTML = html;
            
            // Llenar selector
            const select = document.getElementById('selector-competencia-inicio');
            select.innerHTML = '<option value="">Cualquier competencia</option>';
            perfil.competencias.forEach(comp => {
                select.innerHTML += `<option value="${comp.codigo}">${comp.codigo} - ${comp.nombre}</option>`;
            });
        }

        // Selector de estrato en inicio
        document.querySelectorAll('#selector-estrato-inicio .estrato-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#selector-estrato-inicio .estrato-btn').forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-slate-100');
                });
                this.classList.remove('bg-slate-100');
                this.classList.add('bg-blue-600', 'text-white');
                
                estratoActual = this.dataset.estrato;
                renderizarCompetenciasInicio();
            });
        });

        // Generar pregunta en inicio
        document.getElementById('btn-generar-inicio').addEventListener('click', function() {
            if (documentos.length === 0) {
                alert('Primero cargue documentos');
                return;
            }
            
            const competenciaElegida = document.getElementById('selector-competencia-inicio').value;
            
            // Simular pregunta
            const preguntaSimulada = {
                texto: 'Pregunta de ejemplo basada en sus documentos. La versi√≥n completa tendr√≠a preguntas reales del banco.',
                opciones: ['Opci√≥n A', 'Opci√≥n B', 'Opci√≥n C', 'Opci√≥n D'],
                correcta: 0
            };
            
            const html = `
                <div class="bg-white p-4 rounded-lg border">
                    <p class="font-medium mb-3">${preguntaSimulada.texto}</p>
                    <div class="space-y-2">
                        ${preguntaSimulada.opciones.map((opt, idx) => `
                            <div class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded">
                                <input type="radio" name="practica" value="${idx}">
                                <span>${opt}</span>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Documento: ejemplo.pdf</p>
                </div>
            `;
            
            document.getElementById('simulador-inicio').innerHTML = html;
        });

        // Inicializar
        renderizarCompetenciasInicio();
        renderizarRutaDuolingo();
        renderizarMedallas();
        actualizarUIDuolingo();
    </script>
</body>
</html>
