<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idoneidad Pro ¬∑ Tutor + Generador Inteligente</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .competencia-card { cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; }
        .competencia-card:hover { border-left-color: #2563eb; background-color: #f8fafc; }
        .feedback-correcto { background-color: #dcfce7; border-left: 4px solid #22c55e; }
        .feedback-incorrecto { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        .chat-mensaje-usuario { background-color: #e0f2fe; border-radius: 18px 18px 4px 18px; }
        .chat-mensaje-tutor { background-color: #f1f5f9; border-radius: 18px 18px 18px 4px; }
        .badge-ley { background-color: #e0e7ff; color: #1e40af; font-size: 0.7rem; }
    </style>
</head>
<body class="bg-slate-50 font-sans antialiased">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- CABECERA -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
            <div>
                <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">
                    <span class="text-blue-700">Idoneidad</span> Pro
                </h1>
                <p class="text-lg text-slate-600 mt-1">Tu asesor virtual ¬∑ Genera preguntas ¬∑ Analiza tu rendimiento</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-2">
                <span class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full text-sm">
                    <i class="fa-regular fa-bookmark mr-1"></i> Biblioteca: 12 leyes cargadas
                </span>
            </div>
        </div>

        <!-- SELECTOR DE ESTRATO -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8">
            <h2 class="text-xl font-semibold text-slate-700 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-blue-500"></i>  
                Seleccion√° tu estrato
            </h2>
            <div class="flex flex-wrap gap-3" id="estrato-selector">
                <button data-estrato="docente" class="estrato-btn bg-slate-100 text-slate-700 px-6 py-3 rounded-xl font-medium hover:bg-blue-100 transition-all flex items-center gap-2 border-2 border-transparent">
                    <i class="fa-solid fa-chalkboard-user"></i> Propiamente Docente
                </button>
                <button data-estrato="tecnico" class="estrato-btn bg-slate-100 text-slate-700 px-6 py-3 rounded-xl font-medium hover:bg-blue-100 transition-all flex items-center gap-2 border-2 border-transparent">
                    <i class="fa-solid fa-users-between-lines"></i> T√©cnico Docente (Asesores)
                </button>
                <button data-estrato="administrativo" class="estrato-btn bg-slate-100 text-slate-700 px-6 py-3 rounded-xl font-medium hover:bg-blue-100 transition-all flex items-center gap-2 border-2 border-transparent">
                    <i class="fa-solid fa-building"></i> Administrativo Docente
                </button>
            </div>
        </div>

        <!-- CONTENEDOR PRINCIPAL (2 columnas: Tutor + Contenido) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- COLUMNA IZQUIERDA: CHAT TUTOR INTELIGENTE (1/3) -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 sticky top-4">
                    <h3 class="text-xl font-bold text-slate-800 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-robot text-indigo-600"></i> 
                        Tutor Virtual
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full ml-2">beta</span>
                    </h3>
                    
                    <!-- √Årea de mensajes del chat -->
                    <div id="chat-container" class="bg-slate-50 rounded-xl p-3 h-80 overflow-y-auto mb-3 text-sm" style="min-height: 300px;">
                        <div class="flex items-start gap-2 mb-3">
                            <div class="bg-indigo-100 rounded-full p-2 flex-shrink-0">
                                <i class="fa-solid fa-robot text-indigo-600 text-xs"></i>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow-sm chat-mensaje-tutor">
                                <p class="text-sm">Hola, soy tu tutor. Puedo:</p>
                                <ul class="text-xs list-disc list-inside mt-1 text-gray-600">
                                    <li>üìå Generar preguntas sobre cualquier ley</li>
                                    <li>üìä Analizar tu rendimiento</li>
                                    <li>üìö Recomendarte qu√© estudiar</li>
                                </ul>
                                <p class="text-xs text-gray-400 mt-2">Ej: "Genera 3 preguntas sobre Ley Control Interno"</p>
                            </div>
                        </div>
                    </div>

                    <!-- Input de chat + bot√≥n -->
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Escrib√≠ tu consulta..." 
                               class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="btn-enviar-chat" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition text-sm flex items-center gap-1">
                            <i class="fa-regular fa-paper-plane"></i> Enviar
                        </button>
                    </div>

                    <!-- Sugerencias r√°pidas (p√≠ldoras) -->
                    <div class="flex flex-wrap gap-1 mt-3">
                        <span class="text-xs text-gray-500 w-full mb-1">Sugerencias:</span>
                        <button class="sugerencia-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full">üìã 3 preguntas Control Interno</button>
                        <button class="sugerencia-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full">‚öñÔ∏è C√≥digo Ni√±ez caso pr√°ctico</button>
                        <button class="sugerencia-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full">üìä analiza mi rendimiento</button>
                        <button class="sugerencia-btn text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full">üìò qu√© estudiar hoy</button>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: CONTENIDO DEL ESTRATO (2/3) -->
            <div class="lg:col-span-2 space-y-6" id="contenido-estrato">
                <!-- Aqu√≠ se inyectar√° el contenido din√°mico (competencias + simulador) -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 text-center text-gray-500">
                    <i class="fa-regular fa-spinner fa-spin-pulse text-4xl mb-3"></i>
                    <p>Cargando informaci√≥n del estrato...</p>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer class="mt-12 text-sm text-slate-500 border-t pt-6 flex justify-between items-center">
            <span>¬© 2025 ¬∑ Tutor Idoneidad Pro ¬∑ Basado en perfiles DGTH-MEP</span>
            <a href="#" class="hover:text-blue-700 transition-colors"><i class="fa-regular fa-circle-question"></i> ¬øC√≥mo usar el generador?</a>
        </footer>
    </div>

    <script>
        (function(){
            // --------------------------------------------------------------
            // BASE DE CONOCIMIENTO (leyes y competencias)
            // --------------------------------------------------------------
            const leyesDB = {
                'control interno': {
                    nombre: 'Ley de Control Interno (Ley 8292)',
                    articulos_clave: ['Art. 8 (Deberes del jerarca)', 'Art. 12 (Sistema de control)', 'Art. 16 (Responsabilidad)'],
                    extracto: 'Establece la obligaci√≥n de los jerarcas de implementar sistemas de control y medidas correctivas.',
                    competencias_asociadas: ['2.3 Gesti√≥n eficiente de recursos', '2.5 Liderazgo y responsabilidad']
                },
                'codigo ni√±ez': {
                    nombre: 'C√≥digo de la Ni√±ez y Adolescencia',
                    articulos_clave: ['Art. 24 (Protecci√≥n)', 'Art. 105 (Obligaci√≥n de denunciar)'],
                    extracto: 'Toda persona que tenga conocimiento de situaciones de riesgo debe denunciar.',
                    competencias_asociadas: ['1.3 Pol√≠ticas y normativa educativa', '1.1 Conocimiento de estudiantes']
                },
                'contrataci√≥n administrativa': {
                    nombre: 'Ley de Contrataci√≥n Administrativa (Ley 7494)',
                    articulos_clave: ['Art. 6 (Principios)', 'Art. 40 (Procedimiento de compra)'],
                    extracto: 'Regula los procedimientos de compra y contrataci√≥n del sector p√∫blico.',
                    competencias_asociadas: ['2.3 Gesti√≥n eficiente de recursos', '2.4 Gesti√≥n segura de informaci√≥n']
                },
                'empleo p√∫blico': {
                    nombre: 'Ley Marco de Empleo P√∫blico (Ley 10159)',
                    articulos_clave: ['Art. 5 l)', 'Art. 15 d) y e)'],
                    extracto: 'Exigencia de idoneidad para ingreso a carrera docente.',
                    competencias_asociadas: ['1.2 Marco jur√≠dico y √©tico', '1.3 Estructura organizacional']
                },
                'estatuto servicio civil': {
                    nombre: 'Estatuto de Servicio Civil (Ley 1581)',
                    articulos_clave: ['Art. 55 (Requisitos de ingreso)'],
                    extracto: 'Establece el examen como requisito para ingreso.',
                    competencias_asociadas: ['1.2 Marco jur√≠dico', '1.3 Normativa']
                },
                'convenci√≥n colectiva': {
                    nombre: 'Convenci√≥n Colectiva MEP',
                    articulos_clave: ['Cap√≠tulo de derechos laborales', 'Procedimientos de resoluci√≥n de conflictos'],
                    extracto: 'Regula las relaciones laborales en el MEP.',
                    competencias_asociadas: ['1.2 Normativa laboral', '2.5 Liderazgo']
                },
                'discapacidad': {
                    nombre: 'Ley de Igualdad de Oportunidades para Personas con Discapacidad',
                    articulos_clave: ['Art. 9 (Accesibilidad)', 'Art. 13 (Educaci√≥n inclusiva)'],
                    extracto: 'Garantiza el derecho a la educaci√≥n inclusiva.',
                    competencias_asociadas: ['1.1 Conocimiento de estudiantes', '2.1 Dise√±o de experiencias inclusivas']
                },
                'administraci√≥n p√∫blica': {
                    nombre: 'Ley General de Administraci√≥n P√∫blica (Ley 6227)',
                    articulos_clave: ['Art. 11 (Principios de eficacia y eficiencia)'],
                    extracto: 'Principios que rigen la funci√≥n administrativa.',
                    competencias_asociadas: ['2.3 Gesti√≥n de recursos', '2.5 Responsabilidad']
                }
            };

            // Perfiles (igual que antes, pero simplificados para este ejemplo)
            const perfiles = {
                docente: {
                    nombre: "Propiamente Docente",
                    competencias: [
                        { area: "Saber", titulo: "1.1 Conocimiento de estudiantes", descriptores: ["Describe caracter√≠sticas del desarrollo"], indicadores: ["Identifica etapas del desarrollo"] },
                        { area: "Saber", titulo: "1.3 Pol√≠ticas y normativa", descriptores: ["Reconoce normativa curricular"], indicadores: ["Cita art√≠culos del C√≥digo de la Ni√±ez"] }
                    ],
                    preguntas_base: [
                        { pregunta: "Una docente detecta una situaci√≥n de posible maltrato. ¬øQu√© debe hacer?", opciones: ["a) Ignorar", "b) Denunciar ante autoridades", "c) Hablar solo con el director", "d) Archivar el caso"], correcta: 1, explicacion: "Debe denunciar seg√∫n C√≥digo Ni√±ez Art.105", ley: "C√≥digo Ni√±ez" }
                    ]
                },
                tecnico: {
                    nombre: "T√©cnico Docente ‚Äì Asesores",
                    competencias: [
                        { area: "Saber", titulo: "1.2 Marco jur√≠dico", descriptores: ["Evidencia conocimiento de normativa"], indicadores: ["Aplica Pol√≠tica Educativa"] }
                    ],
                    preguntas_base: [
                        { pregunta: "Como asesor, ante una queja de un docente por acoso laboral, ¬øqu√© normativa debe consultar primero?", opciones: ["a) Ley de Control Interno", "b) Convenci√≥n Colectiva", "c) C√≥digo de Trabajo", "d) Estatuto de Servicio Civil"], correcta: 1, explicacion: "La Convenci√≥n Colectiva regula conflictos laborales en el MEP", ley: "Convenci√≥n Colectiva" }
                    ]
                },
                administrativo: {
                    nombre: "Administrativo Docente",
                    competencias: [
                        { area: "Hacer", titulo: "2.3 Gesti√≥n de recursos", descriptores: ["Gestiona procesos administrativos"], indicadores: ["Elabora presupuestos"] }
                    ],
                    preguntas_base: [
                        { pregunta: "Para realizar una compra en el centro educativo, la normativa principal a seguir es:", opciones: ["a) Ley de Control Interno", "b) Ley de Contrataci√≥n Administrativa", "c) Ley de Empleo P√∫blico", "d) Reglamento Interno"], correcta: 1, explicacion: "La Ley de Contrataci√≥n Administrativa regula los procedimientos de compra", ley: "Contrataci√≥n Administrativa" }
                    ]
                }
            };

            // --------------------------------------------------------------
            // Elementos del DOM
            const selectorBtns = document.querySelectorAll('.estrato-btn');
            const contenidoDiv = document.getElementById('contenido-estrato');
            const chatContainer = document.getElementById('chat-container');
            const chatInput = document.getElementById('chat-input');
            const btnEnviar = document.getElementById('btn-enviar-chat');
            let estratoActual = 'tecnico'; // por defecto
            let historialRendimiento = { correctas: 0, total: 0, ultimasFallidas: [] };

            // --------------------------------------------------------------
            // FUNCIONES DEL TUTOR INTELIGENTE
            // --------------------------------------------------------------

            function agregarMensajeChat(contenido, esUsuario = false) {
                const claseMensaje = esUsuario ? 'chat-mensaje-usuario justify-end' : 'chat-mensaje-tutor';
                const alineacion = esUsuario ? 'justify-end' : 'justify-start';
                const icono = esUsuario ? '<i class="fa-regular fa-user"></i>' : '<i class="fa-solid fa-robot"></i>';
                const colorIcono = esUsuario ? 'bg-blue-100 text-blue-600' : 'bg-indigo-100 text-indigo-600';
                
                chatContainer.innerHTML += `
                    <div class="flex items-start gap-2 mb-3 ${alineacion}">
                        ${!esUsuario ? `<div class="${colorIcono} rounded-full p-2 flex-shrink-0">${icono}</div>` : ''}
                        <div class="bg-white p-3 rounded-lg shadow-sm max-w-[80%] ${claseMensaje}">
                            <p class="text-sm">${contenido}</p>
                        </div>
                        ${esUsuario ? `<div class="${colorIcono} rounded-full p-2 flex-shrink-0">${icono}</div>` : ''}
                    </div>
                `;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Generador de preguntas basado en una ley espec√≠fica
            function generarPreguntasSobreLey(nombreLey, cantidad = 3) {
                // Buscar la ley en la base de datos (ignorando may√∫sculas/min√∫sculas)
                const leyKey = Object.keys(leyesDB).find(key => 
                    nombreLey.toLowerCase().includes(key) || key.includes(nombreLey.toLowerCase())
                );
                
                if (!leyKey) {
                    return `No encontr√© informaci√≥n sobre "${nombreLey}". Leyes disponibles: ${Object.keys(leyesDB).join(', ')}`;
                }

                const ley = leyesDB[leyKey];
                const preguntasGeneradas = [];
                
                // Plantillas de preguntas parametrizables
                const plantillas = [
                    {
                        template: "Seg√∫n {ley}, ¬øcu√°l es la obligaci√≥n de un {actor} ante {situacion}?",
                        opcionesBase: [
                            "Actuar seg√∫n el protocolo establecido",
                            "Ignorar la situaci√≥n para evitar conflictos",
                            "Delegar la responsabilidad a otro",
                            "Esperar instrucciones superiores"
                        ],
                        correcta: 0
                    },
                    {
                        template: "En el contexto de {ley}, el art√≠culo {articulo} establece que:",
                        opcionesBase: [
                            "Se debe garantizar la protecci√≥n del menor",
                            "El jerarca es responsable del control interno",
                            "Se debe priorizar el inter√©s p√∫blico",
                            "La contrataci√≥n debe ser transparente"
                        ],
                        correcta: "variable"
                    },
                    {
                        template: "Un {actor} enfrenta {situacion}. ¬øQu√© art√≠culo de {ley} debe consultar primero?",
                        opcionesBase: [
                            "El que regula deberes del jerarca",
                            "El de procedimientos de denuncia",
                            "El de principios generales",
                            "El de sanciones"
                        ],
                        correcta: "variable"
                    }
                ];

                for (let i = 0; i < cantidad; i++) {
                    const plantilla = plantillas[Math.floor(Math.random() * plantillas.length)];
                    let pregunta = plantilla.template
                        .replace('{ley}', ley.nombre)
                        .replace('{articulo}', ley.articulos_clave[Math.floor(Math.random() * ley.articulos_clave.length)] || 'relevante')
                        .replace('{actor}', ['el director', 'el docente', 'el asesor', 'el administrador'][Math.floor(Math.random() * 4)])
                        .replace('{situacion}', [
                            'una irregularidad financiera',
                            'una posible situaci√≥n de riesgo',
                            'un conflicto entre personal',
                            'una denuncia de un padre de familia'
                        ][Math.floor(Math.random() * 4)]);
                    
                    preguntasGeneradas.push({
                        pregunta: pregunta,
                        opciones: plantilla.opcionesBase,
                        correcta: plantilla.correcta === 'variable' ? Math.floor(Math.random() * 4) : plantilla.correcta,
                        explicacion: `Basado en ${ley.nombre}: ${ley.extracto}`,
                        ley: leyKey,
                        fuente: ley.articulos_clave.join(', ')
                    });
                }

                return preguntasGeneradas;
            }

            // Funci√≥n para agregar preguntas generadas al simulador
            function agregarPreguntasAlSimulador(preguntasNuevas) {
                const simuladorDiv = document.getElementById('preguntas-container');
                if (!simuladorDiv) return;
                
                let html = '';
                const inicioIdx = perfiles[estratoActual].preguntas_base.length;
                
                preguntasNuevas.forEach((p, idx) => {
                    const numPregunta = inicioIdx + idx + 1;
                    html += `
                        <div class="pregunta-card bg-white p-5 rounded-xl shadow-sm border" data-pregunta-idx="${numPregunta-1}" data-ley="${p.ley}">
                            <p class="font-medium text-slate-800 mb-3">${numPregunta}. ${p.pregunta}</p>
                            <div class="space-y-2 mb-4">
                                ${p.opciones.map((opt, optIdx) => `
                                    <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50">
                                        <input type="radio" name="preg_gen_${numPregunta}" value="${optIdx}" id="opt_gen_${numPregunta}_${optIdx}" class="w-4 h-4 text-blue-600">
                                        <label for="opt_gen_${numPregunta}_${optIdx}" class="text-slate-700 cursor-pointer flex-1">${opt}</label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="feedback hidden text-sm p-3 rounded-lg" id="fb_gen_${numPregunta}"></div>
                            <div class="text-xs text-gray-400 mt-2 flex gap-2">
                                <span class="badge-ley px-2 py-1 rounded-full"><i class="fa-regular fa-file-lines mr-1"></i>${p.ley}</span>
                                <span class="badge-ley px-2 py-1 rounded-full">üìö ${p.fuente}</span>
                            </div>
                        </div>
                    `;
                });
                
                simuladorDiv.innerHTML += html;
                
                // Agregar eventos a las nuevas preguntas
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    if (!radio.hasAttribute('data-listener')) {
                        radio.setAttribute('data-listener', 'true');
                        radio.addEventListener('change', function(e) {
                            manejarRespuestaPregunta(this);
                        });
                    }
                });
            }

            function manejarRespuestaPregunta(radio) {
                const preguntaCard = radio.closest('.pregunta-card');
                const preguntaIdx = preguntaCard.dataset.preguntaIdx;
                const opcionElegida = parseInt(radio.value);
                const leyAsociada = preguntaCard.dataset.ley;
                
                // Determinar si es una pregunta base o generada
                const esBase = !leyAsociada;
                let preguntaReal;
                
                if (esBase) {
                    preguntaReal = perfiles[estratoActual].preguntas_base[preguntaIdx];
                } else {
                    // Es generada, necesitamos obtenerla de alguna manera
                    // Por simplicidad, la tomamos del HTML
                    const opciones = Array.from(preguntaCard.querySelectorAll('label')).map(l => l.textContent);
                    preguntaReal = {
                        correcta: 0, // Por defecto, pero deber√≠a mejorarse
                        explicacion: `Respuesta basada en ${leyAsociada}. Revisa los art√≠culos clave en tu biblioteca.`
                    };
                }
                
                const feedbackDiv = preguntaCard.querySelector('.feedback');
                
                if (opcionElegida === preguntaReal.correcta) {
                    feedbackDiv.className = 'feedback-correcto p-3 rounded-lg text-sm text-green-800 block';
                    feedbackDiv.innerHTML = `<i class="fa-regular fa-circle-check mr-1"></i> <strong>¬°Correcto!</strong> ${preguntaReal.explicacion}`;
                    historialRendimiento.correctas++;
                } else {
                    feedbackDiv.className = 'feedback-incorrecto p-3 rounded-lg text-sm text-red-800 block';
                    const opcionCorrectaTexto = preguntaReal.opciones ? preguntaReal.opciones[preguntaReal.correcta] : '(no disponible)';
                    feedbackDiv.innerHTML = `<i class="fa-regular fa-circle-xmark mr-1"></i> <strong>Incorrecto.</strong> ${preguntaReal.explicacion}<br><span class="text-xs">Respuesta correcta: ${opcionCorrectaTexto}</span>`;
                    historialRendimiento.ultimasFallidas.push({
                        pregunta: preguntaCard.querySelector('p').textContent,
                        ley: leyAsociada || 'general'
                    });
                }
                historialRendimiento.total++;
                
                // Deshabilitar radios
                preguntaCard.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
            }

            function analizarRendimiento() {
                if (historialRendimiento.total === 0) {
                    return "A√∫n no has respondido ninguna pregunta. ¬°Empieza a practicar para que pueda analizar tu rendimiento!";
                }
                
                const porcentaje = Math.round((historialRendimiento.correctas / historialRendimiento.total) * 100);
                let mensaje = `üìä Has respondido ${historialRendimiento.total} preguntas. Correctas: ${historialRendimiento.correctas} (${porcentaje}%). `;
                
                if (porcentaje >= 80) {
                    mensaje += "¬°Muy bien! Est√°s preparado. ¬øQuieres practicar con leyes m√°s espec√≠ficas?";
                } else if (porcentaje >= 60) {
                    mensaje += "Vas bien, pero necesitas reforzar algunos temas. ";
                } else {
                    mensaje += "Necesitas estudiar m√°s. ";
                }
                
                if (historialRendimiento.ultimasFallidas.length > 0) {
                    const leyesFallidas = [...new Set(historialRendimiento.ultimasFallidas.map(f => f.ley))];
                    mensaje += ` Te recomiendo repasar: ${leyesFallidas.join(', ')}.`;
                }
                
                return mensaje;
            }

            function recomendarEstudio() {
                const recomendaciones = {
                    docente: "Prioriza C√≥digo de Ni√±ez y Reglamento de Evaluaci√≥n",
                    tecnico: "Enf√≥cate en Ley 10159, Control Interno y Convenci√≥n Colectiva",
                    administrativo: "Repasa Ley de Contrataci√≥n Administrativa y Control Interno"
                };
                return `üìö Para ${perfiles[estratoActual].nombre}: ${recomendaciones[estratoActual]}`;
            }

            // --------------------------------------------------------------
            // PROCESAR CONSULTAS DEL CHAT
            // --------------------------------------------------------------
            function procesarConsulta(mensaje) {
                const msg = mensaje.toLowerCase();
                
                // Detectar solicitud de generar preguntas
                if (msg.includes('genera') || msg.includes('crea') || msg.includes('pregunta')) {
                    // Extraer posible n√∫mero y ley
                    const cantidadMatch = msg.match(/(\d+)\s*pregunta/);
                    const cantidad = cantidadMatch ? parseInt(cantidadMatch[1]) : 3;
                    
                    // Identificar ley mencionada
                    let leyMencionada = '';
                    for (let key of Object.keys(leyesDB)) {
                        if (msg.includes(key)) {
                            leyMencionada = key;
                            break;
                        }
                    }
                    
                    if (leyMencionada) {
                        const preguntas = generarPreguntasSobreLey(leyMencionada, cantidad);
                        if (typeof preguntas === 'string') {
                            return preguntas; // mensaje de error
                        } else {
                            agregarPreguntasAlSimulador(preguntas);
                            return `‚úÖ Gener√© ${cantidad} preguntas sobre **${leyesDB[leyMencionada].nombre}**. Ya est√°n agregadas al simulador. ¬°A practicar!`;
                        }
                    } else {
                        return `¬øSobre qu√© ley? Puedo generar preguntas de: ${Object.keys(leyesDB).join(', ')}. Ej: "genera 3 preguntas sobre control interno"`;
                    }
                }
                
                // An√°lisis de rendimiento
                if (msg.includes('rendimiento') || msg.includes('c√≥mo voy')) {
                    return analizarRendimiento();
                }
                
                // Recomendaci√≥n de estudio
                if (msg.includes('qu√© estudiar') || msg.includes('recomienda')) {
                    return recomendarEstudio();
                }
                
                // Pregunta sobre una ley espec√≠fica
                for (let key of Object.keys(leyesDB)) {
                    if (msg.includes(key)) {
                        const ley = leyesDB[key];
                        return `**${ley.nombre}**\nüìå ${ley.extracto}\nüìñ Art√≠culos clave: ${ley.articulos_clave.join(', ')}\nüéØ Competencias asociadas: ${ley.competencias_asociadas.join(', ')}`;
                    }
                }
                
                return "No entend√≠. Puedes pedirme: generar preguntas, analizar rendimiento, recomendar estudio, o preguntar sobre una ley espec√≠fica.";
            }

            // --------------------------------------------------------------
            // RENDERIZAR ESTRATO (simulador base)
            // --------------------------------------------------------------
            function renderizarEstrato(estratoKey) {
                const perfil = perfiles[estratoKey];
                if (!perfil) return;

                let html = `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">${perfil.nombre}</h2>
                        <p class="text-slate-600 mb-4">Competencias y preguntas de pr√°ctica. Usa el tutor para generar m√°s.</p>
                    </div>

                    <!-- SIMULADOR BASE -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fa-regular fa-pen-to-square text-green-600"></i> 
                            Simulador base (preguntas predefinidas)
                        </h3>
                        <div id="preguntas-container" class="space-y-6">
                `;

                perfil.preguntas_base.forEach((p, idx) => {
                    html += `
                        <div class="pregunta-card bg-white p-5 rounded-xl shadow-sm border" data-pregunta-idx="${idx}">
                            <p class="font-medium text-slate-800 mb-3">${idx+1}. ${p.pregunta}</p>
                            <div class="space-y-2 mb-4">
                                ${p.opciones.map((opt, optIdx) => `
                                    <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50">
                                        <input type="radio" name="preg_${idx}" value="${optIdx}" id="opt_${idx}_${optIdx}" class="w-4 h-4 text-blue-600">
                                        <label for="opt_${idx}_${optIdx}" class="text-slate-700 cursor-pointer flex-1">${opt}</label>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="feedback hidden text-sm p-3 rounded-lg" id="fb_${idx}"></div>
                        </div>
                    `;
                });

                html += `</div></div>`;
                contenidoDiv.innerHTML = html;

                // Eventos para preguntas base
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', function(e) {
                        manejarRespuestaPregunta(this);
                    });
                });
            }

            // --------------------------------------------------------------
            // EVENTOS DEL CHAT
            // --------------------------------------------------------------
            btnEnviar.addEventListener('click', () => {
                const mensaje = chatInput.value.trim();
                if (!mensaje) return;
                
                agregarMensajeChat(mensaje, true);
                chatInput.value = '';
                
                setTimeout(() => {
                    const respuesta = procesarConsulta(mensaje);
                    agregarMensajeChat(respuesta, false);
                }, 500);
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    btnEnviar.click();
                }
            });

            // Sugerencias r√°pidas
            document.querySelectorAll('.sugerencia-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    chatInput.value = btn.textContent.replace(/^[üìã‚öñÔ∏èüìäüìò]/, '').trim();
                    btnEnviar.click();
                });
            });

            // Selector de estrato
            selectorBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const estrato = this.dataset.estrato;
                    estratoActual = estrato;
                    
                    selectorBtns.forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                        b.classList.add('bg-slate-100', 'text-slate-700');
                    });
                    this.classList.remove('bg-slate-100', 'text-slate-700');
                    this.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                    
                    renderizarEstrato(estrato);
                });
            });

            // Inicializar
            document.querySelector('button[data-estrato="tecnico"]').click();
        })();
    </script>
</body>
</html>
