<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì IDOMEP v3.0 ¬∑ Calidad Profesional</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Mammoth.js para DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <style>
        body { background: #f0f9ff; font-family: system-ui, sans-serif; }
        .card { background: white; border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .ruta-item { transition: all 0.3s; cursor: pointer; border: 2px solid transparent; }
        .ruta-item.disponible:hover { transform: translateY(-4px); border-color: #3b82f6; }
        .tab-button.active { background: #2563eb; color: white; }
        .calidad-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <!-- BARRA SUPERIOR con indicador de calidad -->
    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b shadow-sm mb-4">
        <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
            <span class="font-bold text-xl">üéì IDOMEP <span class="text-blue-600">v3.0</span> <span class="calidad-badge">CALIDAD PROFESIONAL</span></span>
            <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                <button data-tab="inicio" class="tab-button px-4 py-1.5 rounded-lg text-sm active">üìö Inicio</button>
                <button data-tab="duolingo" class="tab-button px-4 py-1.5 rounded-lg text-sm">üéÆ IdoMep</button>
                <button data-tab="simulador" class="tab-button px-4 py-1.5 rounded-lg text-sm">üìù Simulacro</button>
                <button data-tab="reporte" class="tab-button px-4 py-1.5 rounded-lg text-sm">üìä Progreso</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- ========== TAB INICIO (igual) ========== -->
        <div id="tab-inicio" class="tab-content block">
            <div class="card mb-6 border-l-8 border-blue-600">
                <h2 class="text-2xl font-bold mb-2">üìö Sistema de Estudio MEP</h2>
                <p class="text-gray-600">Cargue sus documentos. El sistema genera preguntas de calidad profesional.</p>
            </div>
            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üéØ Seleccione su estrato</h3>
                <div class="flex flex-wrap gap-3" id="selector-estrato">
                    <button data-estrato="docente" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100">Propiamente Docente</button>
                    <button data-estrato="tecnico" class="estrato-btn px-5 py-2 rounded-full bg-blue-600 text-white">T√©cnico Docente (Asesores)</button>
                    <button data-estrato="administrativo" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100">Administrativo Docente</button>
                </div>
            </div>
            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üìÅ Cargue sus documentos</h3>
                <p class="text-sm text-amber-600 mb-3">üìå Formatos: PDF, DOCX, TXT (sin l√≠mite)</p>
                <input type="file" id="carga-docs" multiple accept=".pdf,.txt,.docx,.doc" class="mb-4 w-full p-2 border rounded-lg">
                <div id="lista-docs" class="text-sm max-h-40 overflow-y-auto bg-slate-50 p-3 rounded-lg hidden"></div>
                <div id="progreso-carga" class="text-xs text-gray-500 mt-2"></div>
            </div>
            <div class="card">
                <h3 class="font-bold text-lg mb-4">üìã Competencias a evaluar</h3>
                <div id="competencias-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- ========== TAB IDOMEP con preguntas de calidad ========== -->
        <div id="tab-duolingo" class="tab-content hidden">
            <!-- Panel XP (igual) -->
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl shadow-xl p-6 mb-6 text-white">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-4xl">üéÆ</span>
                        <div>
                            <h2 class="text-2xl font-black">Ruta de dominio</h2>
                            <p class="text-blue-100">Preguntas de calidad profesional</p>
                        </div>
                    </div>
                    <div class="flex gap-6">
                        <div class="text-center"><span class="text-sm">NIVEL</span><div class="text-2xl font-bold" id="nivel-duolingo">1</div></div>
                        <div class="text-center"><span class="text-sm">RANGO</span><div class="text-lg font-bold" id="rango-duolingo">Bronce</div></div>
                        <div class="text-center"><span class="text-sm">RACHA</span><div class="text-lg font-bold" id="racha-duolingo">0</div></div>
                        <div class="flex text-2xl" id="vidas-duolingo">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm mb-1"><span>XP: <span id="xp-duolingo">0</span></span><span>Siguiente nivel: <span id="xp-siguiente">200</span></span></div>
                    <div class="w-full bg-white/30 h-3 rounded-full overflow-hidden"><div class="bg-yellow-400 h-3 rounded-full" id="barra-xp-duolingo" style="width:0%"></div></div>
                </div>
            </div>

            <!-- Ruta de competencias -->
            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üó∫Ô∏è Ruta de aprendizaje</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="ruta-container"></div>
            </div>

            <!-- Pregunta de ALTA CALIDAD -->
            <div class="card">
                <div id="pregunta-header" class="flex justify-between items-center mb-4">
                    <span class="bg-indigo-100 px-3 py-1 rounded-full text-sm" id="competencia-actual-tag">üìò 1.1 √Årea disciplinar</span>
                    <span class="text-xs text-gray-500" id="nivel-pregunta-tag">üü¢ Conceptual</span>
                </div>
                <div id="pregunta-container" class="min-h-[300px]">
                    <div class="text-center text-gray-500 py-12">Cargue documentos y seleccione una competencia</div>
                </div>
                <!-- Indicador de calidad -->
                <div id="calidad-indicador" class="mt-2 text-right text-xs text-purple-600 hidden">
                    ‚ú® Pregunta dise√±ada con est√°ndares profesionales
                </div>
            </div>
        </div>

        <!-- ========== TAB SIMULADOR (igual) ========== -->
        <div id="tab-simulador" class="tab-content hidden">
            <div class="card mb-6">
                <h2 class="text-2xl font-bold mb-4">üìù Simulacro oficial (60 preguntas)</h2>
                <button id="btn-iniciar-simulacro" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700">Iniciar nuevo simulacro</button>
                <div id="estado-simulacro" class="hidden mb-4 p-4 bg-blue-50 rounded-lg mt-4">
                    <div class="flex justify-between"><span>Progreso: <span id="simulacro-progreso">0/60</span></span><span>Correctas: <span id="simulacro-correctas">0</span></span><span>Nota: <span id="simulacro-nota">0%</span></span></div>
                    <div class="w-full bg-gray-200 h-2 rounded-full mt-2"><div class="bg-blue-600 h-2 rounded-full" id="simulacro-barra" style="width:0%"></div></div>
                </div>
                <div id="simulacro-container" class="min-h-[300px]"></div>
                <div id="resultado-simulador" class="mt-6"></div>
            </div>
        </div>

        <!-- ========== TAB REPORTE ========== -->
        <div id="tab-reporte" class="tab-content hidden">
            <div class="card">
                <h2 class="text-2xl font-bold mb-6">üìä Mi progreso</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div><h3 class="font-bold text-lg mb-4">Rendimiento por competencia</h3><div id="reporte-competencias" class="space-y-4"></div></div>
                    <div><h3 class="font-bold text-lg mb-4">Gr√°fico de dominio</h3><canvas id="radar-competencias" width="300" height="300"></canvas></div>
                </div>
                <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">üìà Estad√≠sticas globales</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="estadisticas-globales"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const VERSION = '3.0';
        const XP_POR_NIVEL = 200;

        // ============================================
        // PERFILES MEP
        // ============================================
        const perfilesMEP = {
            tecnico: {
                nombre: 'T√©cnico Docente (Asesores)',
                competencias: [
                    { codigo: '1.1', nombre: '√Årea disciplinar, pedag√≥gica y curricular', saber: true },
                    { codigo: '1.2', nombre: 'Marco jur√≠dico, √©tico y pol√≠ticas p√∫blicas', saber: true },
                    { codigo: '1.3', nombre: 'Estructura organizacional del MEP', saber: true },
                    { codigo: '2.1', nombre: 'Dise√±o de planes, programas y proyectos', saber: false },
                    { codigo: '2.3', nombre: 'Liderazgo, asesor√≠a y TIC', saber: false }
                ]
            },
            docente: {
                nombre: 'Propiamente Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Conocimiento de estudiantes', saber: true },
                    { codigo: '1.2', nombre: 'Dominio disciplinar', saber: true },
                    { codigo: '1.3', nombre: 'Pol√≠ticas y normativa', saber: true },
                    { codigo: '2.1', nombre: 'Dise√±o de experiencias', saber: false },
                    { codigo: '2.2', nombre: 'Mediaci√≥n pedag√≥gica', saber: false },
                    { codigo: '2.3', nombre: 'Evaluaci√≥n', saber: false }
                ]
            },
            administrativo: {
                nombre: 'Administrativo Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Liderazgo pedag√≥gico', saber: true },
                    { codigo: '1.4', nombre: 'Tecnolog√≠as', saber: true },
                    { codigo: '2.3', nombre: 'Gesti√≥n de recursos', saber: false },
                    { codigo: '2.4', nombre: 'Seguridad informaci√≥n', saber: false },
                    { codigo: '2.5', nombre: 'Liderazgo', saber: false }
                ]
            }
        };

        // ============================================
        // BANCO DE PROMPTS DE ALTA CALIDAD
        // ============================================
        const bancoPromptsCalidad = {
            '1.1': { // √Årea disciplinar y pedag√≥gica
                situaciones: [
                    'Un docente le comenta: "Mis estudiantes aprueban los ex√°menes pero al mes ya no recuerdan nada".',
                    'En una reuni√≥n de ciclo, varios docentes expresan que "los estudiantes no ven sentido a lo que aprenden".',
                    'Un director le pide orientaci√≥n para mejorar los resultados en comprensi√≥n lectora.',
                    'Durante una asesor√≠a, un docente dice: "Ya expliqu√© el tema tres veces y a√∫n hay estudiantes que no entienden".',
                    'Un equipo docente debate si priorizar la cobertura del programa o la profundidad de los aprendizajes.'
                ],
                distractores: [
                    'Aplicar la misma estrategia pero con m√°s ejercicios de repetici√≥n',
                    'Reducir la complejidad de los contenidos para facilitar la aprobaci√≥n',
                    'Esperar que los estudiantes "maduren" y comprendan con el tiempo',
                    'Atribuir las dificultades exclusivamente a la falta de inter√©s de los estudiantes',
                    'Utilizar √∫nicamente la memorizaci√≥n como estrategia principal',
                    'Evaluar solo al final del per√≠odo sin retroalimentaci√≥n intermedia'
                ]
            },
            '1.2': { // Marco jur√≠dico
                situaciones: [
                    'Un director debe nombrar en propiedad a un docente interino que cumple 3 a√±os. El docente alega que "la experiencia es suficiente".',
                    'Durante un proceso de auditor√≠a, encuentran que un centro educativo no tiene actualizado su reglamento interno.',
                    'Una asociaci√≥n de padres solicita revisar la aplicaci√≥n del C√≥digo de la Ni√±ez en el centro.',
                    'Un asesor legal recibe consulta sobre si un docente puede ser sancionado por una falta cometida hace dos a√±os.',
                    'Un director regional debe interpretar una circular que parece contradecir el Estatuto de Servicio Civil.'
                ],
                distractores: [
                    'Aplicar el criterio de "siempre se ha hecho as√≠" aunque no est√© normado',
                    'Resolver bas√°ndose en la opini√≥n personal del director sin respaldo legal',
                    'Confundir la normativa con pr√°cticas administrativas informales',
                    'Asumir que la experiencia laboral sustituye requisitos acad√©micos',
                    'Aplicar normas derogadas por desconocimiento de actualizaciones',
                    'Interpretar la ley de manera literal sin considerar su esp√≠ritu'
                ]
            },
            '1.3': { // Estructura organizacional
                situaciones: [
                    'Un asesor regional recibe consultas contradictorias de dos direcciones regionales sobre la misma circular.',
                    'Se detecta que un centro educativo no est√° reportando informaci√≥n requerida por el nivel central.',
                    'Un coordinador debe mediar entre las directrices del nivel central y las necesidades de su instituci√≥n.',
                    'Durante una reuni√≥n, no queda claro si una decisi√≥n corresponde al director, al asesor o al nivel regional.',
                    'Un nuevo funcionario pregunta cu√°l es el canal adecuado para reportar una irregularidad.'
                ],
                distractores: [
                    'Resolver seg√∫n el criterio personal para agilizar el proceso',
                    'Ignorar las directrices centrales si parecen poco pr√°cticas',
                    'Asumir que todos los niveles tienen las mismas competencias',
                    'Comunicarse informalmente saltando canales establecidos',
                    'Esperar a que el problema se resuelva solo',
                    'Documentar pero no reportar formalmente'
                ]
            },
            '2.1': { // Dise√±o de proyectos
                situaciones: [
                    'El equipo de planificaci√≥n debe dise√±ar un proyecto para mejorar la convivencia escolar.',
                    'Un comit√© t√©cnico necesita alinear su plan anual con el PPPJ.',
                    'Se requiere elaborar un proyecto para reducir la deserci√≥n estudiantil.',
                    'Una direcci√≥n regional solicita proyectos innovadores para mejorar resultados en matem√°ticas.',
                    'Un asesor debe validar si un proyecto institucional cumple con los lineamientos del MEP.'
                ],
                distractores: [
                    'Copiar proyectos exitosos de otros centros sin adaptarlos',
                    'Dise√±ar el proyecto basado √∫nicamente en recursos disponibles',
                    'Priorizar actividades vistosas sobre resultados medibles',
                    'Omitir la evaluaci√≥n del impacto del proyecto',
                    'Involucrar solo al equipo directivo en el dise√±o',
                    'Establecer metas sin indicadores verificables'
                ]
            },
            '2.3': { // Liderazgo y TIC
                situaciones: [
                    'Un coordinador TIC debe asesorar sobre la implementaci√≥n de la transformaci√≥n digital.',
                    'Se requiere capacitar a docentes en el uso de plataformas educativas.',
                    'Un director quiere integrar tecnolog√≠a pero el personal se resiste.',
                    'El centro educativo recibe tablets pero no hay plan pedag√≥gico para usarlas.',
                    'Un asesor debe recomendar herramientas digitales para evaluaci√≥n formativa.'
                ],
                distractores: [
                    'Imponer el uso de tecnolog√≠a sin capacitaci√≥n previa',
                    'Utilizar la tecnolog√≠a solo como sustituto del cuaderno',
                    'Adquirir equipos sin plan pedag√≥gico asociado',
                    'Resistirse al cambio por temor a lo desconocido',
                    'Usar tecnolog√≠a solo para entretenimiento',
                    'Delegar completamente en el especialista TIC sin involucrarse'
                ]
            }
        };

        // ============================================
        // GENERADOR DE PREGUNTAS DE ALTA CALIDAD
        // ============================================
        class GeneradorPreguntasCalidad {
            constructor(documentos) {
                this.docs = documentos;
                this.banco = bancoPromptsCalidad;
                this.historial = JSON.parse(localStorage.getItem('historialCalidad')) || {};
            }

            generarPreguntaProfesional(competenciaCodigo) {
                // 1. Seleccionar documento con contenido relevante
                const doc = this.docs[Math.floor(Math.random() * this.docs.length)];
                
                // 2. Obtener banco de la competencia
                const bancoComp = this.banco[competenciaCodigo] || this.banco['1.1'];
                
                // 3. Seleccionar situaci√≥n contextual
                const situacion = bancoComp.situaciones[Math.floor(Math.random() * bancoComp.situaciones.length)];
                
                // 4. Generar opciones (1 correcta + 3 distractores)
                const correcta = this.generarOpcionCorrecta(doc, competenciaCodigo);
                const distractores = this.seleccionarDistractores(bancoComp.distractores, 3);
                
                // 5. Construir pregunta completa
                const opciones = [correcta, ...distractores.map(d => ({ texto: d, correcta: false }))];
                
                // 6. Mezclar opciones (posici√≥n aleatoria de la correcta)
                const posCorrecta = Math.floor(Math.random() * 4);
                const temp = opciones[0];
                opciones[0] = opciones[posCorrecta];
                opciones[posCorrecta] = temp;
                
                // 7. Determinar nivel y XP
                const nivel = this.determinarNivel(competenciaCodigo);
                const xp = nivel === 'normativo' ? 20 : (nivel === 'aplicado' ? 15 : 10);
                
                return {
                    id: `calidad_${Date.now()}_${Math.random()}`,
                    competencia: competenciaCodigo,
                    texto: `${situacion}\n\n¬øCu√°l es la actuaci√≥n correcta seg√∫n la normativa y buenas pr√°cticas?`,
                    opciones: opciones,
                    correcta: posCorrecta,
                    fundamento: this.generarFundamento(doc, competenciaCodigo),
                    documento: doc.nombre,
                    nivel: nivel,
                    xp: xp,
                    calidad: 'profesional'
                };
            }

            generarOpcionCorrecta(doc, competencia) {
                // Extraer concepto clave del documento
                const fragmento = doc.contenido.substring(0, 200).split('.')[0];
                
                // Reformular para que no sea literal
                const reformulaciones = [
                    `Fundamentar la decisi√≥n en ${fragmento.substring(0, 50)}... considerando el contexto institucional`,
                    `Aplicar el principio establecido en la normativa: ${fragmento.substring(0, 60)}...`,
                    `Orientar la acci√≥n hacia el cumplimiento de ${fragmento.substring(0, 40)}... seg√∫n lo establecido`,
                    `Basar la respuesta en lo dispuesto en el documento "${doc.nombre}" respecto a este tema`
                ];
                
                return {
                    texto: reformulaciones[Math.floor(Math.random() * reformulaciones.length)],
                    correcta: true
                };
            }

            seleccionarDistractores(lista, cantidad) {
                const seleccionados = [];
                const copia = [...lista];
                for (let i = 0; i < cantidad; i++) {
                    if (copia.length === 0) break;
                    const idx = Math.floor(Math.random() * copia.length);
                    seleccionados.push(copia.splice(idx, 1)[0]);
                }
                return seleccionados;
            }

            determinarNivel(competencia) {
                // L√≥gica simple: 40% conceptual, 40% aplicado, 20% normativo
                const rand = Math.random();
                if (rand < 0.4) return 'conceptual';
                if (rand < 0.8) return 'aplicado';
                return 'normativo';
            }

            generarFundamento(doc, competencia) {
                return `‚úÖ Correcto. Esta actuaci√≥n se alinea con los principios establecidos en ${doc.nombre} y las buenas pr√°cticas profesionales del MEP.`;
            }
        }

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let estratoActual = 'tecnico';
        let documentos = [];
        let generadorCalidad = null;
        let progresoUsuario = cargarProgreso() || {
            version: VERSION,
            nivel: { actual: 1, xp: 0, xpSiguiente: 200, rango: 'Bronce' },
            racha: { actual: 0, maxima: 0, ultimaFecha: null },
            competencias: {
                '1.1': { nivel: 0, xp: 0, dominada: false },
                '1.2': { nivel: 0, xp: 0, dominada: false },
                '1.3': { nivel: 0, xp: 0, dominada: false },
                '2.1': { nivel: 0, xp: 0, dominada: false },
                '2.3': { nivel: 0, xp: 0, dominada: false }
            },
            estadisticas: {
                totalPreguntas: 0,
                totalCorrectas: 0,
                totalIncorrectas: 0,
                simulacrosCompletados: 0,
                simulacrosAprobados: 0
            }
        };

        const rutaDuolingo = [
            { codigo: '1.1', nombre: '√Årea disciplinar', tipo: 'üìò', estado: 'disponible' },
            { codigo: '1.2', nombre: 'Marco jur√≠dico', tipo: 'üìò', estado: 'bloqueado' },
            { codigo: '1.3', nombre: 'Estructura MEP', tipo: 'üìò', estado: 'bloqueado' },
            { codigo: '2.1', nombre: 'Dise√±o proyectos', tipo: 'üõ†Ô∏è', estado: 'bloqueado' },
            { codigo: '2.3', nombre: 'Liderazgo TIC', tipo: 'üõ†Ô∏è', estado: 'bloqueado' }
        ];

        let preguntaActual = null;
        let competenciaActual = '1.1';
        let opcionSeleccionada = null;

        // ============================================
        // FUNCIONES DE PERSISTENCIA
        // ============================================
        function calcularChecksum(obj) {
            const str = JSON.stringify(obj) + 'IDOMEP_SECRET_2026';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return hash;
        }

        function guardarProgreso() {
            const copia = {...progresoUsuario};
            delete copia._checksum;
            copia._checksum = calcularChecksum(copia);
            localStorage.setItem('progresoIDOMEP', JSON.stringify(copia));
        }

        function cargarProgreso() {
            const guardado = localStorage.getItem('progresoIDOMEP');
            if (!guardado) return null;
            try {
                const data = JSON.parse(guardado);
                const checksum = data._checksum;
                delete data._checksum;
                if (calcularChecksum(data) !== checksum) return null;
                return data;
            } catch { return null; }
        }

        // ============================================
        // PROCESADOR DE ARCHIVOS
        // ============================================
        async function procesarArchivoUniversal(archivo) {
            try {
                const ext = archivo.name.split('.').pop().toLowerCase();
                let contenido = '';

                if (ext === 'pdf') {
                    const arrayBuffer = await archivo.arrayBuffer();
                    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    for (let i = 1; i <= Math.min(pdfDoc.numPages, 30); i++) {
                        const page = await pdfDoc.getPage(i);
                        const content = await page.getTextContent();
                        contenido += content.items.map(item => item.str).join(' ') + ' ';
                    }
                } else if (ext === 'docx' || ext === 'doc') {
                    const arrayBuffer = await archivo.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    contenido = result.value;
                } else {
                    contenido = await archivo.text();
                }

                contenido = contenido.toLowerCase().replace(/\s+/g, ' ').trim();
                return { nombre: archivo.name, contenido, tama√±o: archivo.size };
            } catch (error) {
                return { error: true, nombre: archivo.name, mensaje: error.message };
            }
        }

        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function renderizarCompetencias() {
            const perfil = perfilesMEP[estratoActual];
            let html = '';
            perfil.competencias.forEach(comp => {
                const nivel = progresoUsuario.competencias[comp.codigo]?.nivel || 0;
                html += `<div class="p-3 bg-slate-50 rounded-lg border-l-4 border-blue-500">
                    <div class="flex justify-between">
                        <span class="text-xs font-mono ${comp.saber ? 'bg-blue-200' : 'bg-green-200'} px-2 py-1 rounded-full">${comp.saber ? 'SABER' : 'HACER'}</span>
                        <span class="text-xs">Nivel ${nivel}</span>
                    </div>
                    <span class="font-medium block mt-1">${comp.codigo} ${comp.nombre}</span>
                </div>`;
            });
            document.getElementById('competencias-container').innerHTML = html;
        }

        function renderizarRuta() {
            const container = document.getElementById('ruta-container');
            let html = '';
            rutaDuolingo.forEach(item => {
                const estado = progresoUsuario.competencias[item.codigo];
                html += `<div class="ruta-item ${item.estado} bg-slate-50 p-4 rounded-xl text-center" data-codigo="${item.codigo}">
                    <div class="text-3xl mb-2">${item.tipo}</div>
                    <div class="font-bold text-sm">${item.codigo}</div>
                    <div class="text-xs text-gray-600">${item.nombre}</div>
                    ${item.estado === 'disponible' ? `
                        <div class="w-full bg-gray-200 h-1 rounded-full mt-2">
                            <div class="bg-blue-600 h-1 rounded-full" style="width: ${estado?.nivel * 20 || 0}%"></div>
                        </div>
                        <div class="text-xs mt-1">Nivel ${estado?.nivel || 0}</div>
                    ` : '<div class="text-xs text-gray-400 mt-2">üîí Bloqueado</div>'}
                </div>`;
            });
            container.innerHTML = html;
            
            document.querySelectorAll('.ruta-item.disponible').forEach(item => {
                item.addEventListener('click', function() {
                    competenciaActual = this.dataset.codigo;
                    cargarPreguntaCalidad();
                });
            });
        }

        function actualizarUIDuolingo() {
            const xp = progresoUsuario.nivel.xp;
            const nivel = progresoUsuario.nivel.actual;
            const xpSiguiente = nivel * XP_POR_NIVEL;
            const xpActualNivel = xp - ((nivel-1) * XP_POR_NIVEL);
            const porcentaje = (xpActualNivel / XP_POR_NIVEL) * 100;
            
            document.getElementById('nivel-duolingo').textContent = nivel;
            document.getElementById('xp-duolingo').textContent = xp;
            document.getElementById('xp-siguiente').textContent = nivel * XP_POR_NIVEL;
            document.getElementById('barra-xp-duolingo').style.width = Math.min(100, porcentaje) + '%';
            
            if (xp >= 2000) progresoUsuario.nivel.rango = 'Id√≥neo';
            else if (xp >= 1000) progresoUsuario.nivel.rango = 'Oro';
            else if (xp >= 500) progresoUsuario.nivel.rango = 'Plata';
            
            document.getElementById('rango-duolingo').textContent = progresoUsuario.nivel.rango;
            document.getElementById('racha-duolingo').textContent = progresoUsuario.racha.actual;
            
            const vidas = 3 - Math.floor(progresoUsuario.estadisticas.totalIncorrectas / 5);
            let vidasHtml = '';
            for (let i = 0; i < 3; i++) vidasHtml += i < vidas ? '‚ù§Ô∏è' : 'ü§ç';
            document.getElementById('vidas-duolingo').innerHTML = vidasHtml;
        }

        // ============================================
        // NUEVA FUNCI√ìN: Cargar pregunta de calidad
        // ============================================
        function cargarPreguntaCalidad() {
            if (!generadorCalidad || documentos.length === 0) {
                document.getElementById('pregunta-container').innerHTML = `
                    <div class="text-center text-amber-600 py-12">
                        <p class="font-medium">Primero cargue sus documentos en la pesta√±a INICIO</p>
                    </div>
                `;
                document.getElementById('calidad-indicador').classList.add('hidden');
                return;
            }
            
            const pregunta = generadorCalidad.generarPreguntaProfesional(competenciaActual);
            if (!pregunta) return;
            
            preguntaActual = pregunta;
            
            // Mostrar indicador de calidad
            document.getElementById('calidad-indicador').classList.remove('hidden');
            
            const compNombre = rutaDuolingo.find(r => r.codigo === competenciaActual).nombre;
            document.getElementById('competencia-actual-tag').innerHTML = 
                `${rutaDuolingo.find(r => r.codigo === competenciaActual).tipo} ${competenciaActual} ${compNombre}`;
            
            const niveles = { conceptual: 'üü¢ Conceptual', aplicado: 'üü° Aplicado', normativo: 'üî¥ Normativo' };
            document.getElementById('nivel-pregunta-tag').textContent = niveles[pregunta.nivel] || 'üü¢ Conceptual';
            
            let html = `
                <div>
                    <p class="text-lg font-medium mb-4 whitespace-pre-line">${pregunta.texto}</p>
                    <div class="space-y-3 mb-6">
            `;
            
            pregunta.opciones.forEach((op, idx) => {
                html += `
                    <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer relative group"
                           onclick="seleccionarOpcionCalidad(this, ${idx})">
                        <span class="w-6 h-6 rounded-full border-2 flex items-center justify-center font-bold text-sm flex-shrink-0 mt-0.5">
                            ${String.fromCharCode(65 + idx)}
                        </span>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm block">${op.texto}</span>
                        </div>
                    </label>
                `;
            });
            
            html += `
                    </div>
                    <button id="btn-responder" onclick="responderPreguntaCalidad()" 
                            class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold" disabled>
                        Verificar respuesta
                    </button>
                </div>
                <div id="feedback-duolingo" class="hidden mt-4"></div>
            `;
            
            document.getElementById('pregunta-container').innerHTML = html;
        }

        function seleccionarOpcionCalidad(label, idx) {
            document.querySelectorAll('#pregunta-container label').forEach(l => {
                l.classList.remove('bg-blue-100', 'border-blue-500');
                l.querySelector('span:first-child').classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            });
            label.classList.add('bg-blue-100', 'border-blue-500');
            label.querySelector('span:first-child').classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            document.getElementById('btn-responder').disabled = false;
            opcionSeleccionada = idx;
        }

        function responderPreguntaCalidad() {
            if (opcionSeleccionada === undefined || !preguntaActual) return;
            
            const esCorrecta = opcionSeleccionada === preguntaActual.correcta;
            
            // Actualizar estad√≠sticas
            progresoUsuario.estadisticas.totalPreguntas++;
            if (esCorrecta) {
                progresoUsuario.estadisticas.totalCorrectas++;
                progresoUsuario.nivel.xp += preguntaActual.xp;
                
                if (progresoUsuario.competencias[preguntaActual.competencia]) {
                    progresoUsuario.competencias[preguntaActual.competencia].xp += preguntaActual.xp;
                    progresoUsuario.competencias[preguntaActual.competencia].nivel = 
                        Math.floor(progresoUsuario.competencias[preguntaActual.competencia].xp / 100) + 1;
                }
            } else {
                progresoUsuario.estadisticas.totalIncorrectas++;
            }
            
            // Actualizar nivel
            progresoUsuario.nivel.actual = Math.floor(progresoUsuario.nivel.xp / XP_POR_NIVEL) + 1;
            guardarProgreso();
            
            // Mostrar feedback
            const feedback = document.getElementById('feedback-duolingo');
            const opcionElegida = preguntaActual.opciones[opcionSeleccionada];
            
            feedback.innerHTML = `
                <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 ${esCorrecta ? 'border-green-500' : 'border-red-500'}">
                    <h4 class="font-bold text-lg mb-2">${esCorrecta ? '‚úÖ Correcto' : '‚ùå Incorrecto'}</h4>
                    <div class="bg-${esCorrecta ? 'green' : 'red'}-50 p-4 rounded-lg">
                        <p class="font-medium">${esCorrecta ? 'Fundamento profesional' : 'Error'}:</p>
                        <p>${esCorrecta ? preguntaActual.fundamento : 'Esta opci√≥n no se ajusta a la normativa ni a las buenas pr√°cticas.'}</p>
                        ${!esCorrecta ? `
                            <p class="mt-2 font-medium">‚úÖ La respuesta correcta era:</p>
                            <p>${preguntaActual.opciones[preguntaActual.correcta].texto}</p>
                        ` : ''}
                    </div>
                    <button onclick="siguientePreguntaCalidad()" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg">Continuar</button>
                </div>
            `;
            feedback.classList.remove('hidden');
            document.getElementById('btn-responder').disabled = true;
            
            actualizarUIDuolingo();
            renderizarRuta();
        }

        function siguientePreguntaCalidad() {
            document.getElementById('feedback-duolingo').classList.add('hidden');
            cargarPreguntaCalidad();
        }

        // ============================================
        // SIMULADOR (versi√≥n simplificada pero funcional)
        // ============================================
        function iniciarSimulador() {
            if (!generadorCalidad || documentos.length === 0) {
                alert('Debe cargar documentos primero');
                return;
            }
            
            const preguntas = [];
            const competencias = ['1.1', '1.2', '1.3', '2.1', '2.3'];
            
            for (let i = 0; i < 60; i++) {
                const comp = competencias[Math.floor(Math.random() * competencias.length)];
                const pregunta = generadorCalidad.generarPreguntaProfesional(comp);
                if (pregunta) preguntas.push(pregunta);
            }
            
            window.simuladorPreguntas = preguntas;
            window.simuladorIndex = 0;
            window.simuladorCorrectas = 0;
            
            document.getElementById('estado-simulacro').classList.remove('hidden');
            mostrarPreguntaSimulador(0);
        }

        function mostrarPreguntaSimulador(index) {
            if (index >= window.simuladorPreguntas.length) {
                finalizarSimulador();
                return;
            }
            
            const pregunta = window.simuladorPreguntas[index];
            
            let html = `
                <div class="pregunta-simulador">
                    <p class="text-sm text-gray-500 mb-2">Pregunta ${index+1} de 60</p>
                    <p class="text-lg font-medium mb-4 whitespace-pre-line">${pregunta.texto}</p>
                    <div class="space-y-3 mb-6">
            `;
            
            pregunta.opciones.forEach((op, idx) => {
                html += `
                    <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer"
                           onclick="seleccionarOpcionSimulador(this, ${idx}, ${index})">
                        <span class="w-6 h-6 rounded-full border-2 flex items-center justify-center font-bold">${String.fromCharCode(65 + idx)}</span>
                        <span>${op.texto}</span>
                    </label>
                `;
            });
            
            html += `
                    </div>
                    <button id="btn-simulador" onclick="responderSimulador(${index})" 
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold" disabled>
                        Responder
                    </button>
                </div>
            `;
            
            document.getElementById('simulacro-container').innerHTML = html;
            window.preguntaSimuladorActual = pregunta;
        }

        function seleccionarOpcionSimulador(label, idx, index) {
            document.querySelectorAll('.pregunta-simulador label').forEach(l => {
                l.classList.remove('bg-blue-100', 'border-blue-500');
                l.querySelector('span:first-child').classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            });
            label.classList.add('bg-blue-100', 'border-blue-500');
            label.querySelector('span:first-child').classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            document.getElementById('btn-simulador').disabled = false;
            window.opcionSimuladorSeleccionada = { idx, index };
        }

        function responderSimulador(index) {
            if (!window.opcionSimuladorSeleccionada || window.opcionSimuladorSeleccionada.index !== index) return;
            
            const pregunta = window.simuladorPreguntas[index];
            const esCorrecta = window.opcionSimuladorSeleccionada.idx === pregunta.correcta;
            
            if (esCorrecta) window.simuladorCorrectas++;
            
            document.getElementById('simulacro-progreso').textContent = `${index+1}/60`;
            document.getElementById('simulacro-correctas').textContent = window.simuladorCorrectas;
            const nota = Math.round((window.simuladorCorrectas / (index+1)) * 100);
            document.getElementById('simulacro-nota').textContent = nota + '%';
            document.getElementById('simulacro-barra').style.width = ((index+1) / 60 * 100) + '%';
            
            setTimeout(() => {
                mostrarPreguntaSimulador(index + 1);
            }, 500);
        }

        function finalizarSimulador() {
            const porcentaje = (window.simuladorCorrectas / 60) * 100;
            const aprobado = porcentaje >= 70;
            
            progresoUsuario.estadisticas.simulacrosCompletados++;
            if (aprobado) progresoUsuario.estadisticas.simulacrosAprobados++;
            guardarProgreso();
            
            let reporte = `
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <h3 class="text-2xl font-bold mb-4 ${aprobado ? 'text-green-600' : 'text-red-600'}">
                        ${aprobado ? '‚úÖ APROBADO' : '‚ùå NO APROBADO'}
                    </h3>
                    <p class="mb-2">Resultado: ${window.simuladorCorrectas}/60 (${porcentaje.toFixed(1)}%)</p>
                    <button onclick="iniciarSimulador()" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg">
                        Nuevo simulacro
                    </button>
                </div>
            `;
            
            document.getElementById('resultado-simulador').innerHTML = reporte;
            document.getElementById('simulacro-container').innerHTML = '';
            document.getElementById('estado-simulacro').classList.add('hidden');
        }

        // ============================================
        // REPORTE DE COMPETENCIAS
        // ============================================
        function generarReporteCompetencias() {
            const container = document.getElementById('reporte-competencias');
            if (!container) return;
            
            let html = '';
            for (let [codigo, data] of Object.entries(progresoUsuario.competencias)) {
                const competencia = perfilesMEP[estratoActual]?.competencias.find(c => c.codigo === codigo);
                const nombre = competencia?.nombre || codigo;
                const porcentaje = data.nivel * 20;
                const colorBarra = porcentaje >= 80 ? 'bg-green-500' : (porcentaje >= 50 ? 'bg-yellow-500' : 'bg-red-500');
                
                html += `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-sm">${codigo} - ${nombre.substring(0, 30)}</span>
                            <span class="text-sm font-bold">${data.nivel}</span>
                        </div>
                        <div class="w-full bg-gray-200 h-4 rounded-full overflow-hidden">
                            <div class="${colorBarra} h-4 rounded-full" style="width: ${porcentaje}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">XP: ${data.xp}</p>
                    </div>
                `;
            }
            container.innerHTML = html;
            
            // Gr√°fico radar
            const ctx = document.getElementById('radar-competencias').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['1.1', '1.2', '1.3', '2.1', '2.3'],
                    datasets: [{
                        label: 'Nivel de dominio',
                        data: [
                            progresoUsuario.competencias['1.1'].nivel * 20,
                            progresoUsuario.competencias['1.2'].nivel * 20,
                            progresoUsuario.competencias['1.3'].nivel * 20,
                            progresoUsuario.competencias['2.1'].nivel * 20,
                            progresoUsuario.competencias['2.3'].nivel * 20
                        ],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6'
                    }]
                },
                options: { scales: { r: { min: 0, max: 100 } } }
            });
            
            document.getElementById('estadisticas-globales').innerHTML = `
                <div class="p-3 bg-white rounded-lg shadow">
                    <span class="text-sm text-gray-500">Total preguntas</span>
                    <p class="text-2xl font-bold">${progresoUsuario.estadisticas.totalPreguntas}</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow">
                    <span class="text-sm text-gray-500">Correctas</span>
                    <p class="text-2xl font-bold text-green-600">${progresoUsuario.estadisticas.totalCorrectas}</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow">
                    <span class="text-sm text-gray-500">Simulacros</span>
                    <p class="text-2xl font-bold">${progresoUsuario.estadisticas.simulacrosCompletados}</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow">
                    <span class="text-sm text-gray-500">Aprobados</span>
                    <p class="text-2xl font-bold text-blue-600">${progresoUsuario.estadisticas.simulacrosAprobados}</p>
                </div>
            `;
        }

        // ============================================
        // EVENTOS DE INICIALIZACI√ìN
        // ============================================
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${this.dataset.tab}`).classList.remove('hidden');
                
                if (this.dataset.tab === 'reporte') {
                    generarReporteCompetencias();
                }
            });
        });

        document.querySelectorAll('#selector-estrato .estrato-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#selector-estrato .estrato-btn').forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-slate-100');
                });
                this.classList.remove('bg-slate-100');
                this.classList.add('bg-blue-600', 'text-white');
                estratoActual = this.dataset.estrato;
                renderizarCompetencias();
            });
        });

        document.getElementById('carga-docs').addEventListener('change', async function(e) {
            const archivos = Array.from(e.target.files);
            documentos = [];
            const listaDiv = document.getElementById('lista-docs');
            const progresoDiv = document.getElementById('progreso-carga');
            listaDiv.innerHTML = '';
            
            for (let i = 0; i < archivos.length; i++) {
                const archivo = archivos[i];
                progresoDiv.innerHTML = `Procesando ${i+1}/${archivos.length}: ${archivo.name}...`;
                const resultado = await procesarArchivoUniversal(archivo);
                
                if (resultado.error) {
                    listaDiv.innerHTML += `<div class="py-1 text-xs text-red-600">‚ùå ${resultado.nombre}: ${resultado.mensaje}</div>`;
                } else {
                    documentos.push(resultado);
                    listaDiv.innerHTML += `<div class="py-1 text-xs text-green-600">‚úÖ ${resultado.nombre}</div>`;
                }
            }
            
            generadorCalidad = new GeneradorPreguntasCalidad(documentos);
            listaDiv.classList.remove('hidden');
            progresoDiv.innerHTML = `‚úÖ ${documentos.length} documentos listos. Modo: CALIDAD PROFESIONAL`;
        });

        document.getElementById('btn-iniciar-simulacro').addEventListener('click', iniciarSimulador);
        setInterval(guardarProgreso, 30000);
        window.addEventListener('beforeunload', guardarProgreso);

        // Inicializar
        renderizarCompetencias();
        renderizarRuta();
        actualizarUIDuolingo();
    </script>
</body>
</html>
