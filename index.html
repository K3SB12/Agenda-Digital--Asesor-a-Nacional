<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† TUTOR IDONEIDAD MEP ¬∑ Lector de PDFs</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- PDF.js desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        body { background: #f0f9ff; font-family: system-ui, sans-serif; }
        .card { background: white; border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .competencia-badge { background: #e0f2fe; color: #0369a1; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .indicador-item { background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; margin: 0 4px 4px 0; display: inline-block; }
        .pregunta-card { background: white; border-radius: 20px; padding: 20px; border-left: 4px solid #2563eb; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .feedback-correcto { background: #dcfce7; border-left: 4px solid #22c55e; padding: 12px; border-radius: 12px; }
        .feedback-incorrecto { background: #fee2e2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 12px; }
        .progreso-bar { height: 8px; border-radius: 4px; background: #e2e8f0; overflow: hidden; }
        .progreso-fill { height: 100%; background: #2563eb; width: 0%; transition: width 0.3s; }
        .pdf-badge { background: #fee2e2; color: #b91c1c; font-size: 0.7rem; padding: 2px 6px; border-radius: 12px; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto space-y-6">

        <!-- CABECERA: Fundamento MEP -->
        <div class="card bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">üìò Idoneidad MEP</h1>
                    <p class="text-blue-100">Tutor con lectura de PDFs ¬∑ Transitorio IX</p>
                    <div class="flex flex-wrap gap-2 mt-3 text-xs bg-white/20 p-3 rounded-xl">
                        <span class="font-semibold">Fundamento:</span> LMEP N.¬∫ 10159 ¬∑ Ley N.¬∫9871 ¬∑ Resoluci√≥n DG-RES-88-2023 ¬∑ Calificaci√≥n m√≠nima 70
                    </div>
                </div>
                <a href="https://dgth.mep.go.cr/pruebas-de-idoneidad-transitorio-ix/" target="_blank" class="bg-white text-blue-700 px-4 py-2 rounded-full text-sm font-bold hover:bg-blue-50 transition flex items-center gap-2">
                    <i class="fa-regular fa-file-lines"></i> Tablas DGTH
                </a>
            </div>
        </div>

        <!-- SELECTOR DE ESTRATO -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">üéØ Seleccione su estrato (T√≠tulo II)</h2>
            <div class="flex flex-wrap gap-3" id="selector-estrato">
                <button data-estrato="docente" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100 transition font-medium">Propiamente Docente</button>
                <button data-estrato="tecnico" class="estrato-btn px-5 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition font-medium" id="btn-tecnico">T√©cnico Docente (Asesores)</button>
                <button data-estrato="administrativo" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100 transition font-medium">Administrativo Docente</button>
            </div>
        </div>

        <!-- CONTENEDOR PRINCIPAL -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUMNA IZQUIERDA: COMPETENCIAS + PROGRESO -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-list"></i> Competencias a evaluar</h2>
                    <div id="competencias-container" class="space-y-4 text-sm"></div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-chart-line"></i> Mi progreso</h2>
                    <div class="space-y-3">
                        <div><span class="font-medium">Nivel general:</span> <span id="nivel-general">0%</span></div>
                        <div class="progreso-bar"><div class="progreso-fill" id="barra-progreso" style="width:0%"></div></div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="bg-slate-50 p-2 rounded"><span class="font-medium">Correctas:</span> <span id="total-correctas">0</span></div>
                            <div class="bg-slate-50 p-2 rounded"><span class="font-medium">Totales:</span> <span id="total-preguntas">0</span></div>
                        </div>
                        <div id="recomendacion-refuerzo" class="text-sm p-3 bg-yellow-50 rounded-lg text-yellow-800">
                            üí° Responda preguntas para ver recomendaciones.
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: DOCUMENTOS + SIMULADOR -->
            <div class="lg:col-span-2 space-y-6">
                <!-- CARGA DE PDFS -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-folder-open"></i> 1. Cargue sus documentos (PDF o TXT)</h2>
                    <p class="text-sm text-green-600 mb-3">‚úÖ Ahora acepta PDFs directamente. Seleccione todos sus archivos.</p>
                    <input type="file" id="carga-docs" multiple accept=".pdf,.txt" class="mb-3">
                    <div id="lista-docs" class="text-sm max-h-40 overflow-y-auto bg-slate-50 p-3 rounded-lg hidden"></div>
                    <div id="progreso-carga" class="text-xs text-gray-500 mt-2"></div>
                </div>

                <!-- GENERADOR -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-regular fa-pen-to-square"></i> 2. Practique por competencia</h2>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="selector-competencia" class="border rounded-lg px-3 py-2 text-sm flex-grow">
                            <option value="">Cualquier competencia (autom√°tico)</option>
                        </select>
                        <button id="btn-generar" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 font-medium flex items-center gap-2">
                            <i class="fa-regular fa-flask"></i> Generar pregunta
                        </button>
                    </div>
                    <div id="simulador-container" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // Configurar PDF.js
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

            // Perfiles MEP (COMPLETOS)
            const perfilesMEP = {
                tecnico: {
                    nombre: 'T√©cnico Docente (Asesores)',
                    competencias: [
                        { codigo: '1.1', nombre: '√Årea disciplinar, pedag√≥gica y curricular', saber: true,
                          indicadores: ['Domina su disciplina', 'Asesora sobre actualizaciones curriculares', 'Fundamenta con teor√≠as pedag√≥gicas'] },
                        { codigo: '1.2', nombre: 'Marco jur√≠dico, √©tico y pol√≠ticas p√∫blicas', saber: true,
                          indicadores: ['Aplica Pol√≠tica Educativa', 'Interpreta normativa vinculante (Leyes 10159, 8292, etc.)'] },
                        { codigo: '1.3', nombre: 'Estructura organizacional del MEP', saber: true,
                          indicadores: ['Coordina entre niveles central, regional e institucional'] },
                        { codigo: '2.1', nombre: 'Dise√±o de planes, programas y proyectos', saber: false,
                          indicadores: ['Elabora proyectos de mejora', 'Dise√±a estrategias de intervenci√≥n'] },
                        { codigo: '2.3', nombre: 'Liderazgo, asesor√≠a y TIC', saber: false,
                          indicadores: ['Utiliza plataformas digitales', 'Promueve innovaci√≥n educativa con TIC'] }
                    ]
                },
                docente: {
                    nombre: 'Propiamente Docente',
                    competencias: [
                        { codigo: '1.1', nombre: 'Conocimiento de estudiantes y contexto', saber: true, indicadores: ['Identifica etapas del desarrollo'] },
                        { codigo: '1.2', nombre: 'Dominio disciplinar y did√°ctico', saber: true, indicadores: ['Selecciona estrategias did√°cticas'] },
                        { codigo: '1.3', nombre: 'Pol√≠ticas y normativa educativa', saber: true, indicadores: ['Cita C√≥digo de Ni√±ez'] },
                        { codigo: '2.1', nombre: 'Dise√±o de experiencias de aprendizaje', saber: false, indicadores: ['Adecua objetivos'] },
                        { codigo: '2.2', nombre: 'Mediaci√≥n pedag√≥gica', saber: false, indicadores: ['Aplica aprendizaje cooperativo'] },
                        { codigo: '2.3', nombre: 'Evaluaci√≥n de aprendizajes', saber: false, indicadores: ['Construye r√∫bricas'] }
                    ]
                },
                administrativo: {
                    nombre: 'Administrativo Docente',
                    competencias: [
                        { codigo: '1.1', nombre: 'Liderazgo pedag√≥gico y gesti√≥n', saber: true, indicadores: ['Identifica modelos de supervisi√≥n'] },
                        { codigo: '1.4', nombre: 'Tecnolog√≠as en educaci√≥n', saber: true, indicadores: ['Usa sistemas institucionales'] },
                        { codigo: '2.3', nombre: 'Gesti√≥n de recursos', saber: false, indicadores: ['Elabora presupuestos', 'Aplica Ley de Contrataci√≥n'] },
                        { codigo: '2.4', nombre: 'Gesti√≥n segura de informaci√≥n', saber: false, indicadores: ['Aplica protocolos de datos'] },
                        { codigo: '2.5', nombre: 'Liderazgo y responsabilidad', saber: false, indicadores: ['Conduce reuniones'] }
                    ]
                }
            };

            // Estado
            let estratoActual = 'tecnico';
            let documentos = [];
            let progreso = JSON.parse(localStorage.getItem('progresoMEP')) || { total:0, correctas:0, porCompetencia:{} };

            // Palabras clave por competencia (para clasificar PDFs)
            const palabrasClave = {
                '1.1': ['curr√≠culum', 'did√°ctica', 'metodolog√≠a', 'pedagog√≠a', 'STEAM', 'PNFT', 'gu√≠a docente', 'm√≥dulo', 'ense√±anza', 'aprendizaje'],
                '1.2': ['ley', 'art√≠culo', 'reglamento', 'normativa', 'pol√≠tica', '√©tica', 'c√≥digo', 'estatuto', 'convenci√≥n', '10159', '8292', '6227', '1581', '7494'],
                '1.3': ['circular', 'lineamiento', 'organizaci√≥n', 'estructura', 'nivel central', 'regional', 'institucional', 'directriz'],
                '2.1': ['plan', 'programa', 'proyecto', 'dise√±o', 'estrategia', 'PPPJ', 'marco estrat√©gico'],
                '2.3': ['tecnolog√≠a', 'TIC', 'digital', 'innovaci√≥n', 'MITDE', 'gobernanza', 'transformaci√≥n digital', 'inteligencia artificial']
            };

            // Funci√≥n para leer PDF
            async function leerPDF(archivo) {
                const arrayBuffer = await archivo.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let textoCompleto = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const strings = content.items.map(item => item.str);
                    textoCompleto += strings.join(' ') + ' ';
                }
                
                return textoCompleto.toLowerCase().replace(/[^\w\s√°√©√≠√≥√∫√±√º]/g, ' ').replace(/\s+/g, ' ');
            }

            // Clasificar documento por competencias
            function clasificarDocumento(nombre, contenido) {
                const textoCompleto = (nombre + ' ' + contenido).toLowerCase();
                const competenciasRel = [];
                
                for (let [codigo, keywords] of Object.entries(palabrasClave)) {
                    for (let kw of keywords) {
                        if (textoCompleto.includes(kw)) {
                            competenciasRel.push(codigo);
                            break;
                        }
                    }
                }
                
                return [...new Set(competenciasRel)]; // √önicas
            }

            // Renderizar competencias
            function renderizarCompetencias() {
                const perfil = perfilesMEP[estratoActual];
                let html = '';
                perfil.competencias.forEach(comp => {
                    const nivel = progreso.porCompetencia[comp.codigo]?.nivel || 0;
                    html += `
                        <div class="border-l-4 border-blue-500 pl-3 py-2 bg-slate-50 rounded">
                            <div class="flex justify-between items-center">
                                <span class="competencia-badge">${comp.codigo} ${comp.saber ? 'üìò' : 'üõ†Ô∏è'}</span>
                                <span class="text-xs font-mono">${nivel}%</span>
                            </div>
                            <p class="font-medium mt-1">${comp.nombre}</p>
                            <div class="mt-2">${comp.indicadores.map(i => `<span class="indicador-item">‚úì ${i}</span>`).join('')}</div>
                        </div>
                    `;
                });
                document.getElementById('competencias-container').innerHTML = html;
                
                // Llenar selector
                const select = document.getElementById('selector-competencia');
                select.innerHTML = '<option value="">Cualquier competencia (autom√°tico)</option>';
                perfil.competencias.forEach(comp => {
                    select.innerHTML += `<option value="${comp.codigo}">${comp.codigo} - ${comp.nombre}</option>`;
                });
            }

            // Actualizar UI de progreso
            function actualizarProgresoUI() {
                const total = progreso.total || 0;
                const correctas = progreso.correctas || 0;
                const nivel = total > 0 ? Math.round((correctas/total)*100) : 0;
                document.getElementById('nivel-general').textContent = nivel + '%';
                document.getElementById('barra-progreso').style.width = nivel + '%';
                document.getElementById('total-correctas').textContent = correctas;
                document.getElementById('total-preguntas').textContent = total;

                const perfil = perfilesMEP[estratoActual];
                const aReforzar = perfil.competencias.filter(c => (progreso.porCompetencia[c.codigo]?.nivel || 0) < 60).map(c => c.codigo);
                document.getElementById('recomendacion-refuerzo').innerHTML = aReforzar.length > 0 
                    ? `üìö Reforzar: competencias ${aReforzar.join(', ')}`
                    : '‚úÖ Buen nivel en todas las competencias.';
            }

            // Carga de documentos (PDF + TXT)
            document.getElementById('carga-docs').addEventListener('change', async function(e) {
                const archivos = Array.from(e.target.files);
                documentos = [];
                const listaDiv = document.getElementById('lista-docs');
                const progresoDiv = document.getElementById('progreso-carga');
                listaDiv.innerHTML = '';
                
                for (let i = 0; i < archivos.length; i++) {
                    const archivo = archivos[i];
                    progresoDiv.innerHTML = `Procesando ${i+1}/${archivos.length}: ${archivo.name}...`;
                    
                    try {
                        let contenido = '';
                        if (archivo.name.toLowerCase().endsWith('.pdf')) {
                            contenido = await leerPDF(archivo);
                        } else {
                            contenido = await archivo.text();
                            contenido = contenido.toLowerCase().replace(/[^\w\s√°√©√≠√≥√∫√±√º]/g, ' ').replace(/\s+/g, ' ');
                        }
                        
                        const competencias = clasificarDocumento(archivo.name, contenido);
                        documentos.push({
                            nombre: archivo.name,
                            contenido: contenido,
                            competencias: competencias
                        });
                        
                        const badge = archivo.name.endsWith('.pdf') ? '<span class="pdf-badge ml-1">PDF</span>' : '';
                        listaDiv.innerHTML += `<div class="py-1 border-b text-xs">üìÑ ${archivo.name} ${badge} ‚Üí [${competencias.join(', ') || 'sin clasificar'}]</div>`;
                    } catch (error) {
                        listaDiv.innerHTML += `<div class="py-1 text-red-600">‚ùå Error con ${archivo.name}</div>`;
                    }
                }
                
                listaDiv.classList.remove('hidden');
                progresoDiv.innerHTML = `‚úÖ ${documentos.length} documentos procesados`;
            });

            // Generar pregunta
            function generarPregunta(competenciaElegida = null) {
                if (documentos.length === 0) { alert('Cargue documentos primero'); return; }

                let competenciaObj = null;
                if (competenciaElegida) {
                    competenciaObj = perfilesMEP[estratoActual].competencias.find(c => c.codigo === competenciaElegida);
                } else {
                    const comps = perfilesMEP[estratoActual].competencias;
                    const niveles = comps.map(c => progreso.porCompetencia[c.codigo]?.nivel || 0);
                    const minNivel = Math.min(...niveles);
                    const candidatas = comps.filter((_, i) => niveles[i] === minNivel);
                    competenciaObj = candidatas[Math.floor(Math.random() * candidatas.length)];
                }
                if (!competenciaObj) return;

                let docsRel = documentos.filter(d => d.competencias.includes(competenciaObj.codigo));
                if (docsRel.length === 0) docsRel = documentos;
                const doc = docsRel[Math.floor(Math.random() * docsRel.length)];

                const oraciones = doc.contenido.split('.').filter(o => o.trim().length > 40);
                if (oraciones.length === 0) return generarPregunta(competenciaElegida);
                const fragmento = oraciones[Math.floor(Math.random() * oraciones.length)].trim();

                // Opciones base (se pueden personalizar m√°s)
                const opciones = [
                    'A) Aplicar la normativa o procedimiento establecido',
                    'B) Actuar seg√∫n criterio personal',
                    'C) Consultar con colegas sin fundamento legal',
                    'D) Esperar directrices sin actuar'
                ];

                return {
                    competencia: competenciaObj.codigo,
                    pregunta: `[Competencia ${competenciaObj.codigo}] Seg√∫n "${doc.nombre}":\n"${fragmento.substring(0,200)}..."\n¬øCu√°l es la actuaci√≥n correcta?`,
                    opciones: opciones,
                    correcta: 0,
                    explicacion: `La respuesta correcta se fundamenta en el documento "${doc.nombre}". Revise el texto completo para m√°s contexto.`,
                    documento: doc.nombre
                };
            }

            // Agregar pregunta al simulador
            function agregarPregunta(p) {
                const id = Date.now();
                const container = document.getElementById('simulador-container');
                const html = `
                    <div class="pregunta-card" data-id="${id}" data-competencia="${p.competencia}">
                        <p class="font-medium mb-3">${p.pregunta}</p>
                        <div class="space-y-2 mb-3">${p.opciones.map((opt, idx) => `
                            <div class="flex items-center gap-2"><input type="radio" name="p_${id}" value="${idx}"><span>${opt}</span></div>
                        `).join('')}</div>
                        <div class="feedback hidden text-sm p-3 rounded-lg"></div>
                        <p class="text-xs text-gray-400 mt-2">üìÑ ${p.documento}</p>
                    </div>
                `;
                container.innerHTML = html + container.innerHTML;

                document.querySelectorAll(`[name="p_${id}"]`).forEach(r => r.addEventListener('change', function(e) {
                    const card = this.closest('.pregunta-card');
                    const feedback = card.querySelector('.feedback');
                    const correcta = p.correcta;
                    const esCorrecta = parseInt(this.value) === correcta;
                    const competencia = card.dataset.competencia;

                    progreso.total++;
                    if (esCorrecta) progreso.correctas++;
                    if (!progreso.porCompetencia[competencia]) progreso.porCompetencia[competencia] = { total:0, correctas:0 };
                    progreso.porCompetencia[competencia].total++;
                    if (esCorrecta) progreso.porCompetencia[competencia].correctas++;
                    progreso.porCompetencia[competencia].nivel = Math.round((progreso.porCompetencia[competencia].correctas / progreso.porCompetencia[competencia].total) * 100);

                    feedback.className = esCorrecta ? 'feedback-correcto text-sm block' : 'feedback-incorrecto text-sm block';
                    feedback.innerHTML = esCorrecta ? `‚úÖ Correcto! ${p.explicacion}` : `‚ùå Incorrecto. ${p.explicacion}`;
                    
                    localStorage.setItem('progresoMEP', JSON.stringify(progreso));
                    renderizarCompetencias();
                    actualizarProgresoUI();
                    card.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = true);
                }));
            }

            // Eventos
            document.getElementById('selector-estrato').addEventListener('click', (e) => {
                const btn = e.target.closest('.estrato-btn');
                if (!btn) return;
                estratoActual = btn.dataset.estrato;
                document.querySelectorAll('.estrato-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
                btn.classList.add('bg-blue-600', 'text-white');
                renderizarCompetencias();
            });

            document.getElementById('btn-generar').addEventListener('click', () => {
                const select = document.getElementById('selector-competencia');
                const pregunta = generarPregunta(select.value || null);
                if (pregunta) agregarPregunta(pregunta);
            });

            // Inicializar
            renderizarCompetencias();
            actualizarProgresoUI();
        })();
    </script>
</body>
</html>
