<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Digital - Asesor Nacional DRTE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <!-- Librerías para exportación profesional -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.8.0/build/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- HEADER con Backup en Tiempo Real -->
        <header class="main-header">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="logo-text">
                    <h1>Agenda Digital DRTE</h1>
                    <p>Asesor Nacional - Departamento de Investigación, Desarrollo e Implementación</p>
                    <div class="backup-status">
                        <i class="fas fa-cloud" id="backup-icon"></i>
                        <span id="backup-status">Sincronizado</span>
                        <span id="last-backup"></span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="agenda.openModal('profile-modal')">
                    <i class="fas fa-user"></i> Perfil
                </button>
                <button class="btn btn-primary" onclick="agenda.exportMenu()">
                    <i class="fas fa-file-export"></i> Exportar
                    <div class="export-menu" id="export-menu">
                        <a onclick="agenda.exportToPDF()"><i class="fas fa-file-pdf"></i> PDF</a>
                        <a onclick="agenda.exportToDOCX()"><i class="fas fa-file-word"></i> DOCX</a>
                        <a onclick="agenda.exportToExcel()"><i class="fas fa-file-excel"></i> Excel</a>
                        <a onclick="agenda.exportToCSV()"><i class="fas fa-file-csv"></i> CSV</a>
                    </div>
                </button>
                <button class="btn btn-success" onclick="agenda.shareReport()">
                    <i class="fas fa-share-alt"></i> Compartir
                </button>
                <button class="btn btn-warning" onclick="agenda.backupToDrive()">
                    <i class="fas fa-cloud-upload-alt"></i> Backup
                </button>
            </div>
        </header>

        <!-- SISTEMA DE NOTIFICACIONES EN TIEMPO REAL -->
        <div class="notification-center">
            <div class="notification-header">
                <i class="fas fa-bell"></i>
                <h3>Recordatorios</h3>
                <button class="btn btn-sm" onclick="agenda.enableNotifications()">
                    <i class="fas fa-cog"></i> Configurar
                </button>
            </div>
            <div class="notification-list" id="notification-list">
                <!-- Recordatorios cargados dinámicamente -->
            </div>
        </div>

        <!-- PANEL DE NAVEGACIÓN MEJORADO -->
        <div class="nav-panel">
            <div class="nav-item" onclick="agenda.openTaskModal('task')">
                <div class="nav-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <h3>Nueva Tarea</h3>
                <p>Registrar actividades diarias del PNFT</p>
                <div class="quick-templates">
                    <span class="template-tag" onclick="agenda.loadTemplate(1)">Informe Semanal</span>
                    <span class="template-tag" onclick="agenda.loadTemplate(2)">Reunión DRTE</span>
                    <span class="template-tag" onclick="agenda.loadTemplate(3)">Capacitación</span>
                </div>
            </div>
            
            <div class="nav-item" onclick="agenda.openTaskModal('meeting')">
                <div class="nav-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>Reunión</h3>
                <p>Agendar reuniones con el equipo</p>
            </div>
            
            <div class="nav-item" onclick="agenda.openEvidenceManager()">
                <div class="nav-icon">
                    <i class="fas fa-file-upload"></i>
                </div>
                <h3>Evidencias</h3>
                <p>Gestionar archivos de soporte</p>
                <div class="file-counter" id="file-counter">0 archivos</div>
            </div>
            
            <div class="nav-item" onclick="agenda.openModal('templates-modal')">
                <div class="nav-icon">
                    <i class="fas fa-layer-group"></i>
                </div>
                <h3>Plantillas</h3>
                <p>Guardar formatos recurrentes</p>
            </div>
        </div>

        <!-- CALENDARIO CON ZONA HORARIA CORREGIDA -->
        <section class="calendar-section">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" onclick="agenda.changeMonth(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h2 class="current-month" id="current-month"></h2>
                    <button class="calendar-nav-btn" onclick="agenda.changeMonth(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="timezone-info">
                    <i class="fas fa-clock"></i>
                    <span id="timezone-display">UTC-6 (Costa Rica)</span>
                </div>
                <button class="btn btn-primary" onclick="agenda.goToToday()">
                    <i class="fas fa-calendar-day"></i> Hoy
                </button>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <!-- Generado dinámicamente con fechas CORRECTAS -->
            </div>
        </section>

        <!-- GESTOR DE TAREAS CON PERSISTENCIA GARANTIZADA -->
        <section class="tasks-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    <span id="tasks-title">Tareas del Día</span>
                    <span class="data-status" id="data-status">
                        <i class="fas fa-check-circle"></i> Datos guardados
                    </span>
                </h2>
                <div class="task-stats">
                    <span class="stat-item">
                        <i class="fas fa-database"></i>
                        <span id="storage-used">0%</span> Almacenamiento
                    </span>
                    <span class="stat-item">
                        <i class="fas fa-shield-alt"></i>
                        <span id="backup-count">0</span> Backups
                    </span>
                    <span class="stat-item">
                        <i class="fas fa-history"></i>
                        <span id="auto-save">Auto-guardado: ON</span>
                    </span>
                </div>
            </div>
            
            <!-- FILTROS FUNCIONALES -->
            <div class="task-filters">
                <button class="filter-btn active" onclick="agenda.filterTasks('all')">Todas</button>
                <button class="filter-btn" onclick="agenda.filterTasks('today')">Hoy</button>
                <button class="filter-btn" onclick="agenda.filterTasks('week')">Esta Semana</button>
                <button class="filter-btn" onclick="agenda.filterTasks('pending')">Pendientes</button>
                <button class="filter-btn" onclick="agenda.filterTasks('completed')">Completadas</button>
                <button class="filter-btn" onclick="agenda.filterTasks('with-files')">
                    <i class="fas fa-paperclip"></i> Con Archivos
                </button>
            </div>
            
            <!-- LISTA DE TAREAS CON ARCHIVOS PERSISTENTES -->
            <div class="task-list" id="task-list">
                <!-- Las tareas se cargan con sus archivos REALES -->
            </div>
            
            <!-- SISTEMA DE AUTO-GUARDADO -->
            <div class="autosave-indicator">
                <i class="fas fa-sync-alt fa-spin" id="save-spinner"></i>
                <span id="last-save">Último guardado: Justo ahora</span>
            </div>
        </section>

        <!-- MODAL DE TAREAS CON PROTECCIÓN DE DATOS -->
        <div id="task-modal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="agenda.closeTaskModal('cancel')">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    <span id="modal-title">Nueva Tarea</span>
                    <span class="edit-warning" id="edit-warning">
                        <i class="fas fa-exclamation-triangle"></i> Modo Edición
                    </span>
                </h2>
                
                <form id="task-form" onsubmit="return agenda.saveTaskWithProtection(event)">
                    <input type="hidden" id="task-id">
                    <input type="hidden" id="original-data">
                    
                    <!-- SELECTOR DE FECHA CON ZONA HORARIA -->
                    <div class="form-group">
                        <label for="task-date">
                            <i class="fas fa-calendar"></i> Fecha *
                            <span class="timezone-hint" id="date-timezone"></span>
                        </label>
                        <input type="date" id="task-date" class="form-control" required 
                               onchange="agenda.updateDateDisplay(this.value)">
                        <div class="date-preview" id="date-preview">
                            <!-- Muestra la fecha en formato legible con zona horaria -->
                        </div>
                    </div>
                    
                    <!-- GESTOR DE ARCHIVOS CON PREVISUALIZACIÓN REAL -->
                    <div class="form-group">
                        <label><i class="fas fa-paperclip"></i> Adjuntar Evidencias</label>
                        <div class="file-manager">
                            <div class="file-upload-area" id="file-upload-area">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Arrastra archivos aquí o haz clic para subir</p>
                                <input type="file" id="file-input" multiple 
                                       accept=".jpg,.jpeg,.png,.pdf,.docx,.doc,.ppt,.pptx,.csv,.xlsx,.txt">
                            </div>
                            <div class="file-preview-grid" id="file-preview-grid">
                                <!-- Previsualizaciones en miniatura REALES -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- SISTEMA DE RECORDATORIOS REAL -->
                    <div class="form-group">
                        <label><i class="fas fa-bell"></i> Recordatorio</label>
                        <div class="reminder-system">
                            <label class="checkbox-label">
                                <input type="checkbox" id="task-reminder" 
                                       onchange="agenda.toggleReminder(this.checked)">
                                <span>Activar recordatorio</span>
                            </label>
                            <div class="reminder-options" id="reminder-options">
                                <select id="reminder-time" class="form-control">
                                    <option value="5">5 minutos antes</option>
                                    <option value="15">15 minutos antes</option>
                                    <option value="30">30 minutos antes</option>
                                    <option value="60">1 hora antes</option>
                                    <option value="1440">1 día antes</option>
                                </select>
                                <button type="button" class="btn btn-sm" 
                                        onclick="agenda.testReminder()">
                                    <i class="fas fa-play"></i> Probar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BOTONES CON PROTECCIÓN DE DATOS -->
                    <div class="modal-actions protected">
                        <button type="button" class="btn btn-secondary" 
                                onclick="agenda.closeTaskModal('cancel')"
                                id="cancel-btn">
                            <i class="fas fa-times"></i> Cancelar
                            <span class="tooltip">Restaura los datos originales</span>
                        </button>
                        
                        <button type="button" class="btn btn-warning" 
                                onclick="agenda.saveAsTemplate()"
                                id="template-btn">
                            <i class="fas fa-save"></i> Guardar Plantilla
                            <span class="tooltip">Crea un formato reusable</span>
                        </button>
                        
                        <button type="submit" class="btn btn-primary" id="save-btn">
                            <i class="fas fa-save"></i> Guardar Tarea
                            <span class="tooltip">Guarda con persistencia total</span>
                        </button>
                        
                        <button type="button" class="btn btn-success" 
                                onclick="agenda.saveAndShare()"
                                id="share-btn">
                            <i class="fas fa-paper-plane"></i> Guardar y Compartir
                            <span class="tooltip">Guarda y genera enlace para correo</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- VISOR DE ARCHIVOS PROFESIONAL -->
        <div id="file-viewer-modal" class="modal">
            <div class="modal-content file-viewer">
                <button class="modal-close" onclick="agenda.closeFileViewer()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="file-viewer-header">
                    <h3 id="viewer-filename"></h3>
                    <div class="file-actions">
                        <button class="btn btn-primary" onclick="agenda.downloadCurrentFile()">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                        <button class="btn btn-secondary" onclick="agenda.printFile()">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                        <button class="btn btn-success" onclick="agenda.shareFile()">
                            <i class="fas fa-share"></i> Compartir
                        </button>
                    </div>
                </div>
                <div class="file-viewer-content" id="file-viewer-content">
                    <!-- Contenido del archivo según tipo -->
                </div>
            </div>
        </div>

        <!-- SISTEMA DE BACKUP REAL -->
        <div id="backup-modal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="agenda.closeModal('backup-modal')">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="section-title">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Sistema de Backup
                </h2>
                
                <div class="backup-options">
                    <div class="backup-option" onclick="agenda.backupToLocal()">
                        <i class="fas fa-hdd"></i>
                        <h4>Backup Local</h4>
                        <p>Guarda en tu computadora</p>
                    </div>
                    
                    <div class="backup-option" onclick="agenda.backupToGoogleDrive()">
                        <i class="fab fa-google-drive"></i>
                        <h4>Google Drive</h4>
                        <p>Sincroniza con tu cuenta</p>
                        <div class="drive-status" id="drive-status">
                            No conectado
                        </div>
                    </div>
                    
                    <div class="backup-option" onclick="agenda.backupToEmail()">
                        <i class="fas fa-envelope"></i>
                        <h4>Enviar por Correo</h4>
                        <p>Recibe backup en tu email</p>
                    </div>
                </div>
                
                <div class="backup-history">
                    <h4><i class="fas fa-history"></i> Historial de Backups</h4>
                    <div class="backup-list" id="backup-list">
                        <!-- Lista de backups realizados -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SISTEMA DE PLANTILLAS FUNCIONAL -->
        <div id="templates-modal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="agenda.closeModal('templates-modal')">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="section-title">
                    <i class="fas fa-layer-group"></i>
                    Plantillas Guardadas
                </h2>
                
                <div class="templates-actions">
                    <button class="btn btn-primary" onclick="agenda.createNewTemplate()">
                        <i class="fas fa-plus"></i> Nueva Plantilla
                    </button>
                    <button class="btn btn-secondary" onclick="agenda.importTemplates()">
                        <i class="fas fa-file-import"></i> Importar
                    </button>
                    <button class="btn btn-success" onclick="agenda.exportTemplates()">
                        <i class="fas fa-file-export"></i> Exportar Todas
                    </button>
                </div>
                
                <div class="templates-grid" id="templates-grid">
                    <!-- Plantillas cargadas dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- SISTEMA DE NOTIFICACIONES DEL NAVEGADOR -->
    <div id="notification-permission" class="notification-permission">
        <div class="permission-content">
            <i class="fas fa-bell"></i>
            <h3>Activar Recordatorios</h3>
            <p>Permite notificaciones para recibir recordatorios de tus tareas</p>
            <button class="btn btn-primary" onclick="agenda.requestNotificationPermission()">
                Activar Notificaciones
            </button>
            <button class="btn btn-secondary" onclick="agenda.hidePermissionRequest()">
                Ahora no
            </button>
        </div>
    </div>

    <!-- SISTEMA DE SINCRONIZACIÓN EN SEGUNDO PLANO -->
    <div id="sync-indicator">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span>Sincronizando...</span>
    </div>

    <!-- SCRIPTS PRINCIPALES -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="app.js"></script>
    <script src="fileManager.js"></script>
    <script src="exportManager.js"></script>
    <script src="backupManager.js"></script>
    
    <script>
        // Inicializar aplicación con todas las funcionalidades
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar gestor principal
            window.agenda = new AgendaDRTE();
            
            // Configurar auto-guardado cada 30 segundos
            setInterval(() => {
                agenda.autoSave();
            }, 30000);
            
            // Configurar verificación de backup cada hora
            setInterval(() => {
                agenda.checkBackupStatus();
            }, 3600000);
            
            // Cargar datos existentes
            agenda.loadAllData();
            
            // Configurar zona horaria de Costa Rica
            agenda.setTimezone('America/Costa_Rica');
            
            // Solicitar permiso para notificaciones después de 5 segundos
            setTimeout(() => {
                agenda.checkNotificationPermission();
            }, 5000);
        });
    </script>
</body>
</html>
