<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéì IDOMEP v4.0 ¬∑ Sistema Adaptativo Profesional</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Mammoth.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <style>
        body { background: #f0f9ff; font-family: system-ui, sans-serif; }
        .card { background: white; border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .ruta-item { transition: all 0.3s; cursor: pointer; border: 2px solid transparent; }
        .ruta-item.disponible:hover { transform: translateY(-4px); border-color: #3b82f6; }
        .tab-button.active { background: #2563eb; color: white; }
        .calidad-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        .dificultad-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        .feedback-panel {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            margin-top: 12px;
            border-radius: 8px;
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <!-- BARRA SUPERIOR -->
    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b shadow-sm mb-4">
        <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
            <span class="font-bold text-xl">üéì IDOMEP <span class="text-blue-600">v4.0</span> 
                <span class="calidad-badge">ADAPTATIVO</span>
                <span class="calidad-badge" style="background: #059669">ANALYTICS</span>
            </span>
            <div class="flex gap-1 bg-slate-100 p-1 rounded-lg">
                <button data-tab="inicio" class="tab-button px-4 py-1.5 rounded-lg text-sm active">üìö Inicio</button>
                <button data-tab="duolingo" class="tab-button px-4 py-1.5 rounded-lg text-sm">üéÆ IdoMep</button>
                <button data-tab="simulador" class="tab-button px-4 py-1.5 rounded-lg text-sm">üìù Simulacro</button>
                <button data-tab="reporte" class="tab-button px-4 py-1.5 rounded-lg text-sm">üìä Progreso</button>
                <button data-tab="analytics" class="tab-button px-4 py-1.5 rounded-lg text-sm">üìà Analytics</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- ========== TAB INICIO ========== -->
        <div id="tab-inicio" class="tab-content block">
            <div class="card mb-6 border-l-8 border-blue-600">
                <h2 class="text-2xl font-bold mb-2">üìö Sistema Adaptativo MEP</h2>
                <p class="text-gray-600">Cargue sus documentos. El sistema aprende de sus respuestas y se adapta.</p>
                <div class="mt-3 grid grid-cols-3 gap-2 text-sm">
                    <div class="bg-blue-50 p-2 rounded"><span class="font-bold">FASE 4:</span> Analytics en tiempo real</div>
                    <div class="bg-green-50 p-2 rounded"><span class="font-bold">FASE 5:</span> Banco expansivo</div>
                    <div class="bg-purple-50 p-2 rounded"><span class="font-bold">FASE 6:</span> Personalizaci√≥n</div>
                </div>
            </div>

            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üéØ Seleccione su estrato</h3>
                <div class="flex flex-wrap gap-3" id="selector-estrato">
                    <button data-estrato="docente" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100">Propiamente Docente</button>
                    <button data-estrato="tecnico" class="estrato-btn px-5 py-2 rounded-full bg-blue-600 text-white">T√©cnico Docente (Asesores)</button>
                    <button data-estrato="administrativo" class="estrato-btn px-5 py-2 rounded-full bg-slate-100 hover:bg-blue-100">Administrativo Docente</button>
                </div>
            </div>

            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üìÅ Cargue sus documentos</h3>
                <input type="file" id="carga-docs" multiple accept=".pdf,.txt,.docx,.doc" class="mb-4 w-full p-2 border rounded-lg">
                <div id="lista-docs" class="text-sm max-h-40 overflow-y-auto bg-slate-50 p-3 rounded-lg hidden"></div>
                <div id="progreso-carga" class="text-xs text-gray-500 mt-2"></div>
            </div>

            <div class="card">
                <h3 class="font-bold text-lg mb-4">üìã Competencias a evaluar</h3>
                <div id="competencias-container" class="space-y-3"></div>
            </div>
        </div>

        <!-- ========== TAB IDOMEP ========== -->
        <div id="tab-duolingo" class="tab-content hidden">
            <!-- Panel XP -->
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-2xl shadow-xl p-6 mb-6 text-white">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <span class="text-4xl">üéÆ</span>
                        <div>
                            <h2 class="text-2xl font-black">Ruta adaptativa</h2>
                            <p class="text-blue-100">Preguntas que se ajustan a su nivel</p>
                        </div>
                    </div>
                    <div class="flex gap-6">
                        <div class="text-center"><span class="text-sm">NIVEL</span><div class="text-2xl font-bold" id="nivel-duolingo">1</div></div>
                        <div class="text-center"><span class="text-sm">RANGO</span><div class="text-lg font-bold" id="rango-duolingo">Bronce</div></div>
                        <div class="text-center"><span class="text-sm">RACHA</span><div class="text-lg font-bold" id="racha-duolingo">0</div></div>
                        <div class="flex text-2xl" id="vidas-duolingo">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>XP: <span id="xp-duolingo">0</span></span>
                        <span>Confianza: <span id="confianza-duolingo">0%</span></span>
                    </div>
                    <div class="w-full bg-white/30 h-3 rounded-full overflow-hidden">
                        <div class="bg-yellow-400 h-3 rounded-full" id="barra-xp-duolingo" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <!-- Ruta -->
            <div class="card mb-6">
                <h3 class="font-bold text-lg mb-4">üó∫Ô∏è Ruta personalizada</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="ruta-container"></div>
            </div>

            <!-- Pregunta adaptativa -->
            <div class="card">
                <div id="pregunta-header" class="flex justify-between items-center mb-4">
                    <span class="bg-indigo-100 px-3 py-1 rounded-full text-sm" id="competencia-actual-tag">üìò 1.1 √Årea disciplinar</span>
                    <div>
                        <span class="text-xs text-gray-500" id="nivel-pregunta-tag">üü¢ Conceptual</span>
                        <span class="ml-2 dificultad-badge" id="dificultad-badge" style="background: #e5e7eb">Dificultad: media</span>
                    </div>
                </div>
                <div id="pregunta-container" class="min-h-[300px]">
                    <div class="text-center text-gray-500 py-12">Cargue documentos y seleccione una competencia</div>
                </div>
                <div id="feedback-usuario" class="feedback-panel hidden">
                    <p class="text-sm font-medium">üìù ¬øEsta pregunta fue?</p>
                    <div class="flex gap-2 mt-2">
                        <button onclick="reportarCalidad('muy_facil')" class="text-xs bg-gray-200 px-3 py-1 rounded-full">üòä Muy f√°cil</button>
                        <button onclick="reportarCalidad('adecuada')" class="text-xs bg-gray-200 px-3 py-1 rounded-full">üëç Adecuada</button>
                        <button onclick="reportarCalidad('muy_dificil')" class="text-xs bg-gray-200 px-3 py-1 rounded-full">üòì Muy dif√≠cil</button>
                        <button onclick="reportarCalidad('confusa')" class="text-xs bg-gray-200 px-3 py-1 rounded-full">ü§î Confusa</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== TAB SIMULADOR ========== -->
        <div id="tab-simulador" class="tab-content hidden">
            <div class="card mb-6">
                <h2 class="text-2xl font-bold mb-4">üìù Simulacro adaptativo</h2>
                <button id="btn-iniciar-simulacro" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700">
                    Iniciar simulacro personalizado
                </button>
                <div id="estado-simulacro" class="hidden mb-4 p-4 bg-blue-50 rounded-lg mt-4">
                    <div class="flex justify-between"><span>Progreso: <span id="simulacro-progreso">0/60</span></span><span>Correctas: <span id="simulacro-correctas">0</span></span><span>Nota: <span id="simulacro-nota">0%</span></span></div>
                    <div class="w-full bg-gray-200 h-2 rounded-full mt-2"><div class="bg-blue-600 h-2 rounded-full" id="simulacro-barra" style="width:0%"></div></div>
                </div>
                <div id="simulacro-container" class="min-h-[300px]"></div>
                <div id="resultado-simulador" class="mt-6"></div>
            </div>
        </div>

        <!-- ========== TAB REPORTE ========== -->
        <div id="tab-reporte" class="tab-content hidden">
            <div class="card">
                <h2 class="text-2xl font-bold mb-6">üìä Progreso personal</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div><h3 class="font-bold text-lg mb-4">Rendimiento por competencia</h3><div id="reporte-competencias" class="space-y-4"></div></div>
                    <div><h3 class="font-bold text-lg mb-4">Gr√°fico de dominio</h3><canvas id="radar-competencias" width="300" height="300"></canvas></div>
                </div>
                <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">üìà Estad√≠sticas globales</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="estadisticas-globales"></div>
                </div>
            </div>
        </div>

        <!-- ========== NUEVO TAB: ANALYTICS ========== -->
        <div id="tab-analytics" class="tab-content hidden">
            <div class="card mb-6">
                <h2 class="text-2xl font-bold mb-4">üìà Panel de Analytics</h2>
                <p class="text-gray-600 mb-4">An√°lisis en tiempo real de su aprendizaje y calidad de preguntas</p>
                
                <!-- M√©tricas de calidad -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <span class="text-sm text-gray-500">Precisi√≥n general</span>
                        <p class="text-3xl font-bold" id="precision-general">0%</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <span class="text-sm text-gray-500">Nivel de confianza</span>
                        <p class="text-3xl font-bold" id="nivel-confianza">0%</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <span class="text-sm text-gray-500">Preguntas reportadas</span>
                        <p class="text-3xl font-bold" id="preguntas-reportadas">0</p>
                    </div>
                </div>

                <!-- Gr√°ficos de analytics -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold mb-2">Distribuci√≥n de dificultad</h3>
                        <canvas id="grafico-dificultad" width="300" height="200"></canvas>
                    </div>
                    <div>
                        <h3 class="font-bold mb-2">Rendimiento por nivel</h3>
                        <canvas id="grafico-rendimiento" width="300" height="200"></canvas>
                    </div>
                </div>

                <!-- Recomendaciones personalizadas -->
                <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                    <h3 class="font-bold text-lg mb-2">üéØ Recomendaciones personalizadas</h3>
                    <div id="recomendaciones-container" class="space-y-2"></div>
                </div>

                <!-- Banco de preguntas mejoradas -->
                <div class="mt-6">
                    <h3 class="font-bold text-lg mb-2">üìö Banco de preguntas mejoradas</h3>
                    <p class="text-sm text-gray-600 mb-2">Basado en feedback de usuarios, estas preguntas han sido optimizadas:</p>
                    <div id="banco-mejorado" class="max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-500">Cargando estad√≠sticas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const VERSION = '4.0';
        const XP_POR_NIVEL = 200;

        // ============================================
        // SISTEMA DE ANALYTICS (FASE 4)
        // ============================================
        class AnalyticsSystem {
            constructor() {
                this.metricas = this.cargarMetricas() || {
                    preguntas: {}, // id -> { total: n, correctas: n, tiempos: [], feedback: [] }
                    competencias: {
                        '1.1': { total: 0, correctas: 0, dificultadMedia: 0 },
                        '1.2': { total: 0, correctas: 0, dificultadMedia: 0 },
                        '1.3': { total: 0, correctas: 0, dificultadMedia: 0 },
                        '2.1': { total: 0, correctas: 0, dificultadMedia: 0 },
                        '2.3': { total: 0, correctas: 0, dificultadMedia: 0 }
                    },
                    niveles: {
                        conceptual: { total: 0, correctas: 0 },
                        aplicado: { total: 0, correctas: 0 },
                        normativo: { total: 0, correctas: 0 }
                    },
                    feedbackUsuarios: [], // registro de feedback
                    preguntasMejoradas: {}, // preguntas que han recibido feedback positivo
                    tendencias: {
                        ultimaSemana: [],
                        mejoraContinua: 0
                    },
                    calidadPromedio: 0.8 // m√©trica inicial
                };
            }

            cargarMetricas() {
                const data = localStorage.getItem('analyticsIDOMEP');
                return data ? JSON.parse(data) : null;
            }

            guardarMetricas() {
                localStorage.setItem('analyticsIDOMEP', JSON.stringify(this.metricas));
            }

            registrarRespuesta(preguntaId, competencia, nivel, correcta, tiempo) {
                // Registrar en preguntas
                if (!this.metricas.preguntas[preguntaId]) {
                    this.metricas.preguntas[preguntaId] = { 
                        total: 0, 
                        correctas: 0, 
                        tiempos: [],
                        feedback: [],
                        competencia,
                        nivel
                    };
                }
                
                const p = this.metricas.preguntas[preguntaId];
                p.total++;
                if (correcta) p.correctas++;
                p.tiempos.push(tiempo);
                
                // Registrar en competencias
                const c = this.metricas.competencias[competencia];
                if (c) {
                    c.total++;
                    if (correcta) c.correctas++;
                    c.dificultadMedia = 1 - (c.correctas / c.total); // 0=f√°cil, 1=dif√≠cil
                }
                
                // Registrar en niveles
                const nl = this.metricas.niveles[nivel];
                if (nl) {
                    nl.total++;
                    if (correcta) nl.correctas++;
                }
                
                // Calcular calidad promedio
                this.calcularCalidad();
                this.guardarMetricas();
            }

            registrarFeedback(preguntaId, tipoFeedback) {
                const p = this.metricas.preguntas[preguntaId];
                if (p) {
                    p.feedback.push(tipoFeedback);
                    
                    // Si es feedback positivo, marcar para mejora
                    if (tipoFeedback === 'adecuada') {
                        this.metricas.preguntasMejoradas[preguntaId] = {
                            ...p,
                            vecesMejorada: (this.metricas.preguntasMejoradas[preguntaId]?.vecesMejorada || 0) + 1
                        };
                    }
                    
                    // Si es feedback negativo, reducir calidad
                    if (tipoFeedback === 'confusa' || tipoFeedback === 'muy_dificil') {
                        this.metricas.calidadPromedio = Math.max(0.5, this.metricas.calidadPromedio - 0.05);
                    }
                }
                
                this.metricas.feedbackUsuarios.push({
                    preguntaId,
                    tipo: tipoFeedback,
                    fecha: new Date().toISOString()
                });
                
                this.guardarMetricas();
            }

            calcularCalidad() {
                // F√≥rmula de calidad basada en m√∫ltiples factores
                let totalPuntos = 0;
                let totalMetricas = 0;
                
                // 1. Tasa de aciertos ideal (ni muy f√°cil ni muy dif√≠cil)
                for (let p of Object.values(this.metricas.preguntas)) {
                    if (p.total > 5) {
                        const tasaAciertos = p.correctas / p.total;
                        // Puntuaci√≥n: 1 si tasa entre 0.6 y 0.8, disminuye si se aleja
                        const puntuacion = tasaAciertos >= 0.6 && tasaAciertos <= 0.8 ? 1 :
                                         1 - Math.min(1, Math.abs(tasaAciertos - 0.7) * 2);
                        totalPuntos += puntuacion;
                        totalMetricas++;
                    }
                }
                
                // 2. Feedback de usuarios
                const feedbackPositivo = this.metricas.feedbackUsuarios.filter(f => f.tipo === 'adecuada').length;
                const feedbackTotal = this.metricas.feedbackUsuarios.length;
                if (feedbackTotal > 0) {
                    totalPuntos += feedbackPositivo / feedbackTotal;
                    totalMetricas++;
                }
                
                this.metricas.calidadPromedio = totalMetricas > 0 ? totalPuntos / totalMetricas : 0.8;
                return this.metricas.calidadPromedio;
            }

            obtenerRecomendaciones(usuario) {
                const recoms = [];
                
                // 1. Competencias d√©biles
                for (let [comp, data] of Object.entries(this.metricas.competencias)) {
                    if (data.total > 5 && (data.correctas / data.total) < 0.6) {
                        recoms.push(`üî¥ Necesita reforzar competencia ${comp} (${Math.round(data.correctas/data.total*100)}% aciertos)`);
                    }
                }
                
                // 2. Niveles a mejorar
                for (let [nivel, data] of Object.entries(this.metricas.niveles)) {
                    if (data.total > 3 && (data.correctas / data.total) < 0.5) {
                        recoms.push(`üìö Practique m√°s preguntas de nivel ${nivel}`);
                    }
                }
                
                // 3. Sugerencias de estudio
                if (usuario.nivel.xp < 500) {
                    recoms.push("üí° Contin√∫e con preguntas conceptuales para construir base");
                } else if (usuario.nivel.xp < 1000) {
                    recoms.push("üéØ Incorpore m√°s preguntas aplicadas y casos pr√°cticos");
                } else {
                    recoms.push("üèÜ Desaf√≠ese con preguntas normativas complejas");
                }
                
                return recoms;
            }
        }

        // ============================================
        // BANCO EXPANSIVO DE PREGUNTAS (FASE 5)
        // ============================================
        class BancoExpansivo {
            constructor() {
                this.bancoBase = {
                    '1.1': {
                        situaciones: [
                            'Un docente le comenta: "Mis estudiantes aprueban los ex√°menes pero al mes ya no recuerdan nada".',
                            'En una reuni√≥n de ciclo, varios docentes expresan que "los estudiantes no ven sentido a lo que aprenden".',
                            'Un director le pide orientaci√≥n para mejorar los resultados en comprensi√≥n lectora.',
                            'Durante una asesor√≠a, un docente dice: "Ya expliqu√© el tema tres veces y a√∫n hay estudiantes que no entienden".',
                            'Un equipo docente debate si priorizar la cobertura del programa o la profundidad de los aprendizajes.',
                            // Nuevas situaciones (expansi√≥n)
                            'Un docente novel solicita ayuda para planificar sus primeras lecciones.',
                            'Se observa que los estudiantes tienen dificultades para transferir lo aprendido a nuevos contextos.',
                            'Un grupo de docentes quiere implementar aprendizaje basado en proyectos pero no sabe c√≥mo empezar.'
                        ],
                        distractores: [
                            'Aplicar la misma estrategia pero con m√°s ejercicios de repetici√≥n',
                            'Reducir la complejidad de los contenidos para facilitar la aprobaci√≥n',
                            'Esperar que los estudiantes "maduren" y comprendan con el tiempo',
                            'Atribuir las dificultades exclusivamente a la falta de inter√©s de los estudiantes',
                            'Utilizar √∫nicamente la memorizaci√≥n como estrategia principal',
                            'Evaluar solo al final del per√≠odo sin retroalimentaci√≥n intermedia',
                            // Nuevos distractores
                            'Sugerir cambiar de tema si los estudiantes no entienden',
                            'Atribuir las dificultades a problemas de disciplina'
                        ]
                    },
                    '1.2': {
                        situaciones: [
                            'Un director debe nombrar en propiedad a un docente interino que cumple 3 a√±os. El docente alega que "la experiencia es suficiente".',
                            'Durante un proceso de auditor√≠a, encuentran que un centro educativo no tiene actualizado su reglamento interno.',
                            'Una asociaci√≥n de padres solicita revisar la aplicaci√≥n del C√≥digo de la Ni√±ez en el centro.',
                            'Un asesor legal recibe consulta sobre si un docente puede ser sancionado por una falta cometida hace dos a√±os.',
                            'Un director regional debe interpretar una circular que parece contradecir el Estatuto de Servicio Civil.',
                            // Nuevas
                            'Un docente solicita licencia por maternidad y hay confusi√≥n sobre sus derechos.',
                            'Se detecta que un centro educativo no est√° aplicando correctamente el protocolo de acoso escolar.'
                        ],
                        distractores: [
                            'Aplicar el criterio de "siempre se ha hecho as√≠" aunque no est√© normado',
                            'Resolver bas√°ndose en la opini√≥n personal del director sin respaldo legal',
                            'Confundir la normativa con pr√°cticas administrativas informales',
                            'Asumir que la experiencia laboral sustituye requisitos acad√©micos',
                            'Aplicar normas derogadas por desconocimiento de actualizaciones',
                            'Interpretar la ley de manera literal sin considerar su esp√≠ritu',
                            // Nuevos
                            'Esperar a que el problema se resuelva en instancias superiores',
                            'Aplicar el criterio m√°s favorable al funcionario sin verificar normativa'
                        ]
                    },
                    '1.3': {
                        situaciones: [
                            'Un asesor regional recibe consultas contradictorias de dos direcciones regionales sobre la misma circular.',
                            'Se detecta que un centro educativo no est√° reportando informaci√≥n requerida por el nivel central.',
                            'Un coordinador debe mediar entre las directrices del nivel central y las necesidades de su instituci√≥n.',
                            'Durante una reuni√≥n, no queda claro si una decisi√≥n corresponde al director, al asesor o al nivel regional.',
                            'Un nuevo funcionario pregunta cu√°l es el canal adecuado para reportar una irregularidad.'
                        ],
                        distractores: [
                            'Resolver seg√∫n el criterio personal para agilizar el proceso',
                            'Ignorar las directrices centrales si parecen poco pr√°cticas',
                            'Asumir que todos los niveles tienen las mismas competencias',
                            'Comunicarse informalmente saltando canales establecidos',
                            'Esperar a que el problema se resuelva solo',
                            'Documentar pero no reportar formalmente'
                        ]
                    },
                    '2.1': {
                        situaciones: [
                            'El equipo de planificaci√≥n debe dise√±ar un proyecto para mejorar la convivencia escolar.',
                            'Un comit√© t√©cnico necesita alinear su plan anual con el PPPJ.',
                            'Se requiere elaborar un proyecto para reducir la deserci√≥n estudiantil.',
                            'Una direcci√≥n regional solicita proyectos innovadores para mejorar resultados en matem√°ticas.',
                            'Un asesor debe validar si un proyecto institucional cumple con los lineamientos del MEP.'
                        ],
                        distractores: [
                            'Copiar proyectos exitosos de otros centros sin adaptarlos',
                            'Dise√±ar el proyecto basado √∫nicamente en recursos disponibles',
                            'Priorizar actividades vistosas sobre resultados medibles',
                            'Omitir la evaluaci√≥n del impacto del proyecto',
                            'Involucrar solo al equipo directivo en el dise√±o',
                            'Establecer metas sin indicadores verificables'
                        ]
                    },
                    '2.3': {
                        situaciones: [
                            'Un coordinador TIC debe asesorar sobre la implementaci√≥n de la transformaci√≥n digital.',
                            'Se requiere capacitar a docentes en el uso de plataformas educativas.',
                            'Un director quiere integrar tecnolog√≠a pero el personal se resiste.',
                            'El centro educativo recibe tablets pero no hay plan pedag√≥gico para usarlas.',
                            'Un asesor debe recomendar herramientas digitales para evaluaci√≥n formativa.'
                        ],
                        distractores: [
                            'Imponer el uso de tecnolog√≠a sin capacitaci√≥n previa',
                            'Utilizar la tecnolog√≠a solo como sustituto del cuaderno',
                            'Adquirir equipos sin plan pedag√≥gico asociado',
                            'Resistirse al cambio por temor a lo desconocido',
                            'Usar tecnolog√≠a solo para entretenimiento',
                            'Delegar completamente en el especialista TIC sin involucrarse'
                        ]
                    }
                };
                
                this.bancoExpandido = this.cargarBanco() || this.bancoBase;
                this.preguntasGeneradas = new Set();
            }

            cargarBanco() {
                const data = localStorage.getItem('bancoExpandidoIDOMEP');
                return data ? JSON.parse(data) : null;
            }

            guardarBanco() {
                localStorage.setItem('bancoExpandidoIDOMEP', JSON.stringify(this.bancoExpandido));
            }

            // Expande el banco con nuevas situaciones basadas en feedback
            expandirConFeedback(feedback) {
                const competencia = feedback.competencia;
                if (!this.bancoExpandido[competencia]) return;
                
                // Si hay feedback positivo recurrente, crear variantes
                if (feedback.tipo === 'adecuada' && feedback.veces > 3) {
                    const situacionOriginal = feedback.situacion;
                    const variante = situacionOriginal
                        .replace('docente', 'profesor')
                        .replace('director', 'asesor')
                        .replace('estudiantes', 'alumnos');
                    
                    if (!this.bancoExpandido[competencia].situaciones.includes(variante)) {
                        this.bancoExpandido[competencia].situaciones.push(variante);
                    }
                }
                
                this.guardarBanco();
            }

            obtenerSituacion(competencia) {
                const lista = this.bancoExpandido[competencia]?.situaciones || this.bancoBase['1.1'].situaciones;
                return lista[Math.floor(Math.random() * lista.length)];
            }

            obtenerDistractores(competencia, cantidad = 3) {
                const lista = this.bancoExpandido[competencia]?.distractores || this.bancoBase['1.1'].distractores;
                const seleccionados = [];
                const copia = [...lista];
                for (let i = 0; i < cantidad; i++) {
                    if (copia.length === 0) break;
                    const idx = Math.floor(Math.random() * copia.length);
                    seleccionados.push(copia.splice(idx, 1)[0]);
                }
                return seleccionados;
            }
        }

        // ============================================
        // SISTEMA DE PERSONALIZACI√ìN (FASE 6)
        // ============================================
        class Personalizador {
            constructor(usuario, analytics) {
                this.usuario = usuario;
                this.analytics = analytics;
                this.perfil = this.cargarPerfil() || {
                    nivelConfianza: 0.5,
                    estilos: [], // visual, pr√°ctico, te√≥rico
                    competenciasFuertes: [],
                    competenciasDebiles: [],
                    tiempoPromedioRespuesta: 0,
                    dificultadPreferida: 0.5, // 0=f√°cil, 1=dif√≠cil
                    ultimaAdaptacion: null
                };
            }

            cargarPerfil() {
                const data = localStorage.getItem('perfilPersonalIDOMEP');
                return data ? JSON.parse(data) : null;
            }

            guardarPerfil() {
                localStorage.setItem('perfilPersonalIDOMEP', JSON.stringify(this.perfil));
            }

            // Ajusta dificultad basada en rendimiento
            calcularDificultadOptima(competencia) {
                const dataComp = this.analytics.metricas.competencias[competencia];
                if (!dataComp || dataComp.total < 5) return 0.5; // dificultad media por defecto
                
                const tasaAciertos = dataComp.correctas / dataComp.total;
                
                // Si acierta mucho (>80%), aumentar dificultad
                if (tasaAciertos > 0.8) {
                    return Math.min(1, this.perfil.dificultadPreferida + 0.1);
                }
                // Si acierta poco (<50%), reducir dificultad
                if (tasaAciertos < 0.5) {
                    return Math.max(0, this.perfil.dificultadPreferida - 0.1);
                }
                
                return this.perfil.dificultadPreferida;
            }

            // Selecciona el nivel de pregunta adecuado
            seleccionarNivel(competencia) {
                const dificultad = this.calcularDificultadOptima(competencia);
                
                // Mapear dificultad a nivel
                if (dificultad < 0.3) return 'conceptual';
                if (dificultad < 0.6) return 'aplicado';
                return 'normativo';
            }

            // Actualiza perfil con nueva respuesta
            actualizarConRespuesta(pregunta, correcta, tiempo) {
                // Actualizar tiempo promedio
                if (!this.perfil.tiempoPromedioRespuesta) {
                    this.perfil.tiempoPromedioRespuesta = tiempo;
                } else {
                    this.perfil.tiempoPromedioRespuesta = 
                        (this.perfil.tiempoPromedioRespuesta * 0.7) + (tiempo * 0.3);
                }
                
                // Actualizar confianza
                const aciertos = this.usuario.estadisticas.totalCorrectas;
                const total = this.usuario.estadisticas.totalPreguntas || 1;
                this.perfil.nivelConfianza = aciertos / total;
                
                this.guardarPerfil();
            }

            obtenerRecomendacionPersonalizada() {
                const recoms = [];
                
                // Basado en tiempo de respuesta
                if (this.perfil.tiempoPromedioRespuesta > 30) {
                    recoms.push("‚è±Ô∏è Est√° tomando m√°s tiempo del promedio. Practique con preguntas m√°s cortas inicialmente.");
                }
                
                // Basado en confianza
                if (this.perfil.nivelConfianza < 0.5) {
                    recoms.push("üìò Recomendamos repasar los fundamentos antes de continuar con casos complejos.");
                } else if (this.perfil.nivelConfianza > 0.8) {
                    recoms.push("üöÄ Excelente rendimiento! Aumentando dificultad de preguntas.");
                }
                
                return recoms;
            }
        }

        // ============================================
        // PERFILES MEP
        // ============================================
        const perfilesMEP = {
            tecnico: {
                nombre: 'T√©cnico Docente (Asesores)',
                competencias: [
                    { codigo: '1.1', nombre: '√Årea disciplinar, pedag√≥gica y curricular', saber: true },
                    { codigo: '1.2', nombre: 'Marco jur√≠dico, √©tico y pol√≠ticas p√∫blicas', saber: true },
                    { codigo: '1.3', nombre: 'Estructura organizacional del MEP', saber: true },
                    { codigo: '2.1', nombre: 'Dise√±o de planes, programas y proyectos', saber: false },
                    { codigo: '2.3', nombre: 'Liderazgo, asesor√≠a y TIC', saber: false }
                ]
            },
            docente: {
                nombre: 'Propiamente Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Conocimiento de estudiantes', saber: true },
                    { codigo: '1.2', nombre: 'Dominio disciplinar', saber: true },
                    { codigo: '1.3', nombre: 'Pol√≠ticas y normativa', saber: true },
                    { codigo: '2.1', nombre: 'Dise√±o de experiencias', saber: false },
                    { codigo: '2.2', nombre: 'Mediaci√≥n pedag√≥gica', saber: false },
                    { codigo: '2.3', nombre: 'Evaluaci√≥n', saber: false }
                ]
            },
            administrativo: {
                nombre: 'Administrativo Docente',
                competencias: [
                    { codigo: '1.1', nombre: 'Liderazgo pedag√≥gico', saber: true },
                    { codigo: '1.4', nombre: 'Tecnolog√≠as', saber: true },
                    { codigo: '2.3', nombre: 'Gesti√≥n de recursos', saber: false },
                    { codigo: '2.4', nombre: 'Seguridad informaci√≥n', saber: false },
                    { codigo: '2.5', nombre: 'Liderazgo', saber: false }
                ]
            }
        };

        // ============================================
        // GENERADOR DE PREGUNTAS ADAPTATIVO
        // ============================================
        class GeneradorAdaptativo {
            constructor(documentos, analytics, banco, personalizador) {
                this.docs = documentos;
                this.analytics = analytics;
                this.banco = banco;
                this.personalizador = personalizador;
            }

            generarPreguntaPersonalizada(competenciaCodigo) {
                // 1. Obtener nivel √≥ptimo seg√∫n perfil
                const nivel = this.personalizador.seleccionarNivel(competenciaCodigo);
                
                // 2. Obtener situaci√≥n del banco expansivo
                const situacion = this.banco.obtenerSituacion(competenciaCodigo);
                
                // 3. Seleccionar documento
                const doc = this.docs[Math.floor(Math.random() * this.docs.length)];
                
                // 4. Generar opci√≥n correcta basada en documento
                const fragmento = doc.contenido.substring(0, 200).split('.')[0];
                const correcta = {
                    texto: `Fundamentar seg√∫n ${doc.nombre}: ${fragmento.substring(0, 100)}...`,
                    correcta: true
                };
                
                // 5. Obtener distractores del banco
                const distractores = this.banco.obtenerDistractores(competenciaCodigo, 3)
                    .map(d => ({ texto: d, correcta: false }));
                
                // 6. Mezclar opciones
                const opciones = [correcta, ...distractores];
                const posCorrecta = Math.floor(Math.random() * 4);
                const temp = opciones[0];
                opciones[0] = opciones[posCorrecta];
                opciones[posCorrecta] = temp;
                
                // 7. Calcular XP seg√∫n nivel y dificultad
                const xpBase = nivel === 'normativo' ? 20 : (nivel === 'aplicado' ? 15 : 10);
                const dificultad = this.personalizador.calcularDificultadOptima(competenciaCodigo);
                const xp = Math.round(xpBase * (0.8 + dificultad * 0.4));
                
                return {
                    id: `adapt_${Date.now()}_${Math.random()}`,
                    competencia: competenciaCodigo,
                    texto: `${situacion}\n\n¬øCu√°l es la actuaci√≥n correcta seg√∫n la normativa y buenas pr√°cticas?`,
                    opciones: opciones,
                    correcta: posCorrecta,
                    fundamento: `‚úÖ Correcto. Esta actuaci√≥n se alinea con ${doc.nombre}`,
                    documento: doc.nombre,
                    nivel: nivel,
                    xp: xp,
                    dificultadCalculada: dificultad
                };
            }
        }

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let estratoActual = 'tecnico';
        let documentos = [];
        let analytics = new AnalyticsSystem();
        let banco = new BancoExpansivo();
        let personalizador = null;
        let generadorAdaptativo = null;
        
        let progresoUsuario = cargarProgreso() || {
            version: VERSION,
            nivel: { actual: 1, xp: 0, xpSiguiente: 200, rango: 'Bronce' },
            racha: { actual: 0, maxima: 0, ultimaFecha: null },
            competencias: {
                '1.1': { nivel: 0, xp: 0, dominada: false },
                '1.2': { nivel: 0, xp: 0, dominada: false },
                '1.3': { nivel: 0, xp: 0, dominada: false },
                '2.1': { nivel: 0, xp: 0, dominada: false },
                '2.3': { nivel: 0, xp: 0, dominada: false }
            },
            estadisticas: {
                totalPreguntas: 0,
                totalCorrectas: 0,
                totalIncorrectas: 0,
                simulacrosCompletados: 0,
                simulacrosAprobados: 0
            }
        };

        const rutaDuolingo = [
            { codigo: '1.1', nombre: '√Årea disciplinar', tipo: 'üìò', estado: 'disponible' },
            { codigo: '1.2', nombre: 'Marco jur√≠dico', tipo: 'üìò', estado: 'bloqueado' },
            { codigo: '1.3', nombre: 'Estructura MEP', tipo: 'üìò', estado: 'bloqueado' },
            { codigo: '2.1', nombre: 'Dise√±o proyectos', tipo: 'üõ†Ô∏è', estado: 'bloqueado' },
            { codigo: '2.3', nombre: 'Liderazgo TIC', tipo: 'üõ†Ô∏è', estado: 'bloqueado' }
        ];

        let preguntaActual = null;
        let competenciaActual = '1.1';
        let opcionSeleccionada = null;

        // ============================================
        // FUNCIONES DE PERSISTENCIA
        // ============================================
        function calcularChecksum(obj) {
            const str = JSON.stringify(obj) + 'IDOMEP_SECRET_2026';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return hash;
        }

        function guardarProgreso() {
            const copia = {...progresoUsuario};
            delete copia._checksum;
            copia._checksum = calcularChecksum(copia);
            localStorage.setItem('progresoIDOMEP', JSON.stringify(copia));
        }

        function cargarProgreso() {
            const guardado = localStorage.getItem('progresoIDOMEP');
            if (!guardado) return null;
            try {
                const data = JSON.parse(guardado);
                const checksum = data._checksum;
                delete data._checksum;
                if (calcularChecksum(data) !== checksum) return null;
                return data;
            } catch { return null; }
        }

        // ============================================
        // PROCESADOR DE ARCHIVOS
        // ============================================
        async function procesarArchivoUniversal(archivo) {
            try {
                const ext = archivo.name.split('.').pop().toLowerCase();
                let contenido = '';

                if (ext === 'pdf') {
                    const arrayBuffer = await archivo.arrayBuffer();
                    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    for (let i = 1; i <= Math.min(pdfDoc.numPages, 30); i++) {
                        const page = await pdfDoc.getPage(i);
                        const content = await page.getTextContent();
                        contenido += content.items.map(item => item.str).join(' ') + ' ';
                    }
                } else if (ext === 'docx' || ext === 'doc') {
                    const arrayBuffer = await archivo.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    contenido = result.value;
                } else {
                    contenido = await archivo.text();
                }

                contenido = contenido.toLowerCase().replace(/\s+/g, ' ').trim();
                return { nombre: archivo.name, contenido, tama√±o: archivo.size };
            } catch (error) {
                return { error: true, nombre: archivo.name, mensaje: error.message };
            }
        }

        // ============================================
        // FUNCIONES DE INTERFAZ
        // ============================================
        function renderizarCompetencias() {
            const perfil = perfilesMEP[estratoActual];
            let html = '';
            perfil.competencias.forEach(comp => {
                const nivel = progresoUsuario.competencias[comp.codigo]?.nivel || 0;
                const dataComp = analytics.metricas.competencias[comp.codigo];
                const aciertos = dataComp && dataComp.total > 0 ? 
                    Math.round(dataComp.correctas / dataComp.total * 100) : 0;
                
                html += `<div class="p-3 bg-slate-50 rounded-lg border-l-4 border-blue-500">
                    <div class="flex justify-between">
                        <span class="text-xs font-mono ${comp.saber ? 'bg-blue-200' : 'bg-green-200'} px-2 py-1 rounded-full">${comp.saber ? 'SABER' : 'HACER'}</span>
                        <span class="text-xs">Nivel ${nivel} | ${aciertos}%</span>
                    </div>
                    <span class="font-medium block mt-1">${comp.codigo} ${comp.nombre}</span>
                </div>`;
            });
            document.getElementById('competencias-container').innerHTML = html;
        }

        function renderizarRuta() {
            const container = document.getElementById('ruta-container');
            let html = '';
            rutaDuolingo.forEach(item => {
                const estado = progresoUsuario.competencias[item.codigo];
                const dataComp = analytics.metricas.competencias[item.codigo];
                const dificultad = dataComp && dataComp.total > 0 ? 
                    Math.round(dataComp.dificultadMedia * 100) : 50;
                
                html += `<div class="ruta-item ${item.estado} bg-slate-50 p-4 rounded-xl text-center" data-codigo="${item.codigo}">
                    <div class="text-3xl mb-2">${item.tipo}</div>
                    <div class="font-bold text-sm">${item.codigo}</div>
                    <div class="text-xs text-gray-600">${item.nombre}</div>
                    ${item.estado === 'disponible' ? `
                        <div class="w-full bg-gray-200 h-1 rounded-full mt-2">
                            <div class="bg-blue-600 h-1 rounded-full" style="width: ${estado?.nivel * 20 || 0}%"></div>
                        </div>
                        <div class="text-xs mt-1">Nivel ${estado?.nivel || 0} | D:${dificultad}%</div>
                    ` : '<div class="text-xs text-gray-400 mt-2">üîí Bloqueado</div>'}
                </div>`;
            });
            container.innerHTML = html;
            
            document.querySelectorAll('.ruta-item.disponible').forEach(item => {
                item.addEventListener('click', function() {
                    competenciaActual = this.dataset.codigo;
                    cargarPreguntaAdaptativa();
                });
            });
        }

        function actualizarUIDuolingo() {
            const xp = progresoUsuario.nivel.xp;
            const nivel = progresoUsuario.nivel.actual;
            const xpSiguiente = nivel * XP_POR_NIVEL;
            const xpActualNivel = xp - ((nivel-1) * XP_POR_NIVEL);
            const porcentaje = (xpActualNivel / XP_POR_NIVEL) * 100;
            
            document.getElementById('nivel-duolingo').textContent = nivel;
            document.getElementById('xp-duolingo').textContent = xp;
            document.getElementById('barra-xp-duolingo').style.width = Math.min(100, porcentaje) + '%';
            
            if (xp >= 2000) progresoUsuario.nivel.rango = 'Id√≥neo';
            else if (xp >= 1000) progresoUsuario.nivel.rango = 'Oro';
            else if (xp >= 500) progresoUsuario.nivel.rango = 'Plata';
            
            document.getElementById('rango-duolingo').textContent = progresoUsuario.nivel.rango;
            document.getElementById('racha-duolingo').textContent = progresoUsuario.racha.actual;
            
            const vidas = 3 - Math.floor(progresoUsuario.estadisticas.totalIncorrectas / 5);
            let vidasHtml = '';
            for (let i = 0; i < 3; i++) vidasHtml += i < vidas ? '‚ù§Ô∏è' : 'ü§ç';
            document.getElementById('vidas-duolingo').innerHTML = vidasHtml;
            
            // Confianza
            const total = progresoUsuario.estadisticas.totalPreguntas || 1;
            const confianza = Math.round(progresoUsuario.estadisticas.totalCorrectas / total * 100);
            document.getElementById('confianza-duolingo').textContent = confianza + '%';
        }

        // ============================================
        // PREGUNTA ADAPTATIVA
        // ============================================
        function cargarPreguntaAdaptativa() {
            if (!generadorAdaptativo || documentos.length === 0) {
                document.getElementById('pregunta-container').innerHTML = `
                    <div class="text-center text-amber-600 py-12">
                        <p class="font-medium">Primero cargue sus documentos</p>
                    </div>
                `;
                return;
            }
            
            const pregunta = generadorAdaptativo.generarPreguntaPersonalizada(competenciaActual);
            if (!pregunta) return;
            
            preguntaActual = pregunta;
            
            const compNombre = rutaDuolingo.find(r => r.codigo === competenciaActual).nombre;
            document.getElementById('competencia-actual-tag').innerHTML = 
                `${rutaDuolingo.find(r => r.codigo === competenciaActual).tipo} ${competenciaActual} ${compNombre}`;
            
            const niveles = { conceptual: 'üü¢ Conceptual', aplicado: 'üü° Aplicado', normativo: 'üî¥ Normativo' };
            document.getElementById('nivel-pregunta-tag').textContent = niveles[pregunta.nivel] || 'üü¢ Conceptual';
            
            // Badge de dificultad
            const badge = document.getElementById('dificultad-badge');
            badge.textContent = `Dificultad: ${pregunta.dificultadCalculada < 0.3 ? 'baja' : (pregunta.dificultadCalculada < 0.6 ? 'media' : 'alta')}`;
            badge.style.background = pregunta.dificultadCalculada < 0.3 ? '#dcfce7' : (pregunta.dificultadCalculada < 0.6 ? '#fef9c3' : '#fee2e2');
            
            let html = `
                <div>
                    <p class="text-lg font-medium mb-4 whitespace-pre-line">${pregunta.texto}</p>
                    <div class="space-y-3 mb-6">
            `;
            
            pregunta.opciones.forEach((op, idx) => {
                html += `
                    <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer"
                           onclick="seleccionarOpcionAdaptativa(this, ${idx})">
                        <span class="w-6 h-6 rounded-full border-2 flex items-center justify-center font-bold text-sm">
                            ${String.fromCharCode(65 + idx)}
                        </span>
                        <span class="text-sm">${op.texto}</span>
                    </label>
                `;
            });
            
            html += `
                    </div>
                    <button id="btn-responder" onclick="responderPreguntaAdaptativa()" 
                            class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold" disabled>
                        Verificar
                    </button>
                </div>
                <div id="feedback-duolingo" class="hidden mt-4"></div>
            `;
            
            document.getElementById('pregunta-container').innerHTML = html;
            document.getElementById('feedback-usuario').classList.add('hidden');
        }

        function seleccionarOpcionAdaptativa(label, idx) {
            document.querySelectorAll('#pregunta-container label').forEach(l => {
                l.classList.remove('bg-blue-100', 'border-blue-500');
                l.querySelector('span:first-child').classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            });
            label.classList.add('bg-blue-100', 'border-blue-500');
            label.querySelector('span:first-child').classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            document.getElementById('btn-responder').disabled = false;
            opcionSeleccionada = idx;
        }

        function responderPreguntaAdaptativa() {
            if (opcionSeleccionada === undefined || !preguntaActual) return;
            
            const inicio = Date.now();
            const esCorrecta = opcionSeleccionada === preguntaActual.correcta;
            const tiempoRespuesta = (Date.now() - inicio) / 1000;
            
            // Actualizar progreso
            progresoUsuario.estadisticas.totalPreguntas++;
            if (esCorrecta) {
                progresoUsuario.estadisticas.totalCorrectas++;
                progresoUsuario.nivel.xp += preguntaActual.xp;
                
                if (progresoUsuario.competencias[preguntaActual.competencia]) {
                    progresoUsuario.competencias[preguntaActual.competencia].xp += preguntaActual.xp;
                    progresoUsuario.competencias[preguntaActual.competencia].nivel = 
                        Math.floor(progresoUsuario.competencias[preguntaActual.competencia].xp / 100) + 1;
                }
            } else {
                progresoUsuario.estadisticas.totalIncorrectas++;
            }
            
            progresoUsuario.nivel.actual = Math.floor(progresoUsuario.nivel.xp / XP_POR_NIVEL) + 1;
            guardarProgreso();
            
            // Registrar en analytics
            analytics.registrarRespuesta(
                preguntaActual.id,
                preguntaActual.competencia,
                preguntaActual.nivel,
                esCorrecta,
                tiempoRespuesta
            );
            
            // Actualizar personalizador
            if (personalizador) {
                personalizador.actualizarConRespuesta(preguntaActual, esCorrecta, tiempoRespuesta);
            }
            
            // Mostrar feedback
            const feedback = document.getElementById('feedback-duolingo');
            const opcionElegida = preguntaActual.opciones[opcionSeleccionada];
            
            feedback.innerHTML = `
                <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 ${esCorrecta ? 'border-green-500' : 'border-red-500'}">
                    <h4 class="font-bold text-lg mb-2">${esCorrecta ? '‚úÖ Correcto' : '‚ùå Incorrecto'}</h4>
                    <div class="bg-${esCorrecta ? 'green' : 'red'}-50 p-4 rounded-lg">
                        <p>${esCorrecta ? preguntaActual.fundamento : 'Esta opci√≥n no es la correcta.'}</p>
                        ${!esCorrecta ? `
                            <p class="mt-2 font-medium">‚úÖ Respuesta correcta:</p>
                            <p>${preguntaActual.opciones[preguntaActual.correcta].texto}</p>
                        ` : ''}
                    </div>
                    <button onclick="siguientePreguntaAdaptativa()" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg">Continuar</button>
                </div>
            `;
            feedback.classList.remove('hidden');
            document.getElementById('btn-responder').disabled = true;
            
            // Mostrar panel de feedback de calidad
            document.getElementById('feedback-usuario').classList.remove('hidden');
            
            actualizarUIDuolingo();
            renderizarRuta();
        }

        function siguientePreguntaAdaptativa() {
            document.getElementById('feedback-duolingo').classList.add('hidden');
            document.getElementById('feedback-usuario').classList.add('hidden');
            cargarPreguntaAdaptativa();
        }

        // ============================================
        // REPORTAR CALIDAD DE PREGUNTA
        // ============================================
        function reportarCalidad(tipo) {
            if (!preguntaActual) return;
            
            analytics.registrarFeedback(preguntaActual.id, tipo);
            
            // Expandir banco si el feedback es positivo
            if (tipo === 'adecuada') {
                banco.expandirConFeedback({
                    competencia: preguntaActual.competencia,
                    tipo: tipo,
                    veces: 1,
                    situacion: preguntaActual.texto.split('\n')[0]
                });
            }
            
            alert('¬°Gracias por su feedback! Mejoramos con su ayuda.');
        }

        // ============================================
        // SIMULADOR ADAPTATIVO
        // ============================================
        function iniciarSimulador() {
            if (!generadorAdaptativo || documentos.length === 0) {
                alert('Cargue documentos primero');
                return;
            }
            
            const preguntas = [];
            const competencias = ['1.1', '1.2', '1.3', '2.1', '2.3'];
            
            for (let i = 0; i < 60; i++) {
                const comp = competencias[Math.floor(Math.random() * competencias.length)];
                const pregunta = generadorAdaptativo.generarPreguntaPersonalizada(comp);
                if (pregunta) preguntas.push(pregunta);
            }
            
            window.simuladorPreguntas = preguntas;
            window.simuladorIndex = 0;
            window.simuladorCorrectas = 0;
            
            document.getElementById('estado-simulacro').classList.remove('hidden');
            mostrarPreguntaSimulador(0);
        }

        function mostrarPreguntaSimulador(index) {
            if (index >= window.simuladorPreguntas.length) {
                finalizarSimulador();
                return;
            }
            
            const pregunta = window.simuladorPreguntas[index];
            
            let html = `
                <div class="pregunta-simulador">
                    <p class="text-sm text-gray-500 mb-2">Pregunta ${index+1} de 60</p>
                    <p class="text-lg font-medium mb-4">${pregunta.texto}</p>
                    <div class="space-y-3 mb-6">
            `;
            
            pregunta.opciones.forEach((op, idx) => {
                html += `
                    <label class="flex items-start gap-3 p-3 border rounded-lg hover:bg-blue-50 cursor-pointer"
                           onclick="seleccionarOpcionSimulador(this, ${idx}, ${index})">
                        <span class="w-6 h-6 rounded-full border-2 flex items-center justify-center font-bold">${String.fromCharCode(65 + idx)}</span>
                        <span>${op.texto}</span>
                    </label>
                `;
            });
            
            html += `
                    </div>
                    <button id="btn-simulador" onclick="responderSimulador(${index})" 
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold" disabled>
                        Responder
                    </button>
                </div>
            `;
            
            document.getElementById('simulacro-container').innerHTML = html;
        }

        function seleccionarOpcionSimulador(label, idx, index) {
            document.querySelectorAll('.pregunta-simulador label').forEach(l => {
                l.classList.remove('bg-blue-100', 'border-blue-500');
                l.querySelector('span:first-child').classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            });
            label.classList.add('bg-blue-100', 'border-blue-500');
            label.querySelector('span:first-child').classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            document.getElementById('btn-simulador').disabled = false;
            window.opcionSimuladorSeleccionada = { idx, index };
        }

        function responderSimulador(index) {
            if (!window.opcionSimuladorSeleccionada || window.opcionSimuladorSeleccionada.index !== index) return;
            
            const pregunta = window.simuladorPreguntas[index];
            const esCorrecta = window.opcionSimuladorSeleccionada.idx === pregunta.correcta;
            
            if (esCorrecta) window.simuladorCorrectas++;
            
            document.getElementById('simulacro-progreso').textContent = `${index+1}/60`;
            document.getElementById('simulacro-correctas').textContent = window.simuladorCorrectas;
            const nota = Math.round((window.simuladorCorrectas / (index+1)) * 100);
            document.getElementById('simulacro-nota').textContent = nota + '%';
            document.getElementById('simulacro-barra').style.width = ((index+1) / 60 * 100) + '%';
            
            setTimeout(() => {
                mostrarPreguntaSimulador(index + 1);
            }, 400);
        }

        function finalizarSimulador() {
            const porcentaje = (window.simuladorCorrectas / 60) * 100;
            const aprobado = porcentaje >= 70;
            
            progresoUsuario.estadisticas.simulacrosCompletados++;
            if (aprobado) progresoUsuario.estadisticas.simulacrosAprobados++;
            guardarProgreso();
            
            let reporte = `
                <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                    <h3 class="text-2xl font-bold mb-4 ${aprobado ? 'text-green-600' : 'text-red-600'}">
                        ${aprobado ? '‚úÖ APROBADO' : '‚ùå NO APROBADO'}
                    </h3>
                    <p>Resultado: ${window.simuladorCorrectas}/60 (${porcentaje.toFixed(1)}%)</p>
                    <button onclick="iniciarSimulador()" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg">
                        Nuevo simulacro
                    </button>
                </div>
            `;
            
            document.getElementById('resultado-simulador').innerHTML = reporte;
            document.getElementById('simulacro-container').innerHTML = '';
            document.getElementById('estado-simulacro').classList.add('hidden');
        }

        // ============================================
        // REPORTE DE COMPETENCIAS
        // ============================================
        function generarReporteCompetencias() {
            const container = document.getElementById('reporte-competencias');
            if (!container) return;
            
            let html = '';
            for (let [codigo, data] of Object.entries(progresoUsuario.competencias)) {
                const competencia = perfilesMEP[estratoActual]?.competencias.find(c => c.codigo === codigo);
                const nombre = competencia?.nombre || codigo;
                const porcentaje = data.nivel * 20;
                const colorBarra = porcentaje >= 80 ? 'bg-green-500' : (porcentaje >= 50 ? 'bg-yellow-500' : 'bg-red-500');
                
                html += `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-sm">${codigo} - ${nombre.substring(0, 30)}</span>
                            <span class="text-sm font-bold">${data.nivel}</span>
                        </div>
                        <div class="w-full bg-gray-200 h-4 rounded-full overflow-hidden">
                            <div class="${colorBarra} h-4 rounded-full" style="width: ${porcentaje}%"></div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
            
            // Gr√°fico radar
            const ctx = document.getElementById('radar-competencias').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['1.1', '1.2', '1.3', '2.1', '2.3'],
                    datasets: [{
                        label: 'Nivel de dominio',
                        data: [
                            progresoUsuario.competencias['1.1'].nivel * 20,
                            progresoUsuario.competencias['1.2'].nivel * 20,
                            progresoUsuario.competencias['1.3'].nivel * 20,
                            progresoUsuario.competencias['2.1'].nivel * 20,
                            progresoUsuario.competencias['2.3'].nivel * 20
                        ],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6'
                    }]
                },
                options: { scales: { r: { min: 0, max: 100 } } }
            });
            
            document.getElementById('estadisticas-globales').innerHTML = `
                <div class="p-3 bg-white rounded-lg shadow"><span class="text-sm text-gray-500">Total</span><p class="text-2xl font-bold">${progresoUsuario.estadisticas.totalPreguntas}</p></div>
                <div class="p-3 bg-white rounded-lg shadow"><span class="text-sm text-gray-500">Correctas</span><p class="text-2xl font-bold text-green-600">${progresoUsuario.estadisticas.totalCorrectas}</p></div>
                <div class="p-3 bg-white rounded-lg shadow"><span class="text-sm text-gray-500">Simulacros</span><p class="text-2xl font-bold">${progresoUsuario.estadisticas.simulacrosCompletados}</p></div>
                <div class="p-3 bg-white rounded-lg shadow"><span class="text-sm text-gray-500">Aprobados</span><p class="text-2xl font-bold text-blue-600">${progresoUsuario.estadisticas.simulacrosAprobados}</p></div>
            `;
        }

        // ============================================
        // PANEL DE ANALYTICS
        // ============================================
        function actualizarPanelAnalytics() {
            // M√©tricas generales
            const total = progresoUsuario.estadisticas.totalPreguntas || 1;
            const precision = Math.round(progresoUsuario.estadisticas.totalCorrectas / total * 100);
            document.getElementById('precision-general').textContent = precision + '%';
            
            const confianza = personalizador ? Math.round(personalizador.perfil.nivelConfianza * 100) : 50;
            document.getElementById('nivel-confianza').textContent = confianza + '%';
            
            document.getElementById('preguntas-reportadas').textContent = analytics.metricas.feedbackUsuarios.length;
            
            // Gr√°fico de dificultad
            const ctxDificultad = document.getElementById('grafico-dificultad').getContext('2d');
            new Chart(ctxDificultad, {
                type: 'doughnut',
                data: {
                    labels: ['F√°ciles', 'Medias', 'Dif√≠ciles'],
                    datasets: [{
                        data: [
                            Object.values(analytics.metricas.preguntas).filter(p => (p.correctas/p.total) > 0.7).length,
                            Object.values(analytics.metricas.preguntas).filter(p => (p.correctas/p.total) >= 0.4 && (p.correctas/p.total) <= 0.7).length,
                            Object.values(analytics.metricas.preguntas).filter(p => (p.correctas/p.total) < 0.4).length
                        ],
                        backgroundColor: ['#4ade80', '#facc15', '#f87171']
                    }]
                }
            });
            
            // Gr√°fico de rendimiento por nivel
            const ctxRendimiento = document.getElementById('grafico-rendimiento').getContext('2d');
            new Chart(ctxRendimiento, {
                type: 'bar',
                data: {
                    labels: ['Conceptual', 'Aplicado', 'Normativo'],
                    datasets: [{
                        label: '% aciertos',
                        data: [
                            analytics.metricas.niveles.conceptual.total > 0 ? 
                                (analytics.metricas.niveles.conceptual.correctas / analytics.metricas.niveles.conceptual.total * 100) : 0,
                            analytics.metricas.niveles.aplicado.total > 0 ? 
                                (analytics.metricas.niveles.aplicado.correctas / analytics.metricas.niveles.aplicado.total * 100) : 0,
                            analytics.metricas.niveles.normativo.total > 0 ? 
                                (analytics.metricas.niveles.normativo.correctas / analytics.metricas.niveles.normativo.total * 100) : 0
                        ],
                        backgroundColor: '#60a5fa'
                    }]
                }
            });
            
            // Recomendaciones
            const recoms = analytics.obtenerRecomendaciones(progresoUsuario);
            if (personalizador) {
                recoms.push(...personalizador.obtenerRecomendacionPersonalizada());
            }
            
            document.getElementById('recomendaciones-container').innerHTML = recoms.map(r => 
                `<div class="p-2 bg-white rounded shadow-sm">${r}</div>`
            ).join('');
            
            // Banco mejorado
            const mejoradas = Object.entries(analytics.metricas.preguntasMejoradas)
                .slice(0, 5)
                .map(([id, data]) => `<div class="text-xs p-2 bg-green-50 rounded">‚úÖ Pregunta mejorada (${data.vecesMejorada} veces)</div>`)
                .join('');
            
            document.getElementById('banco-mejorado').innerHTML = mejoradas || '<p class="text-sm text-gray-500">A√∫n no hay preguntas mejoradas</p>';
        }

        // ============================================
        // EVENTOS DE INICIALIZACI√ìN
        // ============================================
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${this.dataset.tab}`).classList.remove('hidden');
                
                if (this.dataset.tab === 'reporte') {
                    generarReporteCompetencias();
                }
                if (this.dataset.tab === 'analytics') {
                    actualizarPanelAnalytics();
                }
            });
        });

        document.querySelectorAll('#selector-estrato .estrato-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#selector-estrato .estrato-btn').forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-slate-100');
                });
                this.classList.remove('bg-slate-100');
                this.classList.add('bg-blue-600', 'text-white');
                estratoActual = this.dataset.estrato;
                renderizarCompetencias();
            });
        });

        document.getElementById('carga-docs').addEventListener('change', async function(e) {
            const archivos = Array.from(e.target.files);
            documentos = [];
            const listaDiv = document.getElementById('lista-docs');
            const progresoDiv = document.getElementById('progreso-carga');
            listaDiv.innerHTML = '';
            
            for (let i = 0; i < archivos.length; i++) {
                const archivo = archivos[i];
                progresoDiv.innerHTML = `Procesando ${i+1}/${archivos.length}: ${archivo.name}...`;
                const resultado = await procesarArchivoUniversal(archivo);
                
                if (resultado.error) {
                    listaDiv.innerHTML += `<div class="py-1 text-xs text-red-600">‚ùå ${resultado.nombre}: ${resultado.mensaje}</div>`;
                } else {
                    documentos.push(resultado);
                    listaDiv.innerHTML += `<div class="py-1 text-xs text-green-600">‚úÖ ${resultado.nombre}</div>`;
                }
            }
            
            // Inicializar sistemas
            personalizador = new Personalizador(progresoUsuario, analytics);
            generadorAdaptativo = new GeneradorAdaptativo(documentos, analytics, banco, personalizador);
            
            listaDiv.classList.remove('hidden');
            progresoDiv.innerHTML = `‚úÖ ${documentos.length} documentos listos. Sistema adaptativo activado.`;
        });

        document.getElementById('btn-iniciar-simulacro').addEventListener('click', iniciarSimulador);
        setInterval(guardarProgreso, 30000);
        window.addEventListener('beforeunload', guardarProgreso);

        // Inicializar
        renderizarCompetencias();
        renderizarRuta();
        actualizarUIDuolingo();
    </script>
</body>
</html>
